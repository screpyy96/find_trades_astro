---
// Analytics component for Astro
// Loads GTM and Clarity scripts

const GTM_ID = import.meta.env.PUBLIC_GTM_ID;
const CLARITY_ID = import.meta.env.PUBLIC_CLARITY_ID;
---

{import.meta.env.PROD && (GTM_ID || CLARITY_ID) && (
  <script is:inline define:vars={{ GTM_ID, CLARITY_ID }}>
    const isAnalyticsConsentGranted = () => {
      try {
        const analyticsConsent = localStorage.getItem('analytics-consent');
        const cookieConsent = localStorage.getItem('cookie-consent');
        return analyticsConsent === 'true' || cookieConsent === 'true';
      } catch {
        return false;
      }
    };

    const loadGtmOnce = () => {
      if (!GTM_ID) return;
      if (window.__gtmLoaded) return;
      window.__gtmLoaded = true;

      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });

      const s = document.createElement('script');
      s.async = true;
      s.src = `https://www.googletagmanager.com/gtm.js?id=${GTM_ID}`;
      document.head.appendChild(s);
    };

    const loadClarityOnce = () => {
      if (!CLARITY_ID) return;
      if (window.__clarityLoaded) return;
      window.__clarityLoaded = true;

      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", CLARITY_ID);
    };

    const loadAnalyticsIfAllowed = () => {
      if (!isAnalyticsConsentGranted()) return;
      loadGtmOnce();
      loadClarityOnce();
    };

    loadAnalyticsIfAllowed();
    window.addEventListener('cookie-consent-granted', loadAnalyticsIfAllowed, { once: true });
    document.addEventListener('astro:page-load', loadAnalyticsIfAllowed);
  </script>
)}
