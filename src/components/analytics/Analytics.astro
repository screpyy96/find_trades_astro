---
// Analytics component for Astro
// Loads GTM and Clarity scripts

const GTM_ID = import.meta.env.PUBLIC_GTM_ID;
const CLARITY_ID = import.meta.env.PUBLIC_CLARITY_ID;
const isProd = import.meta.env.PROD;

// Debug: log values at build time
console.log('Analytics build - GTM_ID:', GTM_ID ? 'SET' : 'NOT SET', 'PROD:', isProd);
---

{(GTM_ID || CLARITY_ID) && (
  <script is:inline define:vars={{ GTM_ID, CLARITY_ID }}>
    console.log('Analytics script loaded, GTM_ID:', GTM_ID ? 'present' : 'missing');
    
    const isAnalyticsConsentGranted = () => {
      try {
        const analyticsConsent = localStorage.getItem('analytics-consent');
        const cookieConsent = localStorage.getItem('cookie-consent');
        const granted = analyticsConsent === 'true' || cookieConsent === 'true';
        console.log('Consent check:', { analyticsConsent, cookieConsent, granted });
        return granted;
      } catch {
        return false;
      }
    };

    const loadGtmOnce = () => {
      if (!GTM_ID) {
        console.log('GTM: No ID provided');
        return;
      }
      if (window.__gtmLoaded) {
        console.log('GTM: Already loaded');
        return;
      }
      window.__gtmLoaded = true;
      console.log('GTM: Loading...', GTM_ID);

      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });

      const s = document.createElement('script');
      s.async = true;
      s.src = `https://www.googletagmanager.com/gtm.js?id=${GTM_ID}`;
      document.head.appendChild(s);
      console.log('GTM: Script added');
    };

    const loadClarityOnce = () => {
      if (!CLARITY_ID) return;
      if (window.__clarityLoaded) return;
      window.__clarityLoaded = true;

      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", CLARITY_ID);
    };

    const loadAnalyticsIfAllowed = () => {
      if (!isAnalyticsConsentGranted()) {
        console.log('Analytics: No consent, skipping');
        return;
      }
      console.log('Analytics: Consent granted, loading...');
      loadGtmOnce();
      loadClarityOnce();
    };

    loadAnalyticsIfAllowed();
    window.addEventListener('cookie-consent-granted', loadAnalyticsIfAllowed, { once: true });
    document.addEventListener('astro:page-load', loadAnalyticsIfAllowed);
  </script>
)}
