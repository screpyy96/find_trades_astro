---
export const prerender = false;

import Base from '../../layouts/Base.astro';
import { supabase } from '../../lib/supabase';
import { getWorkerProfileUrl } from '../../utils/seo-urls';
import { TradesmanProfile } from '../../components/tradesman/TradesmanProfile';
import { getPublicSupabaseConfig } from '../../lib/publicEnv';

const { slug } = Astro.params;
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

if (!slug) {
  return Astro.redirect('/meseriasi', 404);
}

// Check if it's a full UUID and redirect to SEO-friendly URL
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(slug);

if (isUuid) {
  if (!supabase) {
    return Astro.redirect('/meseriasi', 500);
  }

  // Fetch worker data for redirect
  const { data: worker, error: workerError } = await supabase
    .from('profiles')
    .select('id, name, address')
    .eq('id', slug)
    .eq('role', 'worker')
    .single();

  if (workerError || !worker) {
    return Astro.redirect('/meseriasi', 404);
  }

  // Fetch trades
  const { data: workerTrades } = await supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', worker.id)
    .single();

  const tradeIds = workerTrades?.trade_ids || [];
  let trades: any[] = [];
  
  if (tradeIds.length > 0) {
    const { data: tradeData } = await supabase
      .from('trades')
      .select('id, name, slug')
      .in('id', tradeIds);
    trades = tradeData || [];
  }

  const seoUrl = getWorkerProfileUrl(worker, trades);
  return Astro.redirect(seoUrl, 301);
}

if (!supabase) {
  return Astro.redirect('/meseriasi', 500);
}

// Extract short ID from slug (last 8 characters after last hyphen)
const slugParts = slug.split('-');
const shortId = slugParts[slugParts.length - 1];

console.log('Processing slug:', slug);
console.log('Extracted shortId:', shortId);

// Validate short ID (should be 8 hex characters)
const shortIdRegex = /^[0-9a-f]{8}$/i;
if (!shortIdRegex.test(shortId)) {
  console.log('Invalid shortId format, redirecting');
  return Astro.redirect('/meseriasi', 404);
}

// Find worker by matching last 8 characters of UUID
// We need to cast UUID to text for LIKE to work
const { data: workers, error: searchError } = await supabase
  .rpc('find_worker_by_short_id', { short_id: shortId });

// If RPC doesn't exist, fall back to fetching all workers and filtering in JS
let workerId: string | null = null;

if (searchError || !workers || workers.length === 0) {
  // Fallback: fetch all workers and filter client-side
  const { data: allWorkers } = await supabase
    .from('profiles')
    .select('id')
    .eq('role', 'worker');
  
  if (allWorkers) {
    const matchingWorker = allWorkers.find((w: any) => w.id.endsWith(shortId));
    if (matchingWorker) {
      workerId = matchingWorker.id;
    }
  }
  
  if (!workerId) {
    console.log('Worker not found, redirecting to /meseriasi');
    return Astro.redirect('/meseriasi', 404);
  }
} else {
  workerId = workers[0].id;
}

// Fetch all data in parallel for better performance
const [
  workerResult,
  workerTradesResult,
  portfolioResult,
  reviewsResult,
  certificationsResult,
  subscriptionResult
] = await Promise.all([
  // Worker data
  supabase
    .from('profiles')
    .select('*')
    .eq('role', 'worker')
    .eq('id', workerId)
    .single(),
  
  // Worker trades
  supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', workerId)
    .single(),
  
  // Portfolio items
  supabase
    .from('portfolio_items')
    .select('*')
    .eq('profile_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Reviews with client info
  supabase
    .from('reviews')
    .select(`
      *,
      profiles!reviews_client_id_fkey(
        id,
        name,
        avatar_url
      )
    `)
    .eq('worker_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Certifications
  supabase
    .from('certifications')
    .select('*')
    .eq('profile_id', workerId)
    .order('issue_date', { ascending: false }),
  
  // User subscription
  supabase
    .from('user_subscriptions')
    .select('plan_id, status')
    .eq('user_id', workerId)
    .eq('status', 'active')
    .single()
]);

const { data: worker, error } = workerResult;
if (error || !worker) {
  return Astro.redirect('/meseriasi', 404);
}

// Get trades data
const tradeIds = workerTradesResult.data?.trade_ids || [];
let trades: any[] = [];

if (tradeIds.length > 0) {
  const { data: tradeData } = await supabase
    .from('trades')
    .select('*')
    .in('id', tradeIds);
  trades = tradeData || [];
}

const portfolioItems = portfolioResult.data;
const originalReviews = reviewsResult.data;
const certifications = certificationsResult.data;
const subscriptionPlan = subscriptionResult.data?.plan_id || null;

// Generate fake reviews for workers with rating but no real reviews
function generateWorkerFakeReviews(rating: number, count: number) {
  const reviewTemplates: Record<number, string[]> = {
    5: [
      "Profesionist excepțional! A terminat lucrarea la timp și calitatea este excelentă.",
      "Super recomandat! Atent la detalii, munca de calitate, preț corect.",
      "Am rămas impresionat de profesionalismul și rapiditatea execuției.",
      "Calitate superioară, comunicare excelentă, respectat termenii.",
      "Expert în domeniul său, am să-l mai colaborez cu siguranță."
    ],
    4: [
      "Bun profesionist, a făcut treaba bine și la preț corect.",
      "Lucrare solidă, respectat termenul, recomand cu încredere.",
      "Serios și punctual, calitate bună, preț rezonabil.",
      "Mulțumit de colaborare, a executat conform planificării.",
      "Profesionist decent, a livrat ce a promis."
    ],
    3: [
      "Lucrare acceptabilă, a terminat ce a promis.",
      "Corect ca preț și calitate, a respectat termenul.",
      "Satisfăcător, ar putea fi mai atent la detalii.",
      "Ok pentru prețul plătit, a terminat lucrarea.",
      "Rezultat decent, fără probleme majore."
    ]
  };

  const names = [
    "Ion Popescu", "Maria Ionescu", "George Vasile", "Ana Marin", 
    "Alexandru Dumitru", "Elena Stan", "Radu Georgescu", "Cristina Diaconu",
    "Mihai Constantinescu", "Laura Petrescu", "Andrei Radu", "Gabriela Mihai"
  ];

  const fakeReviews = [];
  const templatesForRating = reviewTemplates[Math.round(rating)] || reviewTemplates[3];
  
  for (let i = 0; i < count; i++) {
    fakeReviews.push({
      id: `fake-${i + 1}`,
      profiles: {
        name: names[i % names.length],
        avatar_url: null
      },
      rating: rating,
      comment: templatesForRating[i % templatesForRating.length],
      created_at: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString(),
      job: null
    });
  }
  
  return fakeReviews;
}

// Use fake reviews if worker has rating but no real reviews
const reviews: any[] = worker.rating && worker.rating > 0 && (!originalReviews || originalReviews.length === 0)
  ? generateWorkerFakeReviews(worker.rating, Math.min(Math.max(3, Math.floor(worker.rating * 2)), 8))
  : originalReviews || [];

// Generate SEO data
const tradeNames = trades.map((trade: any) =>
  trade.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')
).join(', ');

const primaryTrade = trades[0]?.name ?
  trades[0].name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Servicii Profesionale';

const location = worker.address ?
  ` din ${worker.address.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')}` : '';

const workerName = worker.name ?
  worker.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Meseriaș';

const title = `${workerName} - ${primaryTrade}${location} | Meserias Local`;
const rating = worker.rating || 0;
const description = `${workerName}${location}: ${tradeNames}. ` +
  `${rating > 0 ? `★${rating.toFixed(1)} ` : ''}` +
  `Meseriaș verificat cu ${reviews?.length || 0} recenzii. Contactați pentru ofertă gratuită!`;

// Enhanced Open Graph meta tags
const ogImage = worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`;
const ogUrl = `https://www.meseriaslocal.ro/meseriasi/${slug}`;

// Canonical URL
const canonicalUrl = `https://www.meseriaslocal.ro/meseriasi/${slug}`;

// Avatar URL is handled in the component
// const avatarUrl = worker.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(worker.name || 'M')}&background=3B82F6&color=fff&size=400`;
---

<Base title={title} description={description} canonical={canonicalUrl} ogImage={ogImage}>
  <!-- Enhanced Schema.org structured data for worker profile -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": ["Person", "ProfessionalService"],
    "name": workerName,
    "jobTitle": primaryTrade,
    "description": worker.bio || `Specialist în ${tradeNames}`,
    "url": canonicalUrl,
    "image": worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`,
    "telephone": worker.phone,
    "address": worker.address ? {
      "@type": "PostalAddress",
      "addressLocality": location.replace(' din ', ''),
      "addressCountry": "RO"
    } : undefined,
    "geo": worker.coordinates ? {
      "@type": "GeoCoordinates",
      "latitude": worker.coordinates.lat,
      "longitude": worker.coordinates.lng
    } : undefined,
    "aggregateRating": rating > 0 ? {
      "@type": "AggregateRating",
      "ratingValue": rating,
      "ratingCount": reviews?.length || 0,
      "bestRating": 5,
      "worstRating": 1,
      "reviewCount": reviews?.length || 0
    } : undefined,
    "review": (reviews || []).slice(0, 5).map((review: any) => ({
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": review.profiles?.name || "Client Anonim"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": review.rating || 5
      },
      "reviewBody": review.comment || "",
      "datePublished": review.created_at
    })),
    "hasOccupation": {
      "@type": "Occupation",
      "name": primaryTrade,
      "occupationLocation": {
        "@type": "City",
        "name": location.replace(' din ', '') || "România"
      }
    },
    "knowsAbout": trades.map((trade: any) => trade.name),
    "worksFor": {
      "@type": "Organization",
      "name": "Meserias Local",
      "url": "https://www.meseriaslocal.ro"
    },
    "areaServed": location ? {
      "@type": "City",
      "name": location.replace(' din ', '')
    } : {
      "@type": "Country",
      "name": "România"
    },
    "availableChannel": {
      "@type": "ServiceChannel",
      "servicePhone": worker.phone,
      "serviceType": "Meserii profesionale"
    },
    "providerMobility": "Dynamic",
    "serviceType": tradeNames,
    "sameAs": [
      `https://www.meseriaslocal.ro/meseriasi/${slug}`
    ]
  })} />
  <TradesmanProfile 
    client:idle 
    worker={{
      ...worker,
      trades,
      portfolio_items: portfolioItems,
      reviews,
      certifications,
      subscription_plan: subscriptionPlan
    }}
    supabaseUrl={supabaseUrl}
    supabaseAnonKey={supabaseAnonKey}
  />
</Base>
