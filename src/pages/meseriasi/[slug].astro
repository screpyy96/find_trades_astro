---
export const prerender = false;

import Base from '../../layouts/Base.astro';
import { supabase } from '../../lib/supabase';
import { getWorkerProfileUrl } from '../../utils/seo-urls';
import { TradesmanProfile } from '../../components/tradesman/TradesmanProfile';
import { getPublicSupabaseConfig } from '../../lib/publicEnv';

const { slug } = Astro.params;
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

if (!slug) {
  return Astro.redirect('/meseriasi', 404);
}

// Check if it's a full UUID and redirect to SEO-friendly URL
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(slug);

if (isUuid) {
  if (!supabase) {
    return Astro.redirect('/meseriasi', 500);
  }

  // Fetch worker data for redirect
  const { data: worker, error: workerError } = await supabase
    .from('profiles')
    .select('id, name, address')
    .eq('id', slug)
    .eq('role', 'worker')
    .single();

  if (workerError || !worker) {
    return Astro.redirect('/meseriasi', 404);
  }

  // Fetch trades
  const { data: workerTrades } = await supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', worker.id)
    .single();

  const tradeIds = workerTrades?.trade_ids || [];
  let trades: any[] = [];
  
  if (tradeIds.length > 0) {
    const { data: tradeData } = await supabase
      .from('trades')
      .select('id, name, slug')
      .in('id', tradeIds);
    trades = tradeData || [];
  }

  const seoUrl = getWorkerProfileUrl(worker, trades);
  return Astro.redirect(seoUrl, 301);
}

if (!supabase) {
  return Astro.redirect('/meseriasi', 500);
}

// Extract short ID from slug (last 8 characters after last hyphen)
const slugParts = slug.split('-');
const shortId = slugParts[slugParts.length - 1];

console.log('Processing slug:', slug);
console.log('Extracted shortId:', shortId);

// Validate short ID (should be 8 hex characters)
const shortIdRegex = /^[0-9a-f]{8}$/i;
if (!shortIdRegex.test(shortId)) {
  console.log('Invalid shortId format, redirecting');
  return Astro.redirect('/meseriasi', 404);
}

// Find worker by matching last 8 characters of UUID
// We need to cast UUID to text for LIKE to work
const { data: workers, error: searchError } = await supabase
  .rpc('find_worker_by_short_id', { short_id: shortId });

// If RPC doesn't exist, fall back to fetching all workers and filtering in JS
let workerId: string | null = null;

if (searchError || !workers || workers.length === 0) {
  // Fallback: fetch all workers and filter client-side
  const { data: allWorkers } = await supabase
    .from('profiles')
    .select('id')
    .eq('role', 'worker');
  
  if (allWorkers) {
    const matchingWorker = allWorkers.find((w: any) => w.id.endsWith(shortId));
    if (matchingWorker) {
      workerId = matchingWorker.id;
    }
  }
  
  if (!workerId) {
    console.log('Worker not found, redirecting to /meseriasi');
    return Astro.redirect('/meseriasi', 404);
  }
} else {
  workerId = workers[0].id;
}

// Fetch all data in parallel for better performance
const [
  workerResult,
  workerTradesResult,
  portfolioResult,
  reviewsResult,
  certificationsResult,
  subscriptionResult
] = await Promise.all([
  // Worker data
  supabase
    .from('profiles')
    .select('*')
    .eq('role', 'worker')
    .eq('id', workerId)
    .single(),
  
  // Worker trades
  supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', workerId)
    .single(),
  
  // Portfolio items
  supabase
    .from('portfolio_items')
    .select('*')
    .eq('profile_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Reviews with client info
  supabase
    .from('reviews')
    .select(`
      *,
      profiles!reviews_client_id_fkey(
        id,
        name,
        avatar_url
      )
    `)
    .eq('worker_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Certifications
  supabase
    .from('certifications')
    .select('*')
    .eq('profile_id', workerId)
    .order('issue_date', { ascending: false }),
  
  // User subscription
  supabase
    .from('user_subscriptions')
    .select('plan_id, status')
    .eq('user_id', workerId)
    .eq('status', 'active')
    .single()
]);

const { data: worker, error } = workerResult;
if (error || !worker) {
  return Astro.redirect('/meseriasi', 404);
}

// Get trades data
const tradeIds = workerTradesResult.data?.trade_ids || [];
let trades: any[] = [];

if (tradeIds.length > 0) {
  const { data: tradeData } = await supabase
    .from('trades')
    .select('*')
    .in('id', tradeIds);
  trades = tradeData || [];
}

const portfolioItems = portfolioResult.data;
const originalReviews = reviewsResult.data;
const certifications = certificationsResult.data;
const subscriptionPlan = subscriptionResult.data?.plan_id || null;

// Generate fake reviews for workers with rating but no real reviews
function generateWorkerFakeReviews(rating: number, count: number) {
  const reviewTemplates: Record<number, string[]> = {
    5: [
      "Profesionist excepțional! A terminat lucrarea la timp și calitatea este excelentă. Comunicarea a fost foarte bună pe parcursul întregului proiect, a explicat fiecare etapă și a oferit sfaturi utile. Recomand cu încredere maximă!",
      "Super recomandat! Atent la detalii, munca de calitate, preț corect. Am fost plăcut surprins de seriozitatea și profesionalismul arătat. A respectat termenii stabilit și rezultatul final este peste așteptări. Cu siguranță voi apela din nou la serviciile sale.",
      "Am rămas impresionat de profesionalismul și rapiditatea execuției. A intervenit rapid pentru o urgență la instalația sanitară și a rezolvat problema eficient. Prețul a fost foarte corect raportat la calitatea lucrării. 10 stele!",
      "Calitate superioară, comunicare excelentă, respectat termenii. A renovat complet baia și rezultatul este spectaculos. A folosit materiale de calitate și a fost foarte atent la finisaje. A lăsat locul curat după terminarea lucrării.",
      "Expert în domeniul său, am să-l mai colaborez cu siguranță. A instalat centrala termică și tot sistemul de încălzire cu maximă seriozitate. A explicat funcționarea și a oferit garanție pentru lucrare. Profesionist desăvârșit!",
      "Lucrare executată impecabil, foarte mulțumit de rezultat. A schimbat tâmplăria din PVC din întreaga casă și a făcut o treabă perfectă. Montaj precis, etanșare bună, finisaje impecabile. Recomand fără rezerve!",
      "Seriozitate și profesionalism desăvârșite. Recomand cu tărie! A reparat acoperișul după furtună și a intervenit chiar și în weekend pentru a nu avea probleme cu ploaia. Om de cuvânt, respectă ce promite.",
      "Tehnician de excepție, a rezolvat rapid problema mea. A diagnosticat corect defecțiunea la aerul condiționat și a reparat-o în timp record. Preț corect, servicii impecabile. Mulțumesc!",
      "Preț corect pentru calitatea extraordinară a lucrării. A vopsit apartamentul și a făcut o treabă de calitate. A pregătit corect pereții, a aplicat multiple straturi și a lăsat totul curat. Recomand cu încredere!",
      "Punctualitate și atenție la detalii - servicii de 5 stele! A montat gresia și faianța în baie și rezultatul este superb. A respectat designul propus și a oferit soluții bune pentru spațiile dificile. Voi apela din nou!"
    ],
    4: [
      "Bun profesionist, a făcut treaba bine și la preț corect. A reparat robinetul care curgea și a rezolvat problema eficient. A fost punctual și a lăsat locul curat după terminarea lucrării. Recomand!",
      "Lucrare solidă, respectat termenul, recomand cu încredere. A schimbat ușa de la intrare și a făcut o treabă bună. Montaj corect, funcționează bine. Comunicarea a fost ok pe parcursul lucrării.",
      "Serios și punctual, calitate bună, preț rezonabil. A reparat scurgerea din bucătărie și a rezolvat problema. A fost rapid și eficient. Ar putea fi mai atent la curățenie după terminare, dar în rest ok.",
      "Mulțumit de colaborare, a executat conform planificării. A montat câteva corpuri de iluminat și a făcut treaba corect. A respectat programul stabilit și rezultatul este bun. Preț decent pentru serviciile oferite.",
      "Profesionist decent, a livrat ce a promis. A curățat sistemul de ventilație și a funcționat bine. A fost punctual și a respectat termenul. Comunicarea a fost pe măsură, rezultat mulțumitor.",
      "Lucrare de calitate, comunicare bună cu clientul. A reparat peretele crăpat și a făcut o treabă bună. A pregătit suprafața corect și finisajele arată bine. Recomand pentru lucrări de finisaje.",
      "A terminat la timp, rezultat conform așteptărilor. A schimbat întrerupătorul defect și a funcționat perfect. Lucrare simplă dar executată corect. Preț corect, servicii decente.",
      "Servicii bune, preț corect, recomand. A montat un raft în garaj și a făcut o treabă solidă. A fost rapid și eficient. Nu a fost ceva complex dar a executat cu seriozitate.",
      "Profesionist competent, ar putea fi mai rapid. A reparat instalația electrică și a rezolvat problema, dar a durat mai mult decât era programat. În calitate a fost ok, dar viteza de execuție ar putea fi îmbunătățită.",
      "Calitate satisfăcătoare, relaționare bună cu clientul. A vopsit o cameră și a făcut o treabă decentă. Comunicarea a fost bună, a ascultat cerințele. Preț rezonabil pentru calitatea oferită."
    ],
    3: [
      "Lucrare acceptabilă, a terminat ce a promis. A reparat panoul de la centrală și funcționează, dar a durat mai mult decât era prevăzut. Prețul a fost corect, dar timpul de execuție ar putea fi îmbunătățit.",
      "Corect ca preț și calitate, a respectat termenul. A schimbat o garnitură la chiuvetă și a rezolvat problema. Lucrare simplă, executată decent. Nu a fost ceva complex dar a făcut treaba corectă.",
      "Satisfăcător, ar putea fi mai atent la detalii. A montat câteva polițe și le-a fixat, dar nu au fost perfect aliniate. Funcțional sunt ok, dar finisajele ar putea fi mai bune. Preț pe măsură.",
      "Ok pentru prețul plătit, a terminat lucrarea. A curățat jgheabul și a rezolvat problema de înfundare. A fost eficient dar nu a lăsat locul perfect curat după. Rezultat acceptabil.",
      "Rezultat decent, fără probleme majore. A reparat un cablu electric și funcționează, dar izolația ar putea fi mai bine făcută. Sigur, funcționează, dar aspectul lasă de dorit. Preț corect.",
      "Lucrare standard, nimic excepțional dar corectă. A înlocuit un bec cu probleme și a funcționat. Lucrare simplă, executată fără probleme. Nu au fost complicații, dar nici ceva deosebit.",
      "Preț pe măsură, calitate medie, a respectat termenul. A reparat robinetul care picura și a rezolvat, dar după câteva săptămâni a început să picure din nou. Ok pentru reparație temporară.",
      "Acceptabil, au fost mici întârzieri dar a terminat. A montat un suport pentru TV și a făcut treaba, dar a întârziat cu o oră. Rezultatul e funcțional, dar planificarea ar putea fi mai bună.",
      "Servicii decente, se putea mai bine la curățenie. A schimbat filtrul la aerul condiționat și a funcționat, dar a lăsat mizerie în jur. Tehnic ok, dar curățenia lasă de dorit după terminare.",
      "Rezultat mulțumitor, comunicare ok. A reparat întrerupătorul și funcționează corect. A fost politicos și a explicat ce face. Lucrare standard fără probleme, preț decent pentru serviciile oferite."
    ]
  };

  const names = [
    "Ion Popescu", "Maria Ionescu", "George Vasile", "Ana Marin", 
    "Alexandru Dumitru", "Elena Stan", "Radu Georgescu", "Cristina Diaconu",
    "Mihai Constantinescu", "Laura Petrescu", "Andrei Radu", "Gabriela Mihai",
    "Stefan Enescu", "Diana Popa", "Florin Miron", "Roxana Badea"
  ];

  const fakeReviews = [];
  const templatesForRating = reviewTemplates[Math.round(rating)] || reviewTemplates[3];
  
  for (let i = 0; i < count; i++) {
    // Shuffle templates and names to ensure uniqueness
    const templateIndex = (i + Math.floor(Math.random() * templatesForRating.length)) % templatesForRating.length;
    const nameIndex = (i + Math.floor(Math.random() * names.length)) % names.length;
    
    // Vary the rating slightly for realism
    const reviewRating = rating === 5 ? 5 : rating === 4 ? (Math.random() > 0.3 ? 4 : 5) : (Math.random() > 0.5 ? 3 : 4);
    
    // Generate random date within last 90 days
    const daysAgo = Math.floor(Math.random() * 90) + 1;
    const reviewDate = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
    
    fakeReviews.push({
      id: `fake-${i + 1}`,
      profiles: {
        name: names[nameIndex],
        avatar_url: null
      },
      rating: reviewRating,
      comment: templatesForRating[templateIndex],
      created_at: reviewDate.toISOString(),
      job: null
    });
  }
  
  return fakeReviews;
}

// Use fake reviews if worker has rating but no real reviews
const reviews: any[] = worker.rating && worker.rating > 0 && (!originalReviews || originalReviews.length === 0)
  ? generateWorkerFakeReviews(worker.rating, Math.min(Math.max(3, Math.floor(worker.rating * 2)), 8))
  : originalReviews || [];

// Generate SEO data
const tradeNames = trades.map((trade: any) =>
  trade.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')
).join(', ');

const primaryTrade = trades[0]?.name ?
  trades[0].name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Servicii Profesionale';

const location = worker.address ?
  ` din ${worker.address.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')}` : '';

const workerName = worker.name ?
  worker.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Meseriaș';

const title = `${workerName} - ${primaryTrade}${location} | Meserias Local`;
const rating = worker.rating || 0;
const description = `${workerName}${location}: ${tradeNames}. ` +
  `${rating > 0 ? `★${rating.toFixed(1)} ` : ''}` +
  `Meseriaș verificat cu ${reviews?.length || 0} recenzii. Contactați pentru ofertă gratuită!`;

// Enhanced Open Graph meta tags
const ogImage = worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`;
const ogUrl = `https://www.meseriaslocal.ro/meseriasi/${slug}`;

// Canonical URL
const canonicalUrl = `https://www.meseriaslocal.ro/meseriasi/${slug}`;

// Avatar URL is handled in the component
// const avatarUrl = worker.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(worker.name || 'M')}&background=3B82F6&color=fff&size=400`;
---

<Base title={title} description={description} canonical={canonicalUrl} ogImage={ogImage}>
  <!-- Enhanced Schema.org structured data for worker profile -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": ["Person", "ProfessionalService"],
    "name": workerName,
    "jobTitle": primaryTrade,
    "description": worker.bio || `Specialist în ${tradeNames}`,
    "url": canonicalUrl,
    "image": worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`,
    "telephone": worker.phone,
    "address": worker.address ? {
      "@type": "PostalAddress",
      "addressLocality": location.replace(' din ', ''),
      "addressCountry": "RO"
    } : undefined,
    "geo": worker.coordinates ? {
      "@type": "GeoCoordinates",
      "latitude": worker.coordinates.lat,
      "longitude": worker.coordinates.lng
    } : undefined,
    "aggregateRating": rating > 0 ? {
      "@type": "AggregateRating",
      "ratingValue": rating,
      "ratingCount": reviews?.length || 0,
      "bestRating": 5,
      "worstRating": 1,
      "reviewCount": reviews?.length || 0
    } : undefined,
    "review": (reviews || []).slice(0, 5).map((review: any) => ({
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": review.profiles?.name || "Client Anonim"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": review.rating || 5
      },
      "reviewBody": review.comment || "",
      "datePublished": review.created_at
    })),
    "hasOccupation": {
      "@type": "Occupation",
      "name": primaryTrade,
      "occupationLocation": {
        "@type": "City",
        "name": location.replace(' din ', '') || "România"
      }
    },
    "knowsAbout": trades.map((trade: any) => trade.name),
    "worksFor": {
      "@type": "Organization",
      "name": "Meserias Local",
      "url": "https://www.meseriaslocal.ro"
    },
    "areaServed": location ? {
      "@type": "City",
      "name": location.replace(' din ', '')
    } : {
      "@type": "Country",
      "name": "România"
    },
    "availableChannel": {
      "@type": "ServiceChannel",
      "servicePhone": worker.phone,
      "serviceType": "Meserii profesionale"
    },
    "providerMobility": "Dynamic",
    "serviceType": tradeNames,
    "sameAs": [
      `https://www.meseriaslocal.ro/meseriasi/${slug}`
    ]
  })} />
  <TradesmanProfile 
    client:idle 
    worker={{
      ...worker,
      trades,
      portfolio_items: portfolioItems,
      reviews,
      certifications,
      subscription_plan: subscriptionPlan
    }}
    supabaseUrl={supabaseUrl}
    supabaseAnonKey={supabaseAnonKey}
  />
</Base>
