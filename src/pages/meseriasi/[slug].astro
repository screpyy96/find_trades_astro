---
export const prerender = false;

import Base from '../../layouts/Base.astro';
import { supabase } from '../../lib/supabase';
import { getWorkerProfileUrl } from '../../utils/seo-urls';
import { TradesmanProfile } from '../../components/tradesman/TradesmanProfile';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/meseriasi', 404);
}

// Check if it's a full UUID and redirect to SEO-friendly URL
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(slug);

if (isUuid) {
  if (!supabase) {
    return Astro.redirect('/meseriasi', 500);
  }

  // Fetch worker data for redirect
  const { data: worker, error: workerError } = await supabase
    .from('profiles')
    .select('id, name, address')
    .eq('id', slug)
    .eq('role', 'worker')
    .single();

  if (workerError || !worker) {
    return Astro.redirect('/meseriasi', 404);
  }

  // Fetch trades
  const { data: workerTrades } = await supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', worker.id)
    .single();

  const tradeIds = workerTrades?.trade_ids || [];
  let trades: any[] = [];
  
  if (tradeIds.length > 0) {
    const { data: tradeData } = await supabase
      .from('trades')
      .select('id, name, slug')
      .in('id', tradeIds);
    trades = tradeData || [];
  }

  const seoUrl = getWorkerProfileUrl(worker, trades);
  return Astro.redirect(seoUrl, 301);
}

if (!supabase) {
  return Astro.redirect('/meseriasi', 500);
}

// Extract short ID from slug (last 8 characters after last hyphen)
const slugParts = slug.split('-');
const shortId = slugParts[slugParts.length - 1];

// Validate short ID (should be 8 hex characters)
const shortIdRegex = /^[0-9a-f]{8}$/i;
if (!shortIdRegex.test(shortId)) {
  return Astro.redirect('/meseriasi', 404);
}

// Find worker by matching last 8 characters of UUID using LIKE query (much faster)
const { data: workers, error: searchError } = await supabase
  .from('profiles')
  .select('id')
  .eq('role', 'worker')
  .like('id', `%${shortId}`);

if (searchError || !workers || workers.length === 0) {
  return Astro.redirect('/meseriasi', 404);
}

const workerId = workers[0].id;

// Fetch all data in parallel for better performance
const [
  workerResult,
  workerTradesResult,
  portfolioResult,
  reviewsResult,
  certificationsResult
] = await Promise.all([
  // Worker data
  supabase
    .from('profiles')
    .select('*')
    .eq('role', 'worker')
    .eq('id', workerId)
    .single(),
  
  // Worker trades
  supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', workerId)
    .single(),
  
  // Portfolio items
  supabase
    .from('portfolio_items')
    .select('*')
    .eq('profile_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Reviews with client info
  supabase
    .from('reviews')
    .select(`
      *,
      profiles!reviews_client_id_fkey(
        id,
        name,
        avatar_url
      )
    `)
    .eq('worker_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Certifications
  supabase
    .from('certifications')
    .select('*')
    .eq('profile_id', workerId)
    .order('issue_date', { ascending: false })
]);

const { data: worker, error } = workerResult;
if (error || !worker) {
  return Astro.redirect('/meseriasi', 404);
}

// Get trades data
const tradeIds = workerTradesResult.data?.trade_ids || [];
let trades: any[] = [];

if (tradeIds.length > 0) {
  const { data: tradeData } = await supabase
    .from('trades')
    .select('*')
    .in('id', tradeIds);
  trades = tradeData || [];
}

const portfolioItems = portfolioResult.data;
const reviews = reviewsResult.data;
const certifications = certificationsResult.data;

// Generate SEO data
const tradeNames = trades.map((trade: any) =>
  trade.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')
).join(', ');

const primaryTrade = trades[0]?.name ?
  trades[0].name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Servicii Profesionale';

const location = worker.address ?
  ` din ${worker.address.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')}` : '';

const workerName = worker.name ?
  worker.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Meseriaș';

const title = `${workerName} - ${primaryTrade}${location} | Meserias Local`;
const rating = worker.rating || 0;
const description = `${workerName}${location}: ${tradeNames}. ` +
  `${rating > 0 ? `★${rating.toFixed(1)} ` : ''}` +
  `Contactați pentru ofertă gratuită!`;

const avatarUrl = worker.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(worker.name || 'M')}&background=3B82F6&color=fff&size=400`;
---

<Base title={title} description={description}>
  <TradesmanProfile client:idle worker={{
    ...worker,
    trades,
    portfolio_items: portfolioItems,
    reviews,
    certifications
  }} />
</Base>
