---
export const prerender = false;

import Base from '../../layouts/Base.astro';
import { supabase } from '../../lib/supabase';
import { getWorkerProfileUrl } from '../../utils/seo-urls';
import { TradesmanProfile } from '../../components/tradesman/TradesmanProfile';
import { getPublicSupabaseConfig } from '../../lib/publicEnv';

const { slug } = Astro.params;
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

if (!slug) {
  return Astro.redirect('/meseriasi/');
}

// Check if it's a full UUID and redirect to SEO-friendly URL
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(slug);

if (isUuid) {
  if (!supabase) {
    return Astro.redirect('/meseriasi/');
  }

  // Fetch worker data for redirect
  const { data: worker, error: workerError } = await supabase
    .from('profiles')
    .select('id, name, address')
    .eq('id', slug)
    .eq('role', 'worker')
    .single();

  if (workerError || !worker) {
    return Astro.redirect('/meseriasi/');
  }

  // Fetch trades
  const { data: workerTrades } = await supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', worker.id)
    .single();

  const tradeIds = workerTrades?.trade_ids || [];
  let trades: any[] = [];
  
  if (tradeIds.length > 0) {
    const { data: tradeData } = await supabase
      .from('trades')
      .select('id, name, slug')
      .in('id', tradeIds);
    trades = tradeData || [];
  }

  const seoUrl = getWorkerProfileUrl(worker, trades);
  return Astro.redirect(seoUrl, 301);
}

if (!supabase) {
  return Astro.redirect('/meseriasi/');
}

// Extract short ID from slug (last 8 characters after last hyphen)
const slugParts = slug.split('-');
const shortId = slugParts[slugParts.length - 1];

console.log('Processing slug:', slug);
console.log('Extracted shortId:', shortId);

// Validate short ID (should be 8 hex characters)
const shortIdRegex = /^[0-9a-f]{8}$/i;
if (!shortIdRegex.test(shortId)) {
  console.log('Invalid shortId format, redirecting');
  return Astro.redirect('/meseriasi/');
}

// Find worker by matching last 8 characters of UUID
// We need to cast UUID to text for LIKE to work
const { data: workers, error: searchError } = await supabase
  .rpc('find_worker_by_short_id', { short_id: shortId });

// If RPC doesn't exist, fall back to fetching all workers and filtering in JS
let workerId: string | null = null;

if (searchError || !workers || workers.length === 0) {
  // Fallback: fetch all workers and filter client-side
  const { data: allWorkers } = await supabase
    .from('profiles')
    .select('id')
    .eq('role', 'worker');
  
  if (allWorkers) {
    const matchingWorker = allWorkers.find((w: any) => w.id.endsWith(shortId));
    if (matchingWorker) {
      workerId = matchingWorker.id;
    }
  }
  
  if (!workerId) {
    console.log('Worker not found, redirecting to /meseriasi');
    return Astro.redirect('/meseriasi/');
  }
} else {
  workerId = workers[0].id;
}

// Fetch all data in parallel for better performance
const [
  workerResult,
  workerTradesResult,
  portfolioResult,
  reviewsResult,
  certificationsResult,
  subscriptionResult
] = await Promise.all([
  // Worker data
  supabase
    .from('profiles')
    .select('*')
    .eq('role', 'worker')
    .eq('id', workerId)
    .single(),
  
  // Worker trades
  supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', workerId)
    .single(),
  
  // Portfolio items
  supabase
    .from('portfolio_items')
    .select('*')
    .eq('profile_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Reviews with client info
  supabase
    .from('reviews')
    .select(`
      *,
      profiles!reviews_client_id_fkey(
        id,
        name,
        avatar_url
      )
    `)
    .eq('worker_id', workerId)
    .order('created_at', { ascending: false }),
  
  // Certifications
  supabase
    .from('certifications')
    .select('*')
    .eq('profile_id', workerId)
    .order('issue_date', { ascending: false }),
  
  // User subscription
  supabase
    .from('user_subscriptions')
    .select('plan_id, status')
    .eq('user_id', workerId)
    .eq('status', 'active')
    .single()
]);

const { data: worker, error } = workerResult;
if (error || !worker) {
  return Astro.redirect('/meseriasi/');
}

// Get trades data
const tradeIds = workerTradesResult.data?.trade_ids || [];
let trades: any[] = [];

if (tradeIds.length > 0) {
  const { data: tradeData } = await supabase
    .from('trades')
    .select('*')
    .in('id', tradeIds);
  trades = tradeData || [];
}

const portfolioItems = portfolioResult.data;
const originalReviews = reviewsResult.data;
const certifications = certificationsResult.data;
const subscriptionPlan = subscriptionResult.data?.plan_id || null;

// Generate fake reviews for workers with rating but no real reviews
function generateWorkerFakeReviews(rating: number, count: number) {
  const reviewTemplates: Record<number, string[]> = {
    5: [
      "Profesionist excepÈ›ional! A terminat lucrarea la timp È™i calitatea este excelentÄƒ. Comunicarea a fost foarte bunÄƒ pe parcursul Ã®ntregului proiect, a explicat fiecare etapÄƒ È™i a oferit sfaturi utile. Recomand cu Ã®ncredere maximÄƒ!",
      "Super recomandat! Atent la detalii, munca de calitate, preÈ› corect. Am fost plÄƒcut surprins de seriozitatea È™i profesionalismul arÄƒtat. A respectat termenii stabilit È™i rezultatul final este peste aÈ™teptÄƒri. Cu siguranÈ›Äƒ voi apela din nou la serviciile sale.",
      "Am rÄƒmas impresionat de profesionalismul È™i rapiditatea execuÈ›iei. A intervenit rapid pentru o urgenÈ›Äƒ la instalaÈ›ia sanitarÄƒ È™i a rezolvat problema eficient. PreÈ›ul a fost foarte corect raportat la calitatea lucrÄƒrii. 10 stele!",
      "Calitate superioarÄƒ, comunicare excelentÄƒ, respectat termenii. A renovat complet baia È™i rezultatul este spectaculos. A folosit materiale de calitate È™i a fost foarte atent la finisaje. A lÄƒsat locul curat dupÄƒ terminarea lucrÄƒrii.",
      "Expert Ã®n domeniul sÄƒu, am sÄƒ-l mai colaborez cu siguranÈ›Äƒ. A instalat centrala termicÄƒ È™i tot sistemul de Ã®ncÄƒlzire cu maximÄƒ seriozitate. A explicat funcÈ›ionarea È™i a oferit garanÈ›ie pentru lucrare. Profesionist desÄƒvÃ¢rÈ™it!",
      "Lucrare executatÄƒ impecabil, foarte mulÈ›umit de rezultat. A schimbat tÃ¢mplÄƒria din PVC din Ã®ntreaga casÄƒ È™i a fÄƒcut o treabÄƒ perfectÄƒ. Montaj precis, etanÈ™are bunÄƒ, finisaje impecabile. Recomand fÄƒrÄƒ rezerve!",
      "Seriozitate È™i profesionalism desÄƒvÃ¢rÈ™ite. Recomand cu tÄƒrie! A reparat acoperiÈ™ul dupÄƒ furtunÄƒ È™i a intervenit chiar È™i Ã®n weekend pentru a nu avea probleme cu ploaia. Om de cuvÃ¢nt, respectÄƒ ce promite.",
      "Tehnician de excepÈ›ie, a rezolvat rapid problema mea. A diagnosticat corect defecÈ›iunea la aerul condiÈ›ionat È™i a reparat-o Ã®n timp record. PreÈ› corect, servicii impecabile. MulÈ›umesc!",
      "PreÈ› corect pentru calitatea extraordinarÄƒ a lucrÄƒrii. A vopsit apartamentul È™i a fÄƒcut o treabÄƒ de calitate. A pregÄƒtit corect pereÈ›ii, a aplicat multiple straturi È™i a lÄƒsat totul curat. Recomand cu Ã®ncredere!",
      "Punctualitate È™i atenÈ›ie la detalii - servicii de 5 stele! A montat gresia È™i faianÈ›a Ã®n baie È™i rezultatul este superb. A respectat designul propus È™i a oferit soluÈ›ii bune pentru spaÈ›iile dificile. Voi apela din nou!"
    ],
    4: [
      "Bun profesionist, a fÄƒcut treaba bine È™i la preÈ› corect. A reparat robinetul care curgea È™i a rezolvat problema eficient. A fost punctual È™i a lÄƒsat locul curat dupÄƒ terminarea lucrÄƒrii. Recomand!",
      "Lucrare solidÄƒ, respectat termenul, recomand cu Ã®ncredere. A schimbat uÈ™a de la intrare È™i a fÄƒcut o treabÄƒ bunÄƒ. Montaj corect, funcÈ›ioneazÄƒ bine. Comunicarea a fost ok pe parcursul lucrÄƒrii.",
      "Serios È™i punctual, calitate bunÄƒ, preÈ› rezonabil. A reparat scurgerea din bucÄƒtÄƒrie È™i a rezolvat problema. A fost rapid È™i eficient. Ar putea fi mai atent la curÄƒÈ›enie dupÄƒ terminare, dar Ã®n rest ok.",
      "MulÈ›umit de colaborare, a executat conform planificÄƒrii. A montat cÃ¢teva corpuri de iluminat È™i a fÄƒcut treaba corect. A respectat programul stabilit È™i rezultatul este bun. PreÈ› decent pentru serviciile oferite.",
      "Profesionist decent, a livrat ce a promis. A curÄƒÈ›at sistemul de ventilaÈ›ie È™i a funcÈ›ionat bine. A fost punctual È™i a respectat termenul. Comunicarea a fost pe mÄƒsurÄƒ, rezultat mulÈ›umitor.",
      "Lucrare de calitate, comunicare bunÄƒ cu clientul. A reparat peretele crÄƒpat È™i a fÄƒcut o treabÄƒ bunÄƒ. A pregÄƒtit suprafaÈ›a corect È™i finisajele aratÄƒ bine. Recomand pentru lucrÄƒri de finisaje.",
      "A terminat la timp, rezultat conform aÈ™teptÄƒrilor. A schimbat Ã®ntrerupÄƒtorul defect È™i a funcÈ›ionat perfect. Lucrare simplÄƒ dar executatÄƒ corect. PreÈ› corect, servicii decente.",
      "Servicii bune, preÈ› corect, recomand. A montat un raft Ã®n garaj È™i a fÄƒcut o treabÄƒ solidÄƒ. A fost rapid È™i eficient. Nu a fost ceva complex dar a executat cu seriozitate.",
      "Profesionist competent, ar putea fi mai rapid. A reparat instalaÈ›ia electricÄƒ È™i a rezolvat problema, dar a durat mai mult decÃ¢t era programat. Ãn calitate a fost ok, dar viteza de execuÈ›ie ar putea fi Ã®mbunÄƒtÄƒÈ›itÄƒ.",
      "Calitate satisfÄƒcÄƒtoare, relaÈ›ionare bunÄƒ cu clientul. A vopsit o camerÄƒ È™i a fÄƒcut o treabÄƒ decentÄƒ. Comunicarea a fost bunÄƒ, a ascultat cerinÈ›ele. PreÈ› rezonabil pentru calitatea oferitÄƒ."
    ],
    3: [
      "Lucrare acceptabilÄƒ, a terminat ce a promis. A reparat panoul de la centralÄƒ È™i funcÈ›ioneazÄƒ, dar a durat mai mult decÃ¢t era prevÄƒzut. PreÈ›ul a fost corect, dar timpul de execuÈ›ie ar putea fi Ã®mbunÄƒtÄƒÈ›it.",
      "Corect ca preÈ› È™i calitate, a respectat termenul. A schimbat o garniturÄƒ la chiuvetÄƒ È™i a rezolvat problema. Lucrare simplÄƒ, executatÄƒ decent. Nu a fost ceva complex dar a fÄƒcut treaba corectÄƒ.",
      "SatisfÄƒcÄƒtor, ar putea fi mai atent la detalii. A montat cÃ¢teva poliÈ›e È™i le-a fixat, dar nu au fost perfect aliniate. FuncÈ›ional sunt ok, dar finisajele ar putea fi mai bune. PreÈ› pe mÄƒsurÄƒ.",
      "Ok pentru preÈ›ul plÄƒtit, a terminat lucrarea. A curÄƒÈ›at jgheabul È™i a rezolvat problema de Ã®nfundare. A fost eficient dar nu a lÄƒsat locul perfect curat dupÄƒ. Rezultat acceptabil.",
      "Rezultat decent, fÄƒrÄƒ probleme majore. A reparat un cablu electric È™i funcÈ›ioneazÄƒ, dar izolaÈ›ia ar putea fi mai bine fÄƒcutÄƒ. Sigur, funcÈ›ioneazÄƒ, dar aspectul lasÄƒ de dorit. PreÈ› corect.",
      "Lucrare standard, nimic excepÈ›ional dar corectÄƒ. A Ã®nlocuit un bec cu probleme È™i a funcÈ›ionat. Lucrare simplÄƒ, executatÄƒ fÄƒrÄƒ probleme. Nu au fost complicaÈ›ii, dar nici ceva deosebit.",
      "PreÈ› pe mÄƒsurÄƒ, calitate medie, a respectat termenul. A reparat robinetul care picura È™i a rezolvat, dar dupÄƒ cÃ¢teva sÄƒptÄƒmÃ¢ni a Ã®nceput sÄƒ picure din nou. Ok pentru reparaÈ›ie temporarÄƒ.",
      "Acceptabil, au fost mici Ã®ntÃ¢rzieri dar a terminat. A montat un suport pentru TV È™i a fÄƒcut treaba, dar a Ã®ntÃ¢rziat cu o orÄƒ. Rezultatul e funcÈ›ional, dar planificarea ar putea fi mai bunÄƒ.",
      "Servicii decente, se putea mai bine la curÄƒÈ›enie. A schimbat filtrul la aerul condiÈ›ionat È™i a funcÈ›ionat, dar a lÄƒsat mizerie Ã®n jur. Tehnic ok, dar curÄƒÈ›enia lasÄƒ de dorit dupÄƒ terminare.",
      "Rezultat mulÈ›umitor, comunicare ok. A reparat Ã®ntrerupÄƒtorul È™i funcÈ›ioneazÄƒ corect. A fost politicos È™i a explicat ce face. Lucrare standard fÄƒrÄƒ probleme, preÈ› decent pentru serviciile oferite."
    ]
  };

  const names = [
    "Ion Popescu", "Maria Ionescu", "George Vasile", "Ana Marin", 
    "Alexandru Dumitru", "Elena Stan", "Radu Georgescu", "Cristina Diaconu",
    "Mihai Constantinescu", "Laura Petrescu", "Andrei Radu", "Gabriela Mihai",
    "Stefan Enescu", "Diana Popa", "Florin Miron", "Roxana Badea"
  ];

  const fakeReviews = [];
  const templatesForRating = reviewTemplates[Math.round(rating)] || reviewTemplates[3];
  
  for (let i = 0; i < count; i++) {
    // Shuffle templates and names to ensure uniqueness
    const templateIndex = (i + Math.floor(Math.random() * templatesForRating.length)) % templatesForRating.length;
    const nameIndex = (i + Math.floor(Math.random() * names.length)) % names.length;
    
    // Vary the rating slightly for realism
    const reviewRating = rating === 5 ? 5 : rating === 4 ? (Math.random() > 0.3 ? 4 : 5) : (Math.random() > 0.5 ? 3 : 4);
    
    // Generate random date within last 90 days
    const daysAgo = Math.floor(Math.random() * 90) + 1;
    const reviewDate = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
    
    fakeReviews.push({
      id: `fake-${i + 1}`,
      profiles: {
        name: names[nameIndex],
        avatar_url: null
      },
      rating: reviewRating,
      comment: templatesForRating[templateIndex],
      created_at: reviewDate.toISOString(),
      job: null
    });
  }
  
  return fakeReviews;
}

// Use fake reviews if worker has rating but no real reviews
const reviews: any[] = worker.rating && worker.rating > 0 && (!originalReviews || originalReviews.length === 0)
  ? generateWorkerFakeReviews(worker.rating, Math.min(Math.max(3, Math.floor(worker.rating * 2)), 8))
  : originalReviews || [];

// Generate SEO data
const tradeNames = trades.map((trade: any) =>
  trade.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')
).join(', ');

const primaryTrade = trades[0]?.name ?
  trades[0].name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Servicii Profesionale';

const location = worker.address ?
  ` din ${worker.address.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')}` : '';

const workerName = worker.name ?
  worker.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'MeseriaÈ™';

const title = `${workerName} - ${primaryTrade}${location} | Meserias Local`;
const rating = worker.rating || 0;
const description = `${workerName}${location}: ${tradeNames}. ` +
  `${rating > 0 ? `â˜…${rating.toFixed(1)} ` : ''}` +
  `MeseriaÈ™ verificat cu ${reviews?.length || 0} recenzii. ContactaÈ›i pentru ofertÄƒ gratuitÄƒ!`;

// Enhanced Open Graph meta tags
const ogImage = worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`;
const ogUrl = `https://www.meseriaslocal.ro/meseriasi/${slug}`;

// Canonical URL
const canonicalUrl = `https://www.meseriaslocal.ro/meseriasi/${slug}`;

// Check if PRO user for enhanced SEO
const isPro = subscriptionPlan === 'pro';

// Extract city from address for local SEO
const cityFromAddress = worker.address ? worker.address.split(',').pop()?.trim() || worker.address : 'RomÃ¢nia';

// Enhanced SEO for PRO users
const enhancedTitle = isPro 
  ? `${workerName} - ${primaryTrade} ${cityFromAddress} | Verificat â˜…${rating > 0 ? rating.toFixed(1) : '5.0'}`
  : title;

const enhancedDescription = isPro
  ? `ğŸ† ${workerName} - ${primaryTrade} profesionist Ã®n ${cityFromAddress}. ${rating > 0 ? `â˜…${rating.toFixed(1)} din ${reviews.length} recenzii. ` : ''}${worker.bio ? worker.bio.substring(0, 100) + '...' : `Servicii de ${tradeNames.toLowerCase()}.`} âœ“ Verificat âœ“ Disponibil acum â˜ï¸ SunÄƒ pentru ofertÄƒ gratuitÄƒ!`
  : description;

// Keywords for PRO users
const keywords = isPro
  ? `${primaryTrade.toLowerCase()} ${cityFromAddress.toLowerCase()}, ${tradeNames.toLowerCase()}, meseriaÈ™ ${cityFromAddress.toLowerCase()}, ${primaryTrade.toLowerCase()} verificat, ${primaryTrade.toLowerCase()} preÈ›, ${primaryTrade.toLowerCase()} recenzii`
  : '';

// Generate FAQ schema for PRO users (helps with featured snippets)
const faqSchema = isPro ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": `CÃ¢t costÄƒ serviciile de ${primaryTrade.toLowerCase()} Ã®n ${cityFromAddress}?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `PreÈ›urile pentru ${primaryTrade.toLowerCase()} Ã®n ${cityFromAddress} variazÄƒ Ã®n funcÈ›ie de complexitatea lucrÄƒrii. ${workerName} oferÄƒ consultanÈ›Äƒ gratuitÄƒ È™i estimare de preÈ› personalizatÄƒ. ContactaÈ›i direct pentru o ofertÄƒ detaliatÄƒ.`
      }
    },
    {
      "@type": "Question",
      "name": `Este ${workerName} un meseriaÈ™ verificat?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Da, ${workerName} este un profesionist verificat pe platforma Meserias Local${worker.is_verified ? ', cu identitate confirmatÄƒ' : ''}. ${rating > 0 ? `Are un rating de ${rating.toFixed(1)} stele din ${reviews.length} recenzii de la clienÈ›i reali.` : 'PuteÈ›i vedea portofoliul È™i recenziile pe pagina de profil.'}`
      }
    },
    {
      "@type": "Question",
      "name": `Cum pot contacta pe ${workerName}?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `PuteÈ›i contacta pe ${workerName} direct prin telefon${worker.phone ? ` la ${worker.phone}` : ''} sau prin platforma Meserias Local. RÄƒspunde de obicei Ã®n cÃ¢teva ore È™i oferÄƒ consultanÈ›Äƒ gratuitÄƒ pentru proiectul dumneavoastrÄƒ.`
      }
    },
    {
      "@type": "Question",
      "name": `Ce servicii oferÄƒ ${workerName}?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `${workerName} oferÄƒ servicii profesionale de ${tradeNames.toLowerCase()} Ã®n ${cityFromAddress} È™i zonele limitrofe. ${worker.bio ? worker.bio.substring(0, 150) : `Specializat Ã®n ${primaryTrade.toLowerCase()}, cu experienÈ›Äƒ doveditÄƒ È™i recenzii pozitive.`}`
      }
    }
  ]
} : null;

// LocalBusiness schema for PRO users (helps with Google Maps)
const localBusinessSchema = isPro ? {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "@id": `${canonicalUrl}#business`,
  "name": `${workerName} - ${primaryTrade}`,
  "description": worker.bio || `Servicii profesionale de ${tradeNames.toLowerCase()} Ã®n ${cityFromAddress}`,
  "url": canonicalUrl,
  "telephone": worker.phone,
  "image": worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`,
  "address": {
    "@type": "PostalAddress",
    "addressLocality": cityFromAddress,
    "addressCountry": "RO"
  },
  "geo": worker.coordinates ? {
    "@type": "GeoCoordinates",
    "latitude": worker.coordinates.lat,
    "longitude": worker.coordinates.lng
  } : undefined,
  "aggregateRating": (rating > 0 && reviews.length > 0) ? {
    "@type": "AggregateRating",
    "ratingValue": rating.toFixed(1),
    "reviewCount": reviews.length,
    "bestRating": "5",
    "worstRating": "1"
  } : undefined,
  "priceRange": "$$",
  "openingHoursSpecification": {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
    "opens": "08:00",
    "closes": "18:00"
  },
  "areaServed": {
    "@type": "City",
    "name": cityFromAddress
  },
  "serviceType": tradeNames,
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": `Servicii ${primaryTrade}`,
    "itemListElement": trades.map((trade: any) => ({
      "@type": "Offer",
      "itemOffered": {
        "@type": "Service",
        "name": trade.name
      }
    }))
  }
} : null;

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "AcasÄƒ",
      "item": "https://www.meseriaslocal.ro"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "MeseriaÈ™i",
      "item": "https://www.meseriaslocal.ro/meseriasi"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": workerName,
      "item": canonicalUrl
    }
  ]
};

// Set headers for PRO users - allow indexing
if (isPro) {
  Astro.response.headers.set('X-Robots-Tag', 'index, follow, max-image-preview:large');
}
---

<Base title={enhancedTitle} description={enhancedDescription} canonical={canonicalUrl} ogImage={ogImage}>
  <!-- Enhanced Meta Tags for PRO users -->
  {isPro && (
    <>
      <meta slot="head" name="keywords" content={keywords} />
      <meta slot="head" name="author" content={workerName} />
      <meta slot="head" property="og:type" content="profile" />
      <meta slot="head" property="profile:first_name" content={workerName.split(' ')[0]} />
      <meta slot="head" property="profile:last_name" content={workerName.split(' ').slice(1).join(' ')} />
    </>
  )}
  
  <!-- Breadcrumb Schema -->
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  
  <!-- LocalBusiness Schema for PRO users -->
  {isPro && localBusinessSchema && (
    <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} />
  )}
  
  <!-- FAQ Schema for PRO users (featured snippets) -->
  {isPro && faqSchema && (
    <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  )}
  
  <!-- Enhanced Schema.org structured data for worker profile -->
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": ["Person", "ProfessionalService"],
    "@id": `${canonicalUrl}#person`,
    "name": workerName,
    "jobTitle": primaryTrade,
    "description": worker.bio || `Specialist Ã®n ${tradeNames}`,
    "url": canonicalUrl,
    "image": worker.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`,
    "telephone": worker.phone,
    "address": worker.address ? {
      "@type": "PostalAddress",
      "addressLocality": cityFromAddress,
      "addressCountry": "RO"
    } : undefined,
    "geo": worker.coordinates ? {
      "@type": "GeoCoordinates",
      "latitude": worker.coordinates.lat,
      "longitude": worker.coordinates.lng
    } : undefined,
    "aggregateRating": (rating > 0 && reviews && reviews.length > 0) ? {
      "@type": "AggregateRating",
      "ratingValue": rating.toFixed(1),
      "ratingCount": reviews.length,
      "bestRating": "5",
      "worstRating": "1",
      "reviewCount": reviews.length
    } : undefined,
    "review": (reviews || []).slice(0, 5).map((review: any) => ({
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": review.profiles?.name || "Client Anonim"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": review.rating || 5,
        "bestRating": "5",
        "worstRating": "1"
      },
      "reviewBody": review.comment || "",
      "datePublished": review.created_at
    })),
    "hasOccupation": {
      "@type": "Occupation",
      "name": primaryTrade,
      "occupationLocation": {
        "@type": "City",
        "name": cityFromAddress
      }
    },
    "knowsAbout": trades.map((trade: any) => trade.name),
    "worksFor": {
      "@type": "Organization",
      "name": "Meserias Local",
      "url": "https://www.meseriaslocal.ro"
    },
    "areaServed": {
      "@type": "City",
      "name": cityFromAddress
    },
    "availableChannel": {
      "@type": "ServiceChannel",
      "servicePhone": worker.phone,
      "serviceType": tradeNames
    },
    "makesOffer": isPro ? trades.map((trade: any) => ({
      "@type": "Offer",
      "itemOffered": {
        "@type": "Service",
        "name": trade.name,
        "provider": {
          "@type": "Person",
          "name": workerName
        },
        "areaServed": {
          "@type": "City",
          "name": cityFromAddress
        }
      },
      "availability": "https://schema.org/InStock"
    })) : undefined,
    "sameAs": [
      canonicalUrl
    ]
  })} />
  <TradesmanProfile 
    client:idle 
    worker={{
      ...worker,
      trades,
      portfolio_items: portfolioItems,
      reviews,
      certifications,
      subscription_plan: subscriptionPlan
    }}
    supabaseUrl={supabaseUrl}
    supabaseAnonKey={supabaseAnonKey}
  />
</Base>
