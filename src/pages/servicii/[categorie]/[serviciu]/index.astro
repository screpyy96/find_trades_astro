---
import Base from '../../../../layouts/Base.astro';
import { getServicePage, getImageUrl } from '../../../../lib/sanity';
import { supabase } from '../../../../lib/supabase';

// SSR with caching - hybrid approach (Sanity + fallback)
export const prerender = false;

const { categorie, serviciu } = Astro.params;

if (!categorie || !serviciu) {
  return Astro.redirect('/404');
}

if (!supabase) {
  return Astro.redirect('/servicii', 500);
}

const capitalizeWords = (str: string) => {
  return str.split(' ').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ');
};

const { data: trade, error: tradeError } = await supabase
  .from('trades')
  .select('id, name, slug, category')
  .eq('slug', serviciu)
  .single();

if (tradeError || !trade) {
  return Astro.redirect(`/servicii/${categorie}/`, 301);
}

const service = {
  name: capitalizeWords(trade.name),
  slug: trade.slug,
  category: capitalizeWords(trade.category),
  categorySlug: categorie,
};

// Get content from Sanity
const sanityContent = await getServicePage(serviciu);

// Helper to render portable text
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  
  let html = '';
  
  for (const block of blocks) {
    if (block._type !== 'block') continue;
    
    const text = block.children?.map((child: any) => {
      let processedText = child.text;
      
      if (child.marks?.length) {
        if (child.marks.includes('strong')) {
          processedText = `<strong>${processedText}</strong>`;
        }
        if (child.marks.includes('em')) {
          processedText = `<em>${processedText}</em>`;
        }
        const linkMark = block.markDefs?.find((mark: any) => 
          mark._type === 'link' && child.marks.includes(mark._key)
        );
        if (linkMark) {
          const target = linkMark.blank ? ' target="_blank" rel="noopener"' : '';
          processedText = `<a href="${linkMark.href}" class="text-emerald-600 hover:text-emerald-700 underline"${target}>${processedText}</a>`;
        }
      }
      
      return processedText;
    }).join('') || '';
    
    if (text.trim()) {
      if (block.style === 'h2') {
        html += `<h2 class="text-2xl font-bold text-slate-900 mt-8 mb-4">${text}</h2>`;
      } else if (block.style === 'h3') {
        html += `<h3 class="text-xl font-semibold text-slate-900 mt-6 mb-3">${text}</h3>`;
      } else {
        html += `<p class="text-slate-700 mb-4 leading-relaxed">${text}</p>`;
      }
    }
  }
  
  return html;
}

// SEO
const canonical = sanityContent?.customCanonical || `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}/`;
const title = sanityContent?.seoTitle || `${service.name} – Profesioniști Verificați, Prețuri 2026 | Meserias Local`;
const description = sanityContent?.seoDescription || `Găsește ${service.name.toLowerCase()} verificați în România. Peste 150+ meseriași certificați în 42 orașe. Oferte gratuite în 24h, recenzii reale.`;
const h1 = sanityContent?.h1 || `${service.name} – Profesioniști Verificați în România`;
const keywords = sanityContent?.seoKeywords?.join(', ') || `${service.name.toLowerCase()}, ${service.name.toLowerCase()} profesionist, preț ${service.name.toLowerCase()}`;

// Top cities
const topCities = [
  { name: 'București', slug: 'bucuresti' },
  { name: 'Cluj-Napoca', slug: 'cluj-napoca' },
  { name: 'Timișoara', slug: 'timisoara' },
  { name: 'Iași', slug: 'iasi' },
  { name: 'Constanța', slug: 'constanta' },
  { name: 'Craiova', slug: 'craiova' },
  { name: 'Brașov', slug: 'brasov' },
  { name: 'Galați', slug: 'galati' },
  { name: 'Ploiești', slug: 'ploiesti' },
  { name: 'Oradea', slug: 'oradea' }
];

// Content
const content = sanityContent?.content ? renderPortableText(sanityContent.content) : '';
const faq = sanityContent?.faqSection || [];
const prices = sanityContent?.priceRanges || [];
const priceDisplay = sanityContent?.priceRangeDisplay;
const rating = sanityContent?.aggregateRating;
const relatedServices = sanityContent?.relatedServices || [];

// Similar services from DB
let similarServices: Array<{ name: string; slug: string }> = [];
if (supabase) {
  const { data: similarTrades } = await supabase
    .from('trades')
    .select('name, slug')
    .eq('category', trade.category)
    .neq('slug', serviciu)
    .limit(6);
  
  if (similarTrades) {
    similarServices = similarTrades;
  }
}

// JSON-LD Schemas
const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  '@id': canonical,
  name: h1,
  description: description,
  url: canonical,
  provider: {
    '@type': 'Organization',
    name: 'Meserias Local',
    url: 'https://www.meseriaslocal.ro',
    sameAs: [
      'https://www.facebook.com/meseriaslocal',
      'https://www.instagram.com/meseriaslocal',
      'https://www.tiktok.com/@meseriaslocal'
    ]
  },
  areaServed: {
    '@type': 'Country',
    name: 'România'
  },
  serviceType: service.name,
  category: service.category,
  ...(priceDisplay && { priceRange: priceDisplay }),
  ...(rating && {
    aggregateRating: {
      '@type': 'AggregateRating',
      ratingValue: rating.ratingValue,
      ratingCount: rating.ratingCount,
      bestRating: 5,
      worstRating: 1
    }
  }),
  ...(prices.length > 0 && {
    offers: prices.map(p => ({
      '@type': 'Offer',
      name: p.service,
      priceCurrency: 'RON',
      price: p.minPrice,
      priceSpecification: {
        '@type': 'PriceSpecification',
        minPrice: p.minPrice,
        maxPrice: p.maxPrice,
        priceCurrency: 'RON',
        unitText: p.unit || 'mp'
      }
    }))
  }),
  potentialAction: {
    '@type': 'OrderAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: `https://app.meseriaslocal.ro/cere-oferta?serviciu=${serviciu}`,
      actionPlatform: ['http://schema.org/DesktopWebPlatform', 'http://schema.org/MobileWebPlatform']
    }
  }
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Acasă', item: 'https://www.meseriaslocal.ro' },
    { '@type': 'ListItem', position: 2, name: 'Servicii', item: 'https://www.meseriaslocal.ro/servicii/' },
    { '@type': 'ListItem', position: 3, name: service.category, item: `https://www.meseriaslocal.ro/servicii/${categorie}/` },
    { '@type': 'ListItem', position: 4, name: service.name, item: canonical }
  ]
};

const faqSchema = faq.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faq.map(f => ({
    '@type': 'Question',
    name: f.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: f.answer
    }
  }))
} : null;

const ogImage = sanityContent?.ogImage ? getImageUrl(sanityContent.ogImage) : '/og-image.png';
---

<Base title={title} description={description} canonical={canonical} disableDefaultBreadcrumb={true}>
  <meta slot="head" name="keywords" content={keywords} />
  <meta slot="head" property="og:title" content={title} />
  <meta slot="head" property="og:description" content={description} />
  <meta slot="head" property="og:url" content={canonical} />
  <meta slot="head" property="og:type" content="website" />
  <meta slot="head" property="og:image" content={ogImage} />
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(serviceSchema)}></script>
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>
  {faqSchema && <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(faqSchema)}></script>}

  <!-- Hero -->
  <section class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-12 sm:py-16">
      <div class="max-w-4xl mx-auto text-center">
        <nav class="flex justify-center mb-6">
          <ol class="flex items-center text-sm text-slate-300 flex-wrap justify-center">
            <li><a href="/" class="hover:text-amber-400">Acasă</a></li>
            <li><span class="mx-2 text-white/40">›</span></li>
            <li><a href="/servicii/" class="hover:text-amber-400">Servicii</a></li>
            <li><span class="mx-2 text-white/40">›</span></li>
            <li><a href={`/servicii/${categorie}/`} class="hover:text-amber-400">{service.category}</a></li>
            <li><span class="mx-2 text-white/40">›</span></li>
            <li><span class="text-orange-400 font-semibold">{service.name}</span></li>
          </ol>
        </nav>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4">
          {h1}
        </h1>
        
        <p class="text-lg text-slate-300 mb-6 max-w-2xl mx-auto">
          {sanityContent?.heroDescription || `Găsește ${service.name.toLowerCase()} verificați în București, Cluj-Napoca, Timișoara și în toată România. Oferte gratuite în 24h.`}
        </p>

        <!-- Stats Row -->
        <div class="flex flex-wrap justify-center gap-4 mb-8 text-sm">
          <span class="bg-white/10 px-4 py-2 rounded-full">150+ meseriași verificați</span>
          <span class="bg-white/10 px-4 py-2 rounded-full">42 orașe acoperite</span>
          {rating && (
            <span class="bg-amber-500/20 text-amber-300 px-4 py-2 rounded-full font-medium">
              {rating.ratingValue} ⭐ ({rating.ratingCount} reviews)
            </span>
          )}
          {priceDisplay && (
            <span class="bg-emerald-500/20 text-emerald-300 px-4 py-2 rounded-full font-medium">
              {priceDisplay}
            </span>
          )}
        </div>

        <a 
          href="https://app.meseriaslocal.ro/cere-oferta"
          class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 shadow-lg"
        >
          Solicită ofertă gratuită
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  <div class="max-w-7xl mx-auto px-4 py-8 sm:py-12">
    <div class="space-y-8 sm:space-y-10">
      
      <!-- Prices Table -->
      {prices.length > 0 && (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <h2 class="text-xl font-semibold text-slate-900 mb-6 flex items-center gap-2">
            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Prețuri {service.name} 2026
          </h2>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-slate-200">
                  <th class="text-left py-3 px-4 font-semibold text-slate-700">Serviciu</th>
                  <th class="text-left py-3 px-4 font-semibold text-slate-700">Preț</th>
                  <th class="text-left py-3 px-4 font-semibold text-slate-700">Unitate</th>
                </tr>
              </thead>
              <tbody>
                {prices.map((price, i) => (
                  <tr class={i % 2 === 0 ? 'bg-slate-50' : ''}>
                    <td class="py-3 px-4 text-slate-700">{price.service}</td>
                    <td class="py-3 px-4 font-semibold text-emerald-600">{price.minPrice} - {price.maxPrice} RON</td>
                    <td class="py-3 px-4 text-slate-500">{price.unit || 'mp'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <p class="text-sm text-slate-500 mt-4">* Prețurile sunt orientative și pot varia în funcție de complexitate și locație.</p>
        </section>
      )}

      <!-- Main Content -->
      {content ? (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <div class="prose prose-slate max-w-none" set:html={content}></div>
        </section>
      ) : (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <h2 class="text-2xl font-bold text-slate-900 mb-4">Găsește {service.name.toLowerCase()} verificați în România</h2>
          <p class="text-slate-700 mb-4 leading-relaxed">Platforma Meserias Local conectează clienții cu peste 150+ meseriași certificați pentru servicii de {service.name.toLowerCase()} în toate orașele importante din România.</p>
          <h3 class="text-xl font-semibold text-slate-900 mb-3">De ce să alegi Meserias Local?</h3>
          <p class="text-slate-700 mb-4 leading-relaxed">Primești oferte multiple în 2-4 ore, poți compara prețuri și recenzii, și alegi cel mai bun profesionist pentru proiectul tău. Serviciul este 100% gratuit pentru clienți.</p>
        </section>
      )}

      <!-- CTA -->
      <section class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-6 text-white">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
          <div>
            <h3 class="text-lg font-semibold mb-1">Ai nevoie de {service.name.toLowerCase()}?</h3>
            <p class="text-blue-100 text-sm">Primești oferte personalizate în 2-4 ore</p>
          </div>
          <a 
            href="https://app.meseriaslocal.ro/cere-oferta"
            class="inline-flex items-center gap-2 px-6 py-3 bg-white text-blue-600 font-semibold rounded-md hover:bg-blue-50 transition-colors whitespace-nowrap"
          >
            Solicită ofertă gratuită
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </section>

      <!-- Cities -->
      <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
        <h2 class="text-xl font-semibold text-slate-900 mb-6">{service.name} în Orașele Principale</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
          {topCities.map(city => (
            <a 
              href={`/servicii/${categorie}/${serviciu}/${city.slug}/`}
              class="flex items-center gap-2 p-4 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg hover:from-emerald-100 hover:to-teal-100 border border-emerald-200 transition-all group"
            >
              <svg class="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
              </svg>
              <span class="text-slate-700 font-semibold group-hover:text-emerald-700">{city.name}</span>
            </a>
          ))}
        </div>
      </section>

      <!-- FAQ -->
      {faq.length > 0 ? (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <h2 class="text-xl font-semibold text-slate-900 mb-6">Întrebări Frecvente</h2>
          <div class="space-y-4">
            {faq.map((item, i) => (
              <details class="border border-slate-200 rounded-lg overflow-hidden" open={i === 0}>
                <summary class="flex items-center justify-between p-4 cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors">
                  <h3 class="font-semibold text-slate-900 pr-4">{item.question}</h3>
                  <svg class="w-5 h-5 text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                <div class="p-4 pt-0">
                  <p class="text-slate-600">{item.answer}</p>
                </div>
              </details>
            ))}
          </div>
        </section>
      ) : (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <h2 class="text-xl font-semibold text-slate-900 mb-6">Întrebări Frecvente</h2>
          <div class="space-y-4">
            <details class="border border-slate-200 rounded-lg overflow-hidden" open>
              <summary class="flex items-center justify-between p-4 cursor-pointer bg-slate-50 hover:bg-slate-100">
                <h3 class="font-semibold text-slate-900 pr-4">Cât costă serviciile de {service.name.toLowerCase()}?</h3>
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="p-4 pt-0">
                <p class="text-slate-600">Prețurile variază în funcție de complexitatea proiectului. Primești oferte gratuite de la mai mulți profesioniști și poți compara.</p>
              </div>
            </details>
            <details class="border border-slate-200 rounded-lg overflow-hidden">
              <summary class="flex items-center justify-between p-4 cursor-pointer bg-slate-50 hover:bg-slate-100">
                <h3 class="font-semibold text-slate-900 pr-4">Cum aleg un {service.name.toLowerCase()} de încredere?</h3>
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="p-4 pt-0">
                <p class="text-slate-600">Toți meseriașii sunt verificați. Verifică recenziile, portofoliul și rating-ul pentru a alege cel mai bun profesionist.</p>
              </div>
            </details>
            <details class="border border-slate-200 rounded-lg overflow-hidden">
              <summary class="flex items-center justify-between p-4 cursor-pointer bg-slate-50 hover:bg-slate-100">
                <h3 class="font-semibold text-slate-900 pr-4">În cât timp primesc oferte?</h3>
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="p-4 pt-0">
                <p class="text-slate-600">De obicei primești primele oferte în 2-4 ore. În 24 de ore vei avea 3-5 oferte complete.</p>
              </div>
            </details>
          </div>
        </section>
      )}

      <!-- Related Services -->
      {relatedServices.length > 0 && (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <h3 class="font-semibold text-slate-900 mb-4">Servicii Conexe</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {relatedServices.map(rs => (
              <a 
                href={rs.serviceUrl || `/servicii/${categorie}/${rs.serviceSlug}/`}
                class="p-4 bg-slate-50 rounded-lg border border-slate-200 hover:border-blue-500 hover:shadow-sm transition text-center"
              >
                <span class="font-semibold text-sm">{rs.serviceName}</span>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Similar Services from DB (fallback) -->
      {similarServices.length > 0 && relatedServices.length === 0 && (
        <section class="bg-white rounded-lg p-6 border border-slate-200 shadow-sm">
          <h3 class="font-semibold text-slate-900 mb-4">Servicii Similare</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {similarServices.map(s => (
              <a 
                href={`/servicii/${categorie}/${s.slug}/`}
                class="p-4 bg-slate-50 rounded-lg border border-slate-200 hover:border-blue-500 hover:shadow-sm transition text-center"
              >
                <span class="font-semibold text-sm">{s.name}</span>
              </a>
            ))}
          </div>
        </section>
      )}

    </div>
  </div>
</Base>
