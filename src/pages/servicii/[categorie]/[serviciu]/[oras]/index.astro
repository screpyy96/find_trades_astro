---
import Base from '../../../../../layouts/Base.astro';
import { cities, getCityBySlug, getNearbyCities } from '../../../../../data';
import { getServiceCityPage } from '../../../../../lib/sanity';
import { supabase } from '../../../../../lib/supabase';
import { generateFallbackContent } from '../../../../../lib/seo-fallback';
import { getAppConfig, getPublicSupabaseConfig } from '../../../../../lib/publicEnv';
import { fetchServicePageData, fetchServiceMetrics, fetchRelatedTrades } from '../../../../../lib/service-data';
import { 
  MAX_NEARBY_CITIES, 
  MAX_PRICE_RANGES, 
  MIN_RATING_FOR_DISPLAY,
  MIN_BUDGET_FOR_DISPLAY,
  CACHE_REVALIDATE_CITY
} from '../../../../../lib/constants';
import { RecommendedTradesmen } from '../../../../../components/tradesman/RecommendedTradesmen';

export const prerender = false;
export const config = { revalidate: CACHE_REVALIDATE_CITY };

// Set headers for proper indexing
Astro.response.headers.set('X-Robots-Tag', 'index, follow');
Astro.response.headers.set('Cache-Control', `public, max-age=${CACHE_REVALIDATE_CITY}, s-maxage=${CACHE_REVALIDATE_CITY}, stale-while-revalidate=86400`);

const { categorie, serviciu, oras } = Astro.params;

// Validate required params
if (!categorie || !serviciu || !oras) {
  return Astro.redirect('/404');
}

// Get APP_URL from environment configuration
const { url: APP_URL } = getAppConfig();
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

const city = getCityBySlug(oras);

if (!city) {
  return Astro.redirect('/404');
}

// Fetch all service data with error handling
let serviceData;

try {
  serviceData = await fetchServicePageData(serviciu, categorie);
  
  if (serviceData.error || !serviceData.trade) {
    return Astro.redirect('/404');
  }
} catch (error) {
  // Error logged to monitoring in production
  return Astro.redirect('/404');
}

const { trade, similarTrades } = serviceData;

const service = {
  name: trade.name,
  slug: trade.slug,
  category: trade.category,
  categorySlug: categorie,
};

// Try to get custom content from Sanity
const sanityContent = await getServiceCityPage(serviciu, oras);

// Debug: Log what we get from Sanity
if (import.meta.env.DEV) {
  console.log('üîç Sanity Debug for service city page:');
  console.log('  URL params:');
  console.log('    categorie:', categorie);
  console.log('    serviciu:', serviciu);
  console.log('    oras:', oras);
  console.log('  Service data:');
  console.log('    service.name:', service.name);
  console.log('    service.slug:', service.slug);
  console.log('    service.category:', service.category);
  console.log('  City data:');
  console.log('    city.name:', city.name);
  console.log('    city.slug:', city.slug);
  console.log('  Sanity result:');
  console.log('    sanityContent:', sanityContent);
  console.log('    seoTitle:', sanityContent?.seoTitle);
  console.log('    seoDescription:', sanityContent?.seoDescription);
  console.log('    heroTitle:', sanityContent?.heroTitle);
  console.log('    content exists:', !!sanityContent?.content);
  console.log('    content blocks:', sanityContent?.content?.length || 0);
  if (sanityContent?.content && sanityContent.content.length > 0) {
    console.log('    first block:', sanityContent.content[0]);
    console.log('    first block text:', sanityContent.content[0]?.children?.[0]?.text);
  }
  console.log('  Expected title: "Zugravi Bucure»ôti ‚Äì Profesioni»ôti Verifica»õi, Oferte Rapide"');
}

const nearbyCities = getNearbyCities(oras);
const nearbyCityLinks = nearbyCities.length > 0
  ? nearbyCities
  : cities.filter(c => c.slug !== city.slug).slice(0, MAX_NEARBY_CITIES);

const similarServices = similarTrades.map((t: any) => ({
  name: t.name,
  slug: t.slug,
  categorySlug: categorie,
}));

// Pre-fetch all related service categories if we have Sanity content
let relatedServiceCategories: Record<string, string> = {};
if (sanityContent?.relatedServices && sanityContent.relatedServices.length > 0) {
  const slugs = sanityContent.relatedServices.map((rs: any) => {
    let cleanSlug = rs.serviceSlug.replace(/^\/+|\/+$/g, '');
    if (cleanSlug.includes('/')) {
      const parts = cleanSlug.split('/');
      cleanSlug = parts[parts.length - 1];
    }
    return cleanSlug;
  });
  
  const relatedTrades = await fetchRelatedTrades(slugs);
  
  if (relatedTrades) {
    relatedTrades.forEach(t => {
      relatedServiceCategories[t.slug] = t.category;
    });
  }
}

// Generate comprehensive fallback content
const fallbackContent = generateFallbackContent({
  serviceName: service.name,
  cityName: city.name,
  category: service.category,
  categorySlug: service.categorySlug,
  serviceSlug: service.slug,
  citySlug: city.slug,
  nearbyCities: nearbyCityLinks.map(c => c.name),
  similarServices: similarServices.map(s => s.name)
});

// Helper to render portable text with support for links, marks, and internal city linking
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  
  if (import.meta.env.DEV) {
    console.log('üîç renderPortableText called with blocks:', blocks?.length || 0);
  }
  
  let html = '';
  let inList = false;
  let listType = '';

  for (const block of blocks) {
    if (block._type !== 'block') continue;
    
    if (import.meta.env.DEV) {
      console.log('üîç Processing block style:', block.style);
    }
    
    // Close any open list before starting a new block
    if (inList && block.style !== 'normal') {
      html += `</${listType}>`;
      inList = false;
      listType = '';
    }
    
    if (block.style === 'h1') {
      html += `<h1 class="text-3xl font-bold text-slate-900 mb-4">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h1>`;
    } else if (block.style === 'h2') {
      html += `<h2 class="text-2xl font-bold text-slate-900 mb-3">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h2>`;
    } else if (block.style === 'h3') {
      html += `<h3 class="text-xl font-semibold text-slate-900 mb-2">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h3>`;
    } else if (block.style === 'h4') {
      html += `<h4 class="text-lg font-semibold text-slate-900 mb-2">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h4>`;
    } else if (block.listItem) {
      const listTag = block.level === 1 ? 'ul' : 'ol';
      
      if (!inList || listType !== listTag) {
        if (inList) html += `</${listType}>`;
        html += `<${listTag} class="list-disc list-inside mb-4 space-y-1">`;
        inList = true;
        listType = listTag;
      }
      
      html += `<li class="text-slate-700">${block.children?.map((child: any) => {
        let processedText = child.text;
        if (child.marks?.length) {
          if (child.marks.includes('strong')) {
            processedText = `<strong>${processedText}</strong>`;
          }
        }
        return processedText;
      }).join('') || ''}</li>`;
    } else {
      // Regular paragraph
      if (inList) {
        html += `</${listType}>`;
        inList = false;
        listType = '';
      }
      
      const text = block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            // Check if it's a decorator (strong, em)
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            } else if (markKey === 'em') {
              processedText = `<em>${processedText}</em>`;
            }
            
            // Check if it's an annotation (link)
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || '';
      
      if (import.meta.env.DEV) {
        console.log('üîç Original text before linking:', text);
      }
      
      // Auto-link city names for internal linking
      const cityNames = ['Bucure»ôti', 'Cluj-Napoca', 'Timi»ôoara', 'Ia»ôi', 'Constan»õa', 'Craiova', 'Bra»ôov', 'Gala»õi', 'Ploie»ôti', 'Oradea'];
      let finalText = text;
      
      cityNames.forEach(city => {
        const citySlug = city.toLowerCase()
          .replace(/»ô/g, 's')
          .replace(/»õ/g, 't')
          .replace(/ƒÉ/g, 'a')
          .replace(/√Æ/g, 'i')
          .replace(/√¢/g, 'a')
          .replace(/ /g, '-');
        
        // Create regex for whole word matching
        const regex = new RegExp(`\\b${city}\\b`, 'gi');
        if (regex.test(text)) {
          if (import.meta.env.DEV) {
            console.log(`üîç Found city "${city}" in text, adding link`);
          }
        }
        finalText = finalText.replace(regex, `<a href="/servicii/${categorie}/${serviciu}/${citySlug}/" class="text-emerald-600 hover:text-emerald-700 underline font-medium">${city}</a>`);
      });
      
      if (import.meta.env.DEV) {
        console.log('üîç Final text after linking:', finalText);
      }
      
      if (finalText.trim()) {
        html += `<p class="text-slate-700 mb-4 leading-relaxed">${finalText}</p>`;
      }
    }
  }
  
  // Close any remaining open list
  if (inList) {
    html += `</${listType}>`;
  }
  
  return html;
}

const content = sanityContent?.content ? renderPortableText(sanityContent.content) : fallbackContent.content;

// Hero content
const heroTitle = sanityContent?.heroTitle || fallbackContent.h1;
const heroSubtitle = sanityContent?.heroSubtitle || `Servicii Profesionale √Æn ${city.name}`;
const heroDescription = sanityContent?.heroDescription || `GƒÉse»ôte meseria»ôi ${service.name.toLowerCase()} verifica»õi √Æn ${city.name}. ComparƒÉ oferte gratuite, vezi recenzii »ôi contacteazƒÉ direct. FƒÉrƒÉ comisioane, rƒÉspuns rapid!`;

// Fetch metrics with error handling
let metrics;
try {
  metrics = await fetchServiceMetrics({
    tradeId: trade.id,
    serviceName: service.name,
    cityName: city.name
  });
} catch (error) {
  // Error logged to monitoring in production
  // Use default metrics on error
  metrics = {
    workerCount: 0,
    verifiedCount: 0,
    avgRating: 0,
    jobsLast30Days: 0,
    avgBudget: 0,
    ratedProfilesCount: 0,
    fakeReviews: []
  };
}

// Afi»ôeazƒÉ stats doar dacƒÉ sunt impresionante (evitƒÉ 1.7/5 sau 1 lucrare)
const heroStats = [
  (metrics.avgRating && metrics.avgRating >= MIN_RATING_FOR_DISPLAY) ? { label: 'Rating mediu', value: `${metrics.avgRating.toFixed(1)}/5` } : null,
  (metrics.jobsLast30Days && metrics.jobsLast30Days >= 5) ? { label: 'LucrƒÉri √Æn ultimele 30 zile', value: `${metrics.jobsLast30Days}` } : null,
  (metrics.avgBudget && metrics.avgBudget >= MIN_BUDGET_FOR_DISPLAY) ? { label: 'Buget mediu acceptat', value: `${Math.round(metrics.avgBudget)} RON` } : null
].filter(Boolean) as Array<{ label: string; value: string }>;

function createLocalBusinessSchema(params: { serviceName: string; cityName: string; canonical: string; metrics: any; proTradesmen?: any[] }) {
  const schema: Record<string, any> = {
    '@context': 'https://schema.org',
    '@type': 'LocalBusiness',
    '@id': `${params.canonical}#localbusiness`,
    name: `${params.serviceName} ${params.cityName} | Meserias Local`,
    description: `Servicii ${params.serviceName.toLowerCase()} √Æn ${params.cityName} prin Meserias Local. Profesioni»ôti verifica»õi, oferte gratuite, rƒÉspuns rapid.`,
    url: params.canonical,
    telephone: '+40-XX-XXXX-XXXX',
    email: 'contact@meseriaslocal.ro',
    areaServed: {
      '@type': 'City',
      name: params.cityName,
      addressCountry: 'RO'
    },
    address: {
      '@type': 'PostalAddress',
      addressLocality: params.cityName,
      addressCountry: 'RO',
      addressRegion: params.cityName
    },
    serviceType: params.serviceName,
    category: params.serviceName,
    priceRange: '‚Ç¨‚Ç¨',
    currenciesAccepted: 'RON',
    paymentAccepted: ['Cash', 'Card', 'Bank Transfer'],
    openingHours: 'Mo-Su 00:00-23:59',
    image: 'https://www.meseriaslocal.ro/logo.svg',
    logo: {
      '@type': 'ImageObject',
      url: 'https://www.meseriaslocal.ro/logo.svg'
    },
    sameAs: [
      'https://www.facebook.com/localmeserias',
      'https://www.instagram.com/MeseriasLocal'
    ],
    offers: {
      '@type': 'Offer',
      itemOffered: {
        '@type': 'Service',
        name: params.serviceName,
        description: `Servicii profesionale ${params.serviceName.toLowerCase()} √Æn ${params.cityName}`,
        provider: {
          '@type': 'Organization',
          name: 'Meserias Local'
        }
      },
      priceCurrency: 'RON',
      availability: 'https://schema.org/InStock',
      url: params.canonical
    }
  };

  if (params.metrics.workerCount > 0) {
    schema.numberOfEmployees = {
      '@type': 'QuantitativeValue',
      value: params.metrics.workerCount
    };
  }
  
  // Only add aggregateRating if we have real ratings
  if (params.metrics.avgRating > 0 && params.metrics.ratedProfilesCount > 0) {
    schema.aggregateRating = {
      '@type': 'AggregateRating',
      ratingValue: params.metrics.avgRating.toFixed(1),
      ratingCount: params.metrics.ratedProfilesCount,
      reviewCount: params.metrics.ratedProfilesCount,
      bestRating: '5',
      worstRating: '1'
    };
  }

  if (params.metrics.jobsLast30Days > 0) {
    schema.hasOfferCatalog = {
      '@type': 'OfferCatalog',
      name: `${params.serviceName} Services in ${params.cityName}`,
      numberOfItems: params.metrics.jobsLast30Days
    };
  }

  // Add PRO tradesmen as employees for better SEO
  if (params.proTradesmen && params.proTradesmen.length > 0) {
    schema.employee = params.proTradesmen.map((worker: any) => ({
      '@type': 'Person',
      '@id': `https://www.meseriaslocal.ro/meseriasi/${worker.id}`,
      name: worker.name,
      jobTitle: params.serviceName,
      description: worker.bio ? worker.bio.substring(0, 160) : `Profesionist ${params.serviceName.toLowerCase()} verificat √Æn ${params.cityName}`,
      image: worker.avatar_url || undefined,
      address: {
        '@type': 'PostalAddress',
        addressLocality: params.cityName,
        addressCountry: 'RO'
      },
      url: `https://www.meseriaslocal.ro/meseriasi/${worker.id}`
    }));
  }

  return schema;
}

function buildFaqSchema(faqSection: any) {
  if (!faqSection?.length) return null;
  
  const faqItems = faqSection.map((item: any) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer
    }
  }));

  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqItems
  };
}

// Fetch PRO tradesmen for this service and city for SEO schema
let proTradesmen: any[] = [];
if (supabase) {
  try {
    // Get worker IDs for this trade
    const { data: workerTradesData } = await supabase
      .from('worker_trades')
      .select('profile_id')
      .contains('trade_ids', [trade.id]);

    if (workerTradesData && workerTradesData.length > 0) {
      const workerIds = workerTradesData.map((wt: any) => wt.profile_id);

      // Get PRO workers in this city
      const { data: workersData } = await supabase
        .from('profiles')
        .select('id, name, avatar_url, address, bio, rating')
        .in('id', workerIds)
        .eq('role', 'worker')
        .eq('is_verified', true)
        .ilike('address', `%${city.name}%`)
        .limit(4);

      if (workersData && workersData.length > 0) {
        // Get subscriptions
        const { data: subscriptionsData } = await supabase
          .from('user_subscriptions')
          .select('user_id, plan_id')
          .in('user_id', workersData.map((w: any) => w.id))
          .eq('status', 'active')
          .eq('plan_id', 'pro');

        const proUserIds = new Set(subscriptionsData?.map((s: any) => s.user_id) || []);
        proTradesmen = workersData.filter((w: any) => proUserIds.has(w.id));
      }
    }
  } catch (error) {
    console.error('Error fetching PRO tradesmen for schema:', error);
  }
}

// SEO and structured data
const canonical = `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}/${oras}/`;
const title = sanityContent?.seoTitle || fallbackContent.title;
const description = sanityContent?.seoDescription || fallbackContent.description;

const localBusinessSchema = createLocalBusinessSchema({
  serviceName: service.name,
  cityName: city.name,
  canonical,
  metrics,
  proTradesmen
});

// Service schema for better SEO
const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  '@id': `${canonical}#service`,
  name: `${service.name} ${city.name}`,
  description: `Servicii profesionale de ${service.name.toLowerCase()} √Æn ${city.name}. Meseria»ôi verifica»õi, oferte gratuite, rƒÉspuns rapid.`,
  provider: {
    '@type': 'LocalBusiness',
    '@id': `${canonical}#localbusiness`
  },
  areaServed: {
    '@type': 'City',
    name: city.name,
    addressCountry: 'RO'
  },
  serviceType: service.name,
  url: canonical,
  availableChannel: {
    '@type': 'ServiceChannel',
    serviceUrl: canonical,
    servicePhone: '+40-XX-XXXX-XXXX',
    availableLanguage: {
      '@type': 'Language',
      name: 'Romanian'
    }
  }
};

const faqSchema = buildFaqSchema(sanityContent?.faqSection);

// Breadcrumb schema
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  name: `${service.name} ${city.name} - Breadcrumb Navigation`,
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'AcasƒÉ',
      item: 'https://www.meseriaslocal.ro'
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Servicii',
      item: 'https://www.meseriaslocal.ro/servicii'
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: service.category,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}`
    },
    {
      '@type': 'ListItem',
      position: 4,
      name: service.name,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}`
    },
    {
      '@type': 'ListItem',
      position: 5,
      name: city.name,
      item: canonical
    }
  ]
};

---

<Base title={title} description={description} canonical={canonical} disableDefaultBreadcrumb={true}>
  <!-- Structured Data -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} is:inline></script>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(serviceSchema)} is:inline></script>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} is:inline></script>
  {faqSchema && <script slot="head" type="application/ld+json" set:html={JSON.stringify(faqSchema)} is:inline></script>}

  <!-- Hero Section -->
  <section 
    class="py-12 sm:py-16"
    style="background: linear-gradient(180deg, #1b1f1d 0%, #21251f 50%, #2a302b 100%)"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <!-- Breadcrumb -->
        <nav class="flex justify-center mb-6">
          <ol class="flex items-center space-x-2 text-slate-300 text-xs font-medium">
            <li><a href="/" class="hover:text-white">AcasƒÉ</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><a href="/servicii/" class="hover:text-white">Servicii</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><a href={`/servicii/${categorie}/`} class="hover:text-white">{service.category}</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><a href={`/servicii/${categorie}/${serviciu}/`} class="hover:text-white">{service.name}</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><span class="text-orange-400 font-semibold">{city.name}</span></li>
          </ol>
        </nav>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4">
          {heroTitle}
        </h1>
        
        <p class="text-xl text-slate-300 mb-4">
          {heroSubtitle}
        </p>

        <p class="text-lg text-slate-300 mb-8 max-w-3xl mx-auto">
          {heroDescription}
        </p>

        {heroStats.length > 0 && (
          <div class="flex flex-wrap items-center justify-center gap-4 mb-8">
            {heroStats.map(stat => (
              <div class="bg-white/10 rounded-lg px-4 py-2">
                <div class="text-amber-400 font-bold text-lg">{stat.value}</div>
                <div class="text-slate-300 text-sm">{stat.label}</div>
              </div>
            ))}
          </div>
        )}

        <a 
          href={`${APP_URL}/cere-oferta?tradeId=${trade.id}&title=${encodeURIComponent(service.name)}`}
          class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 shadow-lg"
        >
          Cere ofertƒÉ gratuitƒÉ
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- PRO Tradesmen Section -->
  <section class="bg-gradient-to-b from-slate-50 to-white pt-4">
    <div class="max-w-7xl mx-auto px-4">
      <RecommendedTradesmen
        tradeId={trade.id}
        tradeName={service.name}
        cityName={city.name}
        supabaseUrl={supabaseUrl}
        supabaseAnonKey={supabaseAnonKey}
        maxResults={4}
        compact={true}
        client:load
      />
    </div>
  </section>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-16 sm:py-20">
    <div class="space-y-16">
      <!-- Service Description -->
      <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            Despre serviciul {service.name.toLowerCase()}
          </h2>
        </div>
        
        <div class="prose prose-slate prose-lg max-w-none">
          <div set:html={content}></div>
        </div>
      </section>

      <!-- CTA Section -->
      <section class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-8 border border-blue-100">
        <div class="text-center">
          <h3 class="text-2xl font-bold text-slate-900 mb-4">
            Gata sƒÉ √Æncepi proiectul tƒÉu?
          </h3>
          <p class="text-slate-700 mb-6 max-w-2xl mx-auto">
            Prime»ôte oferte gratuite de la meseria»ôi verifica»õi √Æn {city.name}. RƒÉspuns rapid √Æn 2‚Äì4 ore, fƒÉrƒÉ comisioane ascunse.
          </p>
          <a 
            href={`${APP_URL}/cere-oferta?tradeId=${trade.id}&title=${encodeURIComponent(service.name)}`}
            class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
          >
            Cere OfertƒÉ Acum
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
          
          <div class="mt-6 flex flex-wrap items-center justify-center gap-6 text-sm text-slate-600">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              <span>FƒÉrƒÉ obliga»õii</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
              </svg>
              <span>RƒÉspuns √Æn 2-4 ore</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
              </svg>
              <span>Oferte multiple</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Additional Info -->
      {sanityContent?.priceRanges && sanityContent.priceRanges.length > 0 && (
        <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
          <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Pre»õuri orientative √Æn {city.name}
          </h3>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {sanityContent.priceRanges.slice(0, MAX_PRICE_RANGES).map((price: { service: string; minPrice: number; maxPrice: number }) => (
              <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <div class="text-sm text-slate-700 mb-1">{price.service}</div>
                <div class="text-lg font-bold text-slate-900">{price.minPrice}-{price.maxPrice} lei</div>
              </div>
            ))}
          </div>
          <p class="text-sm text-slate-500 mt-4">* Pre»õurile sunt orientative »ôi pot varia √Æn func»õie de complexitatea lucrƒÉrii</p>
        </section>
      )}
    </div>
  </div>
</Base>
