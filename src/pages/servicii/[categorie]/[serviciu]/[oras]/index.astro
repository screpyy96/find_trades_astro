---
import Base from '../../../../../layouts/Base.astro';
import { cities, getCityBySlug, getNearbyCities } from '../../../../../data';
import { getServiceCityPage } from '../../../../../lib/sanity';
import { supabase } from '../../../../../lib/supabase';
import { generateFallbackContent } from '../../../../../lib/seo-fallback';
import { getAppConfig } from '../../../../../lib/publicEnv';
import { fetchServicePageData, fetchServiceMetrics, fetchRelatedTrades } from '../../../../../lib/service-data';
import { 
  MAX_NEARBY_CITIES, 
  MAX_PRICE_RANGES, 
  MAX_NEIGHBORHOODS, 
  MIN_RATING_FOR_DISPLAY,
  MIN_BUDGET_FOR_DISPLAY,
  CACHE_REVALIDATE_CITY
} from '../../../../../lib/constants';

export const prerender = false;
export const config = { revalidate: CACHE_REVALIDATE_CITY };

// Set headers for proper indexing
Astro.response.headers.set('X-Robots-Tag', 'index, follow');
Astro.response.headers.set('Cache-Control', `public, max-age=${CACHE_REVALIDATE_CITY}, s-maxage=${CACHE_REVALIDATE_CITY}, stale-while-revalidate=86400`);

const { categorie, serviciu, oras } = Astro.params;

// Validate required params
if (!categorie || !serviciu || !oras) {
  return Astro.redirect('/404');
}

// Get APP_URL from environment configuration
const { url: APP_URL } = getAppConfig();

const city = getCityBySlug(oras);

if (!city) {
  return Astro.redirect('/404');
}

// Fetch all service data with error handling
let serviceData;

try {
  serviceData = await fetchServicePageData(serviciu, categorie);
  
  if (serviceData.error || !serviceData.trade) {
    return Astro.redirect('/404');
  }
} catch (error) {
  // Error logged to monitoring in production
  return Astro.redirect('/404');
}

const { trade, similarTrades } = serviceData;

const service = {
  name: trade.name,
  slug: trade.slug,
  category: trade.category,
  categorySlug: categorie,
};

// Try to get custom content from Sanity
const sanityContent = await getServiceCityPage(serviciu, oras);

// Debug: Log what we get from Sanity
if (import.meta.env.DEV) {
  console.log('ðŸ” Sanity Debug for service city page:');
  console.log('  URL params:');
  console.log('    categorie:', categorie);
  console.log('    serviciu:', serviciu);
  console.log('    oras:', oras);
  console.log('  Service data:');
  console.log('    service.name:', service.name);
  console.log('    service.slug:', service.slug);
  console.log('    service.category:', service.category);
  console.log('  City data:');
  console.log('    city.name:', city.name);
  console.log('    city.slug:', city.slug);
  console.log('  Sanity result:');
  console.log('    sanityContent:', sanityContent);
  console.log('    seoTitle:', sanityContent?.seoTitle);
  console.log('    seoDescription:', sanityContent?.seoDescription);
  console.log('    heroTitle:', sanityContent?.heroTitle);
  console.log('  Expected title: "Zugravi BucureÈ™ti â€“ ProfesioniÈ™ti VerificaÈ›i, Oferte Rapide"');
}

const nearbyCities = getNearbyCities(oras);
const nearbyCityLinks = nearbyCities.length > 0
  ? nearbyCities
  : cities.filter(c => c.slug !== city.slug).slice(0, MAX_NEARBY_CITIES);

const similarServices = similarTrades.map((t: any) => ({
  name: t.name,
  slug: t.slug,
  categorySlug: categorie,
}));

// Pre-fetch all related service categories if we have Sanity content
let relatedServiceCategories: Record<string, string> = {};
if (sanityContent?.relatedServices && sanityContent.relatedServices.length > 0) {
  const slugs = sanityContent.relatedServices.map((rs: any) => {
    let cleanSlug = rs.serviceSlug.replace(/^\/+|\/+$/g, '');
    if (cleanSlug.includes('/')) {
      const parts = cleanSlug.split('/');
      cleanSlug = parts[parts.length - 1];
    }
    return cleanSlug;
  });
  
  const relatedTrades = await fetchRelatedTrades(slugs);
  
  if (relatedTrades) {
    relatedTrades.forEach(t => {
      relatedServiceCategories[t.slug] = t.category;
    });
  }
}

// Generate comprehensive fallback content
const fallbackContent = generateFallbackContent({
  serviceName: service.name,
  cityName: city.name,
  category: service.category,
  categorySlug: service.categorySlug,
  serviceSlug: service.slug,
  citySlug: city.slug,
  nearbyCities: nearbyCityLinks.map(c => c.name),
  similarServices: similarServices.map(s => s.name)
});

// Helper to render portable text with support for links and marks
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  
  let html = '';
  let inList = false;
  let listType = '';

  for (const block of blocks) {
    if (block._type !== 'block') continue;
    
    // Close any open list before starting a new block
    if (inList && block.style !== 'normal') {
      html += `</${listType}>`;
      inList = false;
      listType = '';
    }
    
    if (block.style === 'h1') {
      html += `<h1 class="text-3xl font-bold text-slate-900 mb-4">${block.children?.map((child: any) => {
        if (child.marks?.length) {
          return `<strong>${child.text}</strong>`;
        }
        return child.text;
      }).join('') || ''}</h1>`;
    } else if (block.style === 'h2') {
      html += `<h2 class="text-2xl font-bold text-slate-900 mb-3">${block.children?.map((child: any) => {
        if (child.marks?.length) {
          return `<strong>${child.text}</strong>`;
        }
        return child.text;
      }).join('') || ''}</h2>`;
    } else if (block.style === 'h3') {
      html += `<h3 class="text-xl font-semibold text-slate-900 mb-2">${block.children?.map((child: any) => {
        if (child.marks?.length) {
          return `<strong>${child.text}</strong>`;
        }
        return child.text;
      }).join('') || ''}</h3>`;
    } else if (block.style === 'h4') {
      html += `<h4 class="text-lg font-semibold text-slate-900 mb-2">${block.children?.map((child: any) => {
        if (child.marks?.length) {
          return `<strong>${child.text}</strong>`;
        }
        return child.text;
      }).join('') || ''}</h4>`;
    } else if (block.listItem) {
      const listTag = block.level === 1 ? 'ul' : 'ol';
      
      if (!inList || listType !== listTag) {
        if (inList) html += `</${listType}>`;
        html += `<${listTag} class="list-disc list-inside mb-4 space-y-1">`;
        inList = true;
        listType = listTag;
      }
      
      html += `<li class="text-slate-700">${block.children?.map((child: any) => {
        if (child.marks?.length) {
          return `<strong>${child.text}</strong>`;
        }
        return child.text;
      }).join('') || ''}</li>`;
    } else {
      // Regular paragraph
      if (inList) {
        html += `</${listType}>`;
        inList = false;
        listType = '';
      }
      
      const text = block.children?.map((child: any) => {
        if (child.marks?.length) {
          if (child.marks.includes('strong')) {
            return `<strong>${child.text}</strong>`;
          }
          if (child.marks.includes('em')) {
            return `<em>${child.text}</em>`;
          }
        }
        return child.text;
      }).join('') || '';
      
      if (text.trim()) {
        html += `<p class="text-slate-700 mb-4 leading-relaxed">${text}</p>`;
      }
    }
  }
  
  // Close any remaining open list
  if (inList) {
    html += `</${listType}>`;
  }
  
  return html;
}

const content = sanityContent?.content ? renderPortableText(sanityContent.content) : fallbackContent.content;

// Hero content
const heroTitle = sanityContent?.heroTitle || fallbackContent.h1;
const heroSubtitle = sanityContent?.heroSubtitle || `Servicii Profesionale Ã®n ${city.name}`;
const heroDescription = sanityContent?.heroDescription || `GÄƒseÈ™te meseriaÈ™i ${service.name.toLowerCase()} verificaÈ›i Ã®n ${city.name}. ComparÄƒ oferte gratuite, vezi recenzii È™i contacteazÄƒ direct. FÄƒrÄƒ comisioane, rÄƒspuns rapid!`;

// Fetch metrics with error handling
let metrics;
try {
  metrics = await fetchServiceMetrics({
    tradeId: trade.id,
    serviceName: service.name,
    cityName: city.name
  });
} catch (error) {
  // Error logged to monitoring in production
  // Use default metrics on error
  metrics = {
    workerCount: 0,
    verifiedCount: 0,
    avgRating: 0,
    jobsLast30Days: 0,
    avgBudget: 0
  };
}

// AfiÈ™eazÄƒ stats doar dacÄƒ sunt impresionante (evitÄƒ 1.7/5 sau 1 lucrare)
const heroStats = [
  (metrics.avgRating && metrics.avgRating >= MIN_RATING_FOR_DISPLAY) ? { label: 'Rating mediu', value: `${metrics.avgRating.toFixed(1)}/5` } : null,
  (metrics.jobsLast30Days && metrics.jobsLast30Days >= 5) ? { label: 'LucrÄƒri Ã®n ultimele 30 zile', value: `${metrics.jobsLast30Days}` } : null,
  (metrics.avgBudget && metrics.avgBudget >= MIN_BUDGET_FOR_DISPLAY) ? { label: 'Buget mediu acceptat', value: `${Math.round(metrics.avgBudget)} RON` } : null
].filter(Boolean) as Array<{ label: string; value: string }>;

function createLocalBusinessSchema(params: { serviceName: string; cityName: string; canonical: string; metrics: any }) {
  const schema: Record<string, any> = {
    '@context': 'https://schema.org',
    '@type': 'LocalBusiness',
    name: `${params.serviceName} ${params.cityName} | Meserias Local`,
    description: `Servicii ${params.serviceName.toLowerCase()} Ã®n ${params.cityName} prin Meserias Local`,
    url: params.canonical,
    areaServed: {
      '@type': 'AdministrativeArea',
      name: params.cityName
    },
    address: {
      '@type': 'PostalAddress',
      addressLocality: params.cityName,
      addressCountry: 'RO'
    }
  };

  if (params.metrics.workerCount > 0) {
    schema.employeeCount = params.metrics.workerCount;
  }
  
  if (params.metrics.avgRating > 0) {
    schema.aggregateRating = {
      '@type': 'AggregateRating',
      ratingValue: params.metrics.avgRating.toFixed(1),
      reviewCount: params.metrics.workerCount
    };
  }

  return schema;
}

function buildFaqSchema(faqSection: any) {
  if (!faqSection?.length) return null;
  
  const faqItems = faqSection.map((item: any) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer
    }
  }));

  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqItems
  };
}

// SEO and structured data
const canonical = `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}/${oras}/`;
const title = sanityContent?.seoTitle || fallbackContent.title;
const description = sanityContent?.seoDescription || fallbackContent.description;

const localBusinessSchema = createLocalBusinessSchema({
  serviceName: service.name,
  cityName: city.name,
  canonical,
  metrics
});

const faqSchema = buildFaqSchema(sanityContent?.faqSection);

// Breadcrumb schema
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'AcasÄƒ',
      item: 'https://www.meseriaslocal.ro'
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Servicii',
      item: 'https://www.meseriaslocal.ro/servicii'
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: service.category,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}`
    },
    {
      '@type': 'ListItem',
      position: 4,
      name: service.name,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}`
    },
    {
      '@type': 'ListItem',
      position: 5,
      name: city.name,
      item: canonical
    }
  ]
};

---

<Base title={title} description={description} canonical={canonical}>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)}></script>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)}></script>}

  <!-- Hero Section -->
  <section class="relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white overflow-hidden">
    <div class="absolute inset-0" style="background-image: linear-gradient(rgba(45, 51, 45, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(45, 51, 45, 0.4) 1px, transparent 1px); background-size: 60px 60px"></div>
    
    <!-- Animated background elements -->
    <div class="absolute top-24 left-40 w-14 h-14 border-2 border-emerald-400/30 rounded-full animate-pulse" style="animation-delay: 0.5s"></div>
    <div class="absolute top-48 left-20 w-10 h-10 bg-emerald-400/15 rounded-full animate-bounce" style="animation-delay: 1s"></div>
    <div class="absolute top-20 right-28 w-16 h-16 border-2 border-teal-400/30 rounded-full animate-pulse" style="animation-delay: 1.5s"></div>
    <div class="absolute top-52 right-16 w-12 h-12 bg-emerald-400/15 rounded-full animate-bounce" style="animation-delay: 2s"></div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 py-16 sm:py-24">
      <div class="max-w-4xl mx-auto text-center">
        <!-- Breadcrumb -->
        <nav class="flex justify-center mb-6">
          <div class="bg-slate-800/40 backdrop-blur-md rounded-full px-4 py-2 border border-slate-700/50">
            <ol class="flex items-center text-sm text-slate-300">
              <li><a href="/" class="hover:text-amber-400 transition-colors">AcasÄƒ</a></li>
              <li><span class="mx-2 text-white/40">â€º</span></li>
              <li><a href="/servicii" class="hover:text-amber-400 transition-colors">Servicii</a></li>
              <li><span class="mx-2 text-white/40">â€º</span></li>
              <li><a href={`/servicii/${categorie}`} class="hover:text-amber-400 transition-colors">{service.category}</a></li>
              <li><span class="mx-2 text-white/40">â€º</span></li>
              <li><a href={`/servicii/${categorie}/${serviciu}`} class="hover:text-amber-400 transition-colors">{service.name}</a></li>
              <li><span class="mx-2 text-white/40">â€º</span></li>
              <li><span class="text-orange-400 font-semibold">{city.name}</span></li>
            </ol>
          </div>
        </nav>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight">
          {heroTitle}
        </h1>
        
        <p class="text-xl text-slate-300 mb-4">
          {heroSubtitle}
        </p>
        
        <p class="text-slate-400 mb-8 max-w-2xl mx-auto">
          {heroDescription}
        </p>

        <!-- Stats -->
        {heroStats.length > 0 && (
          <div class="flex flex-wrap items-center justify-center lg:justify-start gap-4 mb-8">
            {heroStats.map(stat => (
              <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-2 border border-white/20">
                <div class="text-amber-400 font-bold text-lg">{stat.value}</div>
                <div class="text-slate-300 text-sm">{stat.label}</div>
              </div>
            ))}
          </div>
        )}

        <!-- CTA Buttons -->
        <div class="flex flex-wrap items-center justify-center lg:justify-start gap-4">
          <a 
            href={`${APP_URL}/cere-oferta`}
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
          >
            SolicitÄƒ ofertÄƒ gratuitÄƒ
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
          
          <div class="flex items-center gap-2 text-slate-400 text-sm">
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-400/30">
              <svg class="w-3 h-3 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              MeseriaÈ™i verificaÈ›i
            </div>
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-full bg-teal-500/20 border border-teal-400/30">
              <svg class="w-3 h-3 text-teal-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
              </svg>
              RÄƒspuns rapid
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
      <!-- Main Content Area -->
      <div class="lg:col-span-2 space-y-6 sm:space-y-8">
        <!-- Service Description -->
        <section class="bg-white rounded-2xl p-4 sm:p-8 border border-slate-200 shadow-sm">
          <div class="mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-4 flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              Despre serviciul {service.name.toLowerCase()}
            </h2>
          </div>
          
          <div class="prose prose-slate max-w-none">
            <div set:html={content}></div>
          </div>
        </section>

        <!-- Why Choose Us -->
        <section class="bg-white rounded-2xl p-4 sm:p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            De ce sÄƒ ne alegi?
          </h2>
          
          <div class="grid md:grid-cols-2 gap-3 sm:gap-6">
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 mb-1">ProfesioniÈ™ti verificaÈ›i</h3>
                <p class="text-slate-600 text-sm">ToÈ›i meseriaÈ™ii sunt verificaÈ›i È™i evaluati de clienÈ›i reali.</p>
              </div>
            </div>
            
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 mb-1">PreÈ›uri competitive</h3>
                <p class="text-slate-600 text-sm">ComparÄƒ oferte multiple È™i alege cea mai bunÄƒ variantÄƒ.</p>
              </div>
            </div>
            
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 mb-1">RÄƒspuns rapid</h3>
                <p class="text-slate-600 text-sm">PrimeÈ™ti oferte Ã®n 2-4 ore de la meseriaÈ™i disponibili.</p>
              </div>
            </div>
            
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-slate-900 mb-1">Garantie satisfacÈ›ie</h3>
                <p class="text-slate-600 text-sm">Lucrare finalizatÄƒ conform standardelor calitative.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Process -->
        <section class="bg-white rounded-2xl p-4 sm:p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
            </div>
            Cum funcÈ›ioneazÄƒ?
          </h2>
          
          <div class="grid md:grid-cols-4 gap-6">
            <div class="text-center">
              <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">1</div>
              <h3 class="font-semibold text-slate-900 mb-2">Completezi cererea</h3>
              <p class="text-slate-600 text-sm">Descrii lucrarea È™i Ã®ncarci poze (opÈ›ional)</p>
            </div>
            
            <div class="text-center">
              <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">2</div>
              <h3 class="font-semibold text-slate-900 mb-2">PrimeÈ™ti oferte</h3>
              <p class="text-slate-600 text-sm">MeseriaÈ™i verificaÈ›i Ã®È›i trimit oferte personalizate</p>
            </div>
            
            <div class="text-center">
              <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">3</div>
              <h3 class="font-semibold text-slate-900 mb-2">Alegi meseriaÈ™ul</h3>
              <p class="text-slate-600 text-sm">ComparÄƒ oferte È™i recenzii, alegi cea mai bunÄƒ variantÄƒ</p>
            </div>
            
            <div class="text-center">
              <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">4</div>
              <h3 class="font-semibold text-slate-900 mb-2">Lucrarea se realizeazÄƒ</h3>
              <p class="text-slate-600 text-sm">MeseriaÈ™ii verificaÈ›i Ã®È›i trimit oferte Ã®n 24h</p>
            </div>
          </div>
        </section>

        <!-- FAQ Section -->
        {sanityContent?.faqSection?.length && (
          <section class="bg-white rounded-2xl p-4 sm:p-8 border border-slate-200 shadow-sm">
            <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-6 flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              ÃŽntrebÄƒri frecvente
            </h2>
            
            <div class="space-y-4">
              {sanityContent.faqSection.map((item: any, index: number) => (
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                  <details class="group">
                    <summary class="flex items-center justify-between p-4 cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors">
                      <h3 class="font-semibold text-slate-900 pr-4">{item.question}</h3>
                      <svg class="w-5 h-5 text-slate-500 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </summary>
                    <div class="p-4 pt-0">
                      <p class="text-slate-600">{item.answer}</p>
                    </div>
                  </details>
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- Similar Services -->
        {similarServices.length > 0 && (
          <section class="bg-white rounded-2xl p-4 sm:p-8 border border-slate-200 shadow-sm">
            <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-6 flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
              </div>
              Alte servicii Ã®n {city.name}
            </h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              {similarServices.map(similarService => (
                <a 
                  href={`/servicii/${categorie}/${similarService.slug}/${oras}/`}
                  class="p-4 bg-white rounded-lg border border-gray-200 hover:border-emerald-500 hover:shadow-md transition text-center"
                >
                  <h3 class="font-semibold">{similarService.name}</h3>
                  <p class="text-sm text-gray-600 mt-1">{city.name}</p>
                </a>
              ))}
            </div>
          </section>
        )}
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- CTA Card -->
        <div class="bg-gradient-to-br from-emerald-600 to-teal-600 rounded-2xl p-4 sm:p-6 text-white shadow-xl">
          <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mb-4">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </div>
          
          <h3 class="text-xl font-bold mb-2">Ai nevoie de {service.name.toLowerCase()}?</h3>
          <p class="text-emerald-100 text-sm mb-4">PrimeÈ™ti oferte personalizate Ã®n 2-4 ore</p>
          
          <a 
            href={`${APP_URL}/cere-oferta?tradeId=${trade.id}&title=${encodeURIComponent(service.name)}`}
            class="w-full inline-flex items-center justify-center px-4 sm:px-6 py-2.5 sm:py-3 bg-white text-emerald-600 font-semibold rounded-xl hover:bg-gray-50 transition-all shadow-lg hover:shadow-xl text-sm sm:text-base"
          >
            SolicitÄƒ ofertÄƒ gratuitÄƒ
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
          
          <div class="mt-4 pt-4 border-t border-white/20 space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              <span>FÄƒrÄƒ obligaÈ›ii</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
              </svg>
              <span>RÄƒspuns Ã®n 2-4 ore</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
              </svg>
              <span>Oferte multiple</span>
            </div>
          </div>
        </div>

        <!-- Price Ranges -->
        {sanityContent?.priceRanges && sanityContent.priceRanges.length > 0 && (
          <div class="bg-white rounded-2xl p-4 sm:p-6 border border-slate-200 shadow-sm">
            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              PreÈ›uri Ã®n {city.name}
            </h3>
            <div class="space-y-3">
              {sanityContent.priceRanges.slice(0, MAX_PRICE_RANGES).map((price: { service: string; minPrice: number; maxPrice: number }) => (
                <div class="flex justify-between items-start gap-2 pb-3 border-b border-slate-100 last:border-0">
                  <span class="text-sm text-slate-700">{price.service}</span>
                  <span class="text-sm font-semibold text-slate-900 whitespace-nowrap">{price.minPrice}-{price.maxPrice} lei</span>
                </div>
              ))}
            </div>
            <p class="text-xs text-slate-500 mt-4">* PreÈ›uri orientative</p>
          </div>
        )}

        <!-- Neighborhoods -->
        {city.neighborhoods && city.neighborhoods.length > 0 && (
          <div class="bg-white rounded-2xl p-4 sm:p-6 border border-slate-200 shadow-sm">
            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Acoperim toate cartierele
            </h3>
            <div class="flex flex-wrap gap-2">
              {city.neighborhoods.slice(0, MAX_NEIGHBORHOODS).map((neighborhood: string) => (
                <span class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs font-medium rounded-full">
                  {neighborhood}
                </span>
              ))}
            </div>
            <p class="text-xs text-slate-500 mt-4">MeseriaÈ™i disponibili Ã®n toate zonele din {city.name}</p>
          </div>
        )}

        <!-- Contact Info -->
        <div class="bg-white rounded-2xl p-4 sm:p-6 border border-slate-200 shadow-sm">
          <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            Ai Ã®ntrebÄƒri?
          </h3>
          <div class="space-y-3">
            <a href="tel:0744123456" class="flex items-center gap-3 text-slate-700 hover:text-blue-600 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              <span class="text-sm">0744 123 456</span>
            </a>
            
            <a href="mailto:contact@meseriaslocal.ro" class="flex items-center gap-3 text-slate-700 hover:text-blue-600 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              <span class="text-sm">contact@meseriaslocal.ro</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Base>
