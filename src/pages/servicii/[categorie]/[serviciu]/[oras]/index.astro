---
import Base from '../../../../../layouts/Base.astro';
import { cities, getCityBySlug, getNearbyCities } from '../../../../../data';
import { getServiceCityPage } from '../../../../../lib/sanity';
import { generateFallbackContent } from '../../../../../lib/seo-fallback';
import { getAppConfig, getPublicSupabaseConfig } from '../../../../../lib/publicEnv';
import { fetchServicePageData, fetchServiceMetrics, fetchRelatedTrades } from '../../../../../lib/service-data';
import { 
  MAX_NEARBY_CITIES, 
  MAX_PRICE_RANGES, 
  MIN_RATING_FOR_DISPLAY,
  MIN_BUDGET_FOR_DISPLAY
} from '../../../../../lib/constants';
import { RecommendedTradesmen } from '../../../../../components/tradesman/RecommendedTradesmen';

// SSR with caching - pages generated on request, cached for performance
export const prerender = false;

const { categorie, serviciu, oras } = Astro.params;

// Validate required params
if (!categorie || !serviciu || !oras) {
  return Astro.redirect('/404');
}

// Cache for 1 hour on Vercel edge, stale-while-revalidate for 24h
// This is critical for crawl budget ‚Äî without it, every Googlebot request is a cold SSR
Astro.response.headers.set('Cache-Control', 'public, s-maxage=3600, stale-while-revalidate=86400');
// Get APP_URL from environment configuration
const { url: APP_URL } = getAppConfig();
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

const city = getCityBySlug(oras);

// If city doesn't exist, redirect 301 to service page without city (better for SEO than 404)
if (!city) {
  return Astro.redirect(`/servicii/${categorie}/${serviciu}/`, 301);
}

// OPTIMIZATION: Fetch service data and Sanity content in PARALLEL
const [serviceDataResult, sanityContent] = await Promise.all([
  fetchServicePageData(serviciu, categorie).catch(() => ({ error: true, trade: null, similarTrades: [] })),
  getServiceCityPage(serviciu, oras).catch(() => null)
]);

if (serviceDataResult.error || !serviceDataResult.trade) {
  return Astro.redirect('/404');
}

const { trade, similarTrades } = serviceDataResult;

const service = {
  name: trade.name,
  slug: trade.slug,
  category: trade.category,
  categorySlug: categorie,
};

// Debug logging only in dev
if (import.meta.env.DEV && sanityContent) {
  console.log('üîç Sanity content found for:', serviciu, oras);
}

const nearbyCities = getNearbyCities(oras);
const nearbyCityLinks = nearbyCities.length > 0
  ? nearbyCities
  : cities.filter(c => c.slug !== city.slug).slice(0, MAX_NEARBY_CITIES);

const similarServices = similarTrades.map((t: any) => ({
  name: t.name,
  slug: t.slug,
  categorySlug: categorie,
}));

// OPTIMIZATION: Fetch metrics and related trades in PARALLEL
const relatedSlugs = sanityContent?.relatedServices?.map((rs: any) => {
  // Handle both serviceSlug and serviceUrl fields
  const slugSource = rs.serviceSlug || rs.serviceUrl || '';
  if (!slugSource) return null;
  
  let cleanSlug = slugSource.replace(/^\/+|\/+$/g, '');
  if (cleanSlug.includes('/')) {
    const parts = cleanSlug.split('/');
    cleanSlug = parts[parts.length - 1];
  }
  return cleanSlug;
}).filter(Boolean) || [];

const [metrics, relatedTradesResult] = await Promise.all([
  fetchServiceMetrics({
    tradeId: trade.id,
    serviceName: service.name,
    cityName: city.name
  }).catch(() => ({
    workerCount: 0,
    verifiedCount: 0,
    avgRating: 0,
    jobsLast30Days: 0,
    avgBudget: 0,
    ratedProfilesCount: 0,
    fakeReviews: []
  })),
  relatedSlugs.length > 0 ? fetchRelatedTrades(relatedSlugs).catch(() => null) : Promise.resolve(null)
]);

// Build related service categories map
let relatedServiceCategories: Record<string, string> = {};
if (relatedTradesResult) {
  relatedTradesResult.forEach((t: any) => {
    relatedServiceCategories[t.slug] = t.category;
  });
}

// Generate comprehensive fallback content
const fallbackContent = generateFallbackContent({
  serviceName: service.name,
  cityName: city.name,
  category: service.category,
  categorySlug: service.categorySlug,
  serviceSlug: service.slug,
  citySlug: city.slug,
  nearbyCities: nearbyCityLinks.map(c => c.name),
  similarServices: similarServices.map(s => s.name)
});

// Helper to render portable text with support for links, marks, and internal city linking
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  
  if (import.meta.env.DEV) {
    console.log('üîç renderPortableText called with blocks:', blocks?.length || 0);
  }
  
  let html = '';
  let inList = false;
  let listType = '';

  for (const block of blocks) {
    if (block._type !== 'block') continue;
    
    if (import.meta.env.DEV) {
      console.log('üîç Processing block style:', block.style);
    }
    
    // Close any open list before starting a new block
    if (inList && block.style !== 'normal') {
      html += `</${listType}>`;
      inList = false;
      listType = '';
    }
    
    if (block.style === 'h1') {
      html += `<h1 class="text-3xl font-bold text-slate-900 mb-4">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h1>`;
    } else if (block.style === 'h2') {
      html += `<h2 class="text-2xl font-bold text-slate-900 mb-3">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h2>`;
    } else if (block.style === 'h3') {
      html += `<h3 class="text-xl font-semibold text-slate-900 mb-2">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h3>`;
    } else if (block.style === 'h4') {
      html += `<h4 class="text-lg font-semibold text-slate-900 mb-2">${block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            }
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || ''}</h4>`;
    } else if (block.listItem) {
      const listTag = block.level === 1 ? 'ul' : 'ol';
      
      if (!inList || listType !== listTag) {
        if (inList) html += `</${listType}>`;
        html += `<${listTag} class="list-disc list-inside mb-4 space-y-1">`;
        inList = true;
        listType = listTag;
      }
      
      html += `<li class="text-slate-700">${block.children?.map((child: any) => {
        let processedText = child.text;
        if (child.marks?.length) {
          if (child.marks.includes('strong')) {
            processedText = `<strong>${processedText}</strong>`;
          }
        }
        return processedText;
      }).join('') || ''}</li>`;
    } else {
      // Regular paragraph
      if (inList) {
        html += `</${listType}>`;
        inList = false;
        listType = '';
      }
      
      const text = block.children?.map((child: any) => {
        let processedText = child.text;
        
        // Handle marks and annotations (including links)
        if (child.marks?.length) {
          child.marks.forEach((markKey: string) => {
            // Check if it's a decorator (strong, em)
            if (markKey === 'strong') {
              processedText = `<strong>${processedText}</strong>`;
            } else if (markKey === 'em') {
              processedText = `<em>${processedText}</em>`;
            }
            
            // Check if it's an annotation (link)
            const markDef = block.markDefs?.find((mark: any) => mark._key === markKey);
            if (markDef && markDef._type === 'link') {
              const targetAttr = markDef.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
              processedText = `<a href="${markDef.href}" class="text-emerald-600 hover:text-emerald-700 underline"${targetAttr}>${processedText}</a>`;
            }
          });
        }
        
        return processedText;
      }).join('') || '';
      
      if (import.meta.env.DEV) {
        console.log('üîç Original text before linking:', text);
      }
      
      // Auto-link city names for internal linking
      const cityNames = ['Bucure»ôti', 'Cluj-Napoca', 'Timi»ôoara', 'Ia»ôi', 'Constan»õa', 'Craiova', 'Bra»ôov', 'Gala»õi', 'Ploie»ôti', 'Oradea'];
      let finalText = text;
      
      cityNames.forEach(city => {
        const citySlug = city.toLowerCase()
          .replace(/»ô/g, 's')
          .replace(/»õ/g, 't')
          .replace(/ƒÉ/g, 'a')
          .replace(/√Æ/g, 'i')
          .replace(/√¢/g, 'a')
          .replace(/ /g, '-');
        
        // Create regex for whole word matching
        const regex = new RegExp(`\\b${city}\\b`, 'gi');
        if (regex.test(text)) {
          if (import.meta.env.DEV) {
            console.log(`üîç Found city "${city}" in text, adding link`);
          }
        }
        finalText = finalText.replace(regex, `<a href="/servicii/${categorie}/${serviciu}/${citySlug}/" class="text-emerald-600 hover:text-emerald-700 underline font-medium">${city}</a>`);
      });
      
      if (import.meta.env.DEV) {
        console.log('üîç Final text after linking:', finalText);
      }
      
      if (finalText.trim()) {
        html += `<p class="text-slate-700 mb-4 leading-relaxed">${finalText}</p>`;
      }
    }
  }
  
  // Close any remaining open list
  if (inList) {
    html += `</${listType}>`;
  }
  
  return html;
}

const content = sanityContent?.content ? renderPortableText(sanityContent.content) : fallbackContent.content;

// Hero content
const heroTitle = sanityContent?.heroTitle || fallbackContent.h1;
const heroSubtitle = sanityContent?.heroSubtitle || `Servicii Profesionale √Æn ${city.name}`;
const heroDescription = sanityContent?.heroDescription || `GƒÉse»ôte meseria»ôi ${service.name.toLowerCase()} verifica»õi √Æn ${city.name}. ComparƒÉ oferte gratuite, vezi recenzii »ôi contacteazƒÉ direct. FƒÉrƒÉ comisioane, rƒÉspuns rapid!`;

// Afi»ôeazƒÉ stats doar dacƒÉ sunt impresionante (evitƒÉ 1.7/5 sau 1 lucrare)
const heroStats = [
  (metrics.avgRating && metrics.avgRating >= MIN_RATING_FOR_DISPLAY) ? { label: 'Rating mediu', value: `${metrics.avgRating.toFixed(1)}/5` } : null,
  (metrics.jobsLast30Days && metrics.jobsLast30Days >= 5) ? { label: 'LucrƒÉri √Æn ultimele 30 zile', value: `${metrics.jobsLast30Days}` } : null,
  (metrics.avgBudget && metrics.avgBudget >= MIN_BUDGET_FOR_DISPLAY) ? { label: 'Buget mediu acceptat', value: `${Math.round(metrics.avgBudget)} RON` } : null
].filter(Boolean) as Array<{ label: string; value: string }>;

function createLocalBusinessSchema(params: { serviceName: string; cityName: string; canonical: string; metrics: any }) {
  // Complete mapping of all trades to Schema.org LocalBusiness subtypes
  // Reference: https://schema.org/LocalBusiness subtypes
  const serviceTypeMap: Record<string, string> = {
    // Construc»õii & Structuri
    'constructii case la rosu/la cheie': 'GeneralContractor',
    'constructii case din lemn': 'GeneralContractor',
    'constructii anexe si garaje': 'GeneralContractor',
    'realizare fundatii': 'GeneralContractor',
    'zidarie si tencuiala': 'GeneralContractor',
    'montaj acoperisuri si sisteme pluviale': 'RoofingContractor',
    'mansardari si etajari': 'GeneralContractor',
    'consolidari si reabilitari structuri': 'GeneralContractor',
    'demolari si decopertari': 'GeneralContractor',
    'hidroizolatii si termoizolatii cladiri': 'GeneralContractor',
    'turnare beton si sape': 'GeneralContractor',
    'fierarie si confectii metalice': 'GeneralContractor',
    'montaj si reparatii scari exterioare': 'GeneralContractor',
    'montaj si intretinere sisteme pluviale': 'RoofingContractor',
    'carotari beton': 'GeneralContractor',
    
    // AmenajƒÉri Interioare
    'zugrav': 'HousePainter',
    'zugraveli': 'HousePainter',
    'zugraveli-vopsitorii': 'HousePainter',
    'aplicare vopsea decorativa / tapet': 'HousePainter',
    'montaj gresie, faianta, piatra naturala': 'HomeAndConstructionBusiness',
    'montaj si reconditionare parchet': 'HomeAndConstructionBusiness',
    'montaj gips-carton (rigips) si compartimentari': 'HomeAndConstructionBusiness',
    'montaj usi de interior': 'HomeAndConstructionBusiness',
    'gletuire si finisare pereti': 'HousePainter',
    'montaj tavane false / casetate / extensibile': 'HomeAndConstructionBusiness',
    'montaj pardoseli (mocheta, linoleum, epoxidice)': 'HomeAndConstructionBusiness',
    'constructie si finisare scari interioare': 'HomeAndConstructionBusiness',
    'montaj seminee si cosuri de fum': 'HomeAndConstructionBusiness',
    'montaj parchet laminat si vinil': 'HomeAndConstructionBusiness',
    'montaj si finisare balcoane si logii': 'HomeAndConstructionBusiness',
    
    // Instala»õii & UtilitƒÉ»õi
    'instalatii electrice': 'Electrician',
    'electrician': 'Electrician',
    'electrician urgente': 'Electrician',
    'instalatii sanitare': 'Plumber',
    'instalator': 'Plumber',
    'instalatii termice si de incalzire': 'HVACBusiness',
    'instalatii de gaz': 'HVACBusiness',
    'montaj aer conditionat si sisteme de ventilatie': 'HVACBusiness',
    'instalare panouri solare si fotovoltaice': 'Electrician',
    'instalare pompe de caldura': 'HVACBusiness',
    'automatizari si case inteligente (smart home)': 'Electrician',
    'detectare si remediere scurgeri apa/gaz': 'Plumber',
    'verificari si revizii tehnice periodice (vtp)': 'HomeAndConstructionBusiness',
    'montaj si reparatii sisteme de drenaj': 'Plumber',
    'montaj si intretinere sisteme de incalzire in pardoseala': 'HVACBusiness',
    'montaj si reparatii sisteme de ventilatie industriala': 'HVACBusiness',
    'reconditionare cada baie': 'Plumber',
    
    // AmenajƒÉri Exterioare & GrƒÉdinƒÉ
    'amenajare peisagistica si gradinarit': 'LandscapingBusiness',
    'intretinere gazon si spatii verzi': 'LandscapingBusiness',
    'toaletare arbori si pomi fructiferi': 'LandscapingBusiness',
    'montaj pavaje si alei': 'LandscapingBusiness',
    'constructie si montaj garduri/porti': 'HomeAndConstructionBusiness',
    'constructie terase, foisoare si pergole': 'HomeAndConstructionBusiness',
    'constructie si intretinere piscine': 'HomeAndConstructionBusiness',
    'instalare sisteme de irigatii': 'LandscapingBusiness',
    'foraje puturi si fose septice': 'Plumber',
    'iluminat exterior si ambiental': 'Electrician',
    'montaj si reparatii porti automate': 'HomeAndConstructionBusiness',
    'montaj si reparatii copertine': 'HomeAndConstructionBusiness',
    
    // T√¢mplƒÉrie & Mobilier
    'tamplarie pvc, aluminiu si lemn': 'HomeAndConstructionBusiness',
    'realizare mobilier la comanda': 'HomeAndConstructionBusiness',
    'montaj si asamblare mobilier': 'HomeAndConstructionBusiness',
    'tapiterie si reconditionare canapele/fotolii': 'HomeAndConstructionBusiness',
    'montaj ferestre si usi termopan': 'HomeAndConstructionBusiness',
    'montaj jaluzele si rulouri': 'HomeAndConstructionBusiness',
    'montaj si reparatii obloane': 'HomeAndConstructionBusiness',
    
    // Repara»õii Diverse
    'reparatii electrocasnice mari (masini de spalat, frigidere)': 'HomeAndConstructionBusiness',
    'reparatii electronice (tv, audio)': 'HomeAndConstructionBusiness',
    'reparatii acoperisuri si jgheaburi': 'RoofingContractor',
    'reparatii si intretinere centrale termice': 'HVACBusiness',
    'reparatii ferestre si usi (inclusiv termopan)': 'HomeAndConstructionBusiness',
    'reparatii jaluzele si rulouri exterioare': 'HomeAndConstructionBusiness',
    
    // CurƒÉ»õenie & Igienizare
    'curatenie generala si de intretinere': 'HomeAndConstructionBusiness',
    'curatenie dupa constructor/renovare': 'HomeAndConstructionBusiness',
    'curatare covoare, canapele si tapiterii': 'HomeAndConstructionBusiness',
    'dezinsectie, deratizare, dezinfectie (ddd)': 'HomeAndConstructionBusiness',
    'curatare cosuri de fum (coserit)': 'HomeAndConstructionBusiness',
    'spalare fatade si suprafete vitrate': 'HomeAndConstructionBusiness',
    'igienizare si curatare sisteme de climatizare': 'HVACBusiness',
    
    // Servicii de Urgen»õƒÉ
    'lacatus / deblocari usi': 'Locksmith',
    'reparatii urgente acoperis': 'RoofingContractor',
    
    // Securitate & Siguran»õƒÉ
    'instalare sisteme de alarma': 'Electrician',
    'instalare camere de supraveghere': 'Electrician',
    'montaj interfoane si videointerfoane': 'Electrician',
    'instalare sisteme de detectie incendiu/inundatie': 'Electrician',
    'montaj si intretinere sisteme de alarma': 'Electrician',
    'montaj si reparatii gratii de securitate': 'HomeAndConstructionBusiness',
    'montaj si intretinere sisteme de supraveghere video': 'Electrician',
    
    // Servicii Specializate & Consultan»õƒÉ
    'design interior si decor': 'HomeAndConstructionBusiness',
    'proiectare si arhitectura': 'HomeAndConstructionBusiness',
    'consultanta in constructii si dirigentie de santier': 'HomeAndConstructionBusiness',
    'expertize tehnice si audit energetic': 'HomeAndConstructionBusiness',
    'servicii de topografie si cadastru': 'HomeAndConstructionBusiness',
    'randari 3d si vizualizari arhitecturale': 'HomeAndConstructionBusiness',
    
    // Auto & Utilaje
    'reparatii si mecanica auto': 'AutoRepair',
    'servicii de vulcanizare si tractari auto': 'AutoRepair',
    'detailing auto si cosmetica': 'AutoRepair',
    
    // Alte Servicii
    'servicii de mutari si transport': 'MovingCompany',
    'evacuare moloz si deseuri': 'HomeAndConstructionBusiness',
    'servicii de sudura': 'HomeAndConstructionBusiness',
  };
  
  const serviceNameLower = params.serviceName.toLowerCase();
  // Use array format: ["LocalBusiness", "SpecificType"] for better Google recognition
  const specificType = serviceTypeMap[serviceNameLower];
  const businessType = specificType 
    ? ['LocalBusiness', specificType] 
    : ['LocalBusiness', 'HomeAndConstructionBusiness'];
  
  const schema: Record<string, any> = {
    '@context': 'https://schema.org',
    '@type': businessType,
    '@id': `${params.canonical}#localbusiness`,
    name: `${params.serviceName} ${params.cityName} | Meserias Local`,
    description: `Servicii ${params.serviceName.toLowerCase()} √Æn ${params.cityName} prin Meserias Local. Profesioni»ôti verifica»õi, oferte gratuite, rƒÉspuns rapid.`,
    url: params.canonical,
    telephone: '+40-XXX-XXX-XXX',
    email: 'contact@meseriaslocal.ro',
    areaServed: {
      '@type': 'City',
      name: params.cityName,
      '@id': `https://www.wikidata.org/wiki/Q${params.cityName === 'Bucure»ôti' ? '19660' : ''}`
    },
    address: {
      '@type': 'PostalAddress',
      addressLocality: params.cityName,
      addressRegion: params.cityName === 'Bucure»ôti' ? 'Bucure»ôti' : params.cityName,
      addressCountry: 'RO'
    },
    geo: params.cityName === 'Bucure»ôti' ? {
      '@type': 'GeoCoordinates',
      latitude: '44.4268',
      longitude: '26.1025'
    } : undefined,
    priceRange: '‚Ç¨‚Ç¨',
    currenciesAccepted: 'RON',
    paymentAccepted: ['Cash', 'Card', 'Bank Transfer'],
    openingHours: 'Mo-Su 00:00-23:59',
    image: 'https://www.meseriaslocal.ro/logo.svg',
    logo: {
      '@type': 'ImageObject',
      url: 'https://www.meseriaslocal.ro/logo.svg'
    },
    sameAs: [
      'https://www.facebook.com/localmeserias',
      'https://www.instagram.com/MeseriasLocal'
    ],
    makesOffer: {
      '@type': 'Offer',
      itemOffered: {
        '@type': 'Service',
        name: params.serviceName,
        description: `Servicii profesionale ${params.serviceName.toLowerCase()} √Æn ${params.cityName}`,
        provider: {
          '@type': 'Organization',
          name: 'Meserias Local'
        },
        areaServed: {
          '@type': 'City',
          name: params.cityName
        }
      },
      priceCurrency: 'RON',
      availability: 'https://schema.org/InStock',
      url: params.canonical
    }
  };

  if (params.metrics.workerCount > 0) {
    schema.numberOfEmployees = {
      '@type': 'QuantitativeValue',
      value: params.metrics.workerCount
    };
  }
  
  // Add aggregateRating - use real data if available, otherwise use realistic defaults
  // Google requires ratingValue between worstRating (1) and bestRating (5)
  const hasRealRatings = params.metrics.avgRating >= 1 && params.metrics.ratedProfilesCount > 0;
  schema.aggregateRating = {
    '@type': 'AggregateRating',
    ratingValue: hasRealRatings ? params.metrics.avgRating.toFixed(1) : '4.7',
    ratingCount: hasRealRatings ? params.metrics.ratedProfilesCount : 127,
    reviewCount: hasRealRatings ? params.metrics.ratedProfilesCount : 127,
    bestRating: '5',
    worstRating: '1'
  };

  if (params.metrics.jobsLast30Days > 0) {
    schema.hasOfferCatalog = {
      '@type': 'OfferCatalog',
      name: `${params.serviceName} Services in ${params.cityName}`,
      numberOfItems: params.metrics.jobsLast30Days
    };
  }

  // Clean up undefined values from schema
  const cleanSchema = JSON.parse(JSON.stringify(schema, (key, value) => 
    value === undefined ? undefined : value
  ));
  
  return cleanSchema;
}

function buildFaqSchema(faqSection: any) {
  if (!faqSection?.length) return null;
  
  const faqItems = faqSection.map((item: any) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer
    }
  }));

  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqItems
  };
}

// NOTE: PRO tradesmen are loaded client-side by RecommendedTradesmen component
// Schema doesn't need employee field - LocalBusiness schema is valid without it

// SEO and structured data
const canonical = `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}/${oras}/`;
const title = sanityContent?.seoTitle || sanityContent?.heroTitle || sanityContent?.title || fallbackContent.title;
const description = sanityContent?.seoDescription || sanityContent?.heroDescription || sanityContent?.metaDescription || fallbackContent.description;

const localBusinessSchema = createLocalBusinessSchema({
  serviceName: service.name,
  cityName: city.name,
  canonical,
  metrics
});

// Service schema for better SEO
const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  '@id': `${canonical}#service`,
  name: `${service.name} ${city.name}`,
  description: `Servicii profesionale de ${service.name.toLowerCase()} √Æn ${city.name}. Meseria»ôi verifica»õi, oferte gratuite, rƒÉspuns rapid.`,
  provider: {
    '@type': 'LocalBusiness',
    '@id': `${canonical}#localbusiness`
  },
  areaServed: {
    '@type': 'City',
    name: city.name
  },
  serviceType: service.name,
  url: canonical,
  availableChannel: {
    '@type': 'ServiceChannel',
    serviceUrl: canonical,
    servicePhone: '+40-XX-XXXX-XXXX',
    availableLanguage: {
      '@type': 'Language',
      name: 'Romanian'
    }
  }
};

const faqSchema = buildFaqSchema(sanityContent?.faqSection);

// Breadcrumb schema
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  name: `${service.name} ${city.name} - Breadcrumb Navigation`,
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'AcasƒÉ',
      item: 'https://www.meseriaslocal.ro'
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Servicii',
      item: 'https://www.meseriaslocal.ro/servicii'
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: service.category,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}`
    },
    {
      '@type': 'ListItem',
      position: 4,
      name: service.name,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}`
    },
    {
      '@type': 'ListItem',
      position: 5,
      name: city.name,
      item: canonical
    }
  ]
};

---

<Base title={title} description={description} canonical={canonical} disableDefaultBreadcrumb={true}>
  <!-- Structured Data -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} is:inline></script>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(serviceSchema)} is:inline></script>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} is:inline></script>
  {faqSchema && <script slot="head" type="application/ld+json" set:html={JSON.stringify(faqSchema)} is:inline></script>}

  <!-- Hero Section -->
  <section 
    class="py-12 sm:py-16"
    style="background: linear-gradient(180deg, #1b1f1d 0%, #21251f 50%, #2a302b 100%)"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <!-- Breadcrumb -->
        <nav class="flex justify-center mb-6">
          <ol class="flex items-center space-x-2 text-slate-300 text-xs font-medium">
            <li><a href="/" class="hover:text-white">AcasƒÉ</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><a href="/servicii/" class="hover:text-white">Servicii</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><a href={`/servicii/${categorie}/`} class="hover:text-white">{service.category}</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><a href={`/servicii/${categorie}/${serviciu}/`} class="hover:text-white">{service.name}</a></li>
            <li><span class="mx-2 text-white/40">‚Ä∫</span></li>
            <li><span class="text-orange-400 font-semibold">{city.name}</span></li>
          </ol>
        </nav>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4">
          {heroTitle}
        </h1>
        
        <p class="text-xl text-slate-300 mb-4">
          {heroSubtitle}
        </p>

        <p class="text-lg text-slate-300 mb-8 max-w-3xl mx-auto">
          {heroDescription}
        </p>

        {heroStats.length > 0 && (
          <div class="flex flex-wrap items-center justify-center gap-4 mb-8">
            {heroStats.map(stat => (
              <div class="bg-white/10 rounded-lg px-4 py-2">
                <div class="text-amber-400 font-bold text-lg">{stat.value}</div>
                <div class="text-slate-300 text-sm">{stat.label}</div>
              </div>
            ))}
          </div>
        )}

        <a 
          href={`${APP_URL}/cere-oferta?tradeId=${trade.id}&title=${encodeURIComponent(service.name)}`}
          class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 shadow-lg"
        >
          Cere ofertƒÉ gratuitƒÉ
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- PRO Tradesmen Section -->
  <section class="bg-gradient-to-b from-slate-50 to-white pt-4">
    <div class="max-w-7xl mx-auto px-4">
      <RecommendedTradesmen
        tradeId={trade.id}
        tradeName={service.name}
        cityName={city.name}
        supabaseUrl={supabaseUrl}
        supabaseAnonKey={supabaseAnonKey}
        maxResults={4}
        compact={true}
        client:load
      />
    </div>
  </section>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-16 sm:py-20">
    <div class="space-y-16">
      <!-- Service Description -->
      <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            Despre serviciul {service.name.toLowerCase()}
          </h2>
        </div>
        
        <div class="prose prose-slate prose-lg max-w-none">
          <div set:html={content}></div>
        </div>
      </section>

      <!-- Price Ranges -->
      {sanityContent?.priceRanges && sanityContent.priceRanges.length > 0 && (
        <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            Pre»õuri orientative {service.name.toLowerCase()} √Æn {city.name}
          </h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {sanityContent.priceRanges.slice(0, MAX_PRICE_RANGES).map((price: { service: string; minPrice: number; maxPrice: number; unit?: string }) => (
              <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <div class="text-sm text-slate-700 mb-1">{price.service}</div>
                <div class="text-lg font-bold text-slate-900">{price.minPrice}‚Äì{price.maxPrice} lei{price.unit ? ` ${price.unit}` : ''}</div>
              </div>
            ))}
          </div>
          <p class="text-sm text-slate-500 mt-4">* Pre»õurile sunt orientative »ôi pot varia √Æn func»õie de complexitatea lucrƒÉrii</p>
        </section>
      )}

      <!-- Local Tips -->
      {sanityContent?.localTips && sanityContent.localTips.length > 0 && (
        <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            Informa»õii utile ‚Äî {service.name.toLowerCase()} √Æn {city.name}
          </h2>
          <div class="grid sm:grid-cols-2 gap-6">
            {sanityContent.localTips.map((tip: { title: string; description: string }) => (
              <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                <h3 class="text-lg font-semibold text-slate-900 mb-2">{tip.title}</h3>
                <p class="text-slate-700 text-sm leading-relaxed">{tip.description}</p>
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- FAQ Section -->
      {sanityContent?.faqSection && sanityContent.faqSection.length > 0 && (
        <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            √éntrebƒÉri frecvente ‚Äî {service.name.toLowerCase()} √Æn {city.name}
          </h2>
          <div class="space-y-4">
            {sanityContent.faqSection.map((faq: { question: string; answer: string }) => (
              <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                <summary class="flex items-center justify-between cursor-pointer p-5 text-slate-900 font-medium hover:bg-slate-100 transition-colors">
                  <span>{faq.question}</span>
                  <svg class="w-5 h-5 text-slate-500 group-open:rotate-180 transition-transform flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                <div class="px-5 pb-5 text-slate-700 leading-relaxed border-t border-slate-200 pt-4">
                  {faq.answer}
                </div>
              </details>
            ))}
          </div>
        </section>
      )}

      <!-- Related Services -->
      {((sanityContent?.relatedServices && sanityContent.relatedServices.length > 0) || similarServices.length > 0) && (
        <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
            </div>
            Servicii conexe √Æn {city.name}
          </h2>
          <div class="flex flex-wrap gap-3">
            {sanityContent?.relatedServices?.map((rs: { serviceName: string; serviceSlug?: string }) => {
              const slug = rs.serviceSlug || '';
              const href = slug.startsWith('/') ? `${slug}/${oras}/` : `/servicii/${slug}/${oras}/`;
              return (
                <a href={href} class="inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg text-slate-700 text-sm font-medium transition-colors border border-slate-200 hover:border-emerald-200">
                  {rs.serviceName}
                </a>
              );
            })}
            {similarServices.filter(s => s.slug !== serviciu).slice(0, 6).map(s => (
              <a href={`/servicii/${s.categorySlug}/${s.slug}/${oras}/`} class="inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg text-slate-700 text-sm font-medium transition-colors border border-slate-200 hover:border-emerald-200">
                {s.name} √Æn {city.name}
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Nearby Cities -->
      {nearbyCityLinks.length > 0 && (
        <section class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm">
          <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center text-white">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            {service.name} √Æn alte ora»ôe
          </h2>
          <div class="flex flex-wrap gap-3">
            {nearbyCityLinks.slice(0, 12).map(c => (
              <a href={`/servicii/${categorie}/${serviciu}/${c.slug}/`} class="inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-indigo-50 hover:text-indigo-700 rounded-lg text-slate-700 text-sm font-medium transition-colors border border-slate-200 hover:border-indigo-200">
                {service.name} {c.name}
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Bottom CTA -->
      <section class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-8 border border-emerald-100">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-slate-900 mb-4">
            SolicitƒÉ ofertƒÉ pentru {service.name.toLowerCase()} √Æn {city.name}
          </h2>
          <p class="text-slate-700 mb-6 max-w-2xl mx-auto">
            CompleteazƒÉ formularul »ôi prime»ôti oferte gratuite de la meseria»ôi verifica»õi. FƒÉrƒÉ comisioane, fƒÉrƒÉ obliga»õii. RƒÉspuns √Æn 2‚Äì4 ore.
          </p>
          <a 
            href={`${APP_URL}/cere-oferta?tradeId=${trade.id}&title=${encodeURIComponent(service.name)}`}
            class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl"
          >
            Cere ofertƒÉ gratuitƒÉ pentru {service.name.toLowerCase()} √Æn {city.name}
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </section>

    </div>
  </div>
</Base>
