---
import Base from '../../../../../layouts/Base.astro';
import { cities, getCityBySlug, getNearbyCities } from '../../../../../data';
import { getServiceCityPage } from '../../../../../lib/sanity';
import { supabase } from '../../../../../lib/supabase';
import { generateFallbackContent } from '../../../../../lib/seo-fallback';

export const prerender = false;
export const config = { revalidate: 3600 };

const { categorie, serviciu, oras } = Astro.params;

// Validate required params
if (!categorie || !serviciu || !oras) {
  return Astro.redirect('/404');
}

if (!supabase) {
  if (import.meta.env.DEV) {
    console.warn('Supabase client unavailable when rendering service city page');
  }
  return Astro.redirect('/servicii', 500);
}

const { data: trade, error: tradeError } = await supabase
  .from('trades')
  .select('id, name, slug, category')
  .eq('slug', serviciu)
  .single();

if (tradeError || !trade) {
  return Astro.redirect('/404');
}

// APP_URL points to Remix app for login/register/dashboard
const APP_URL = 'https://app.meseriaslocal.ro';

const city = getCityBySlug(oras);

if (!trade || !city) {
  return Astro.redirect('/404');
}

const service = {
  name: trade.name,
  slug: trade.slug,
  category: trade.category,
  categorySlug: categorie,
};

// Try to get custom content from Sanity
const sanityContent = await getServiceCityPage(serviciu, oras);

// Debug logging
if (import.meta.env.DEV) {
  console.log('ðŸ” Sanity Query Debug:');
  console.log('  tradeSlug:', serviciu);
  console.log('  citySlug:', oras);
  console.log('  Found content:', sanityContent ? 'âœ… YES' : 'âŒ NO');
  if (sanityContent) {
    console.log('  Title:', sanityContent.title);
    console.log('  Has content:', !!sanityContent.content);
  }
}

const nearbyCities = getNearbyCities(oras);
const nearbyCityLinks = nearbyCities.length > 0
  ? nearbyCities
  : cities.filter(c => c.slug !== city.slug).slice(0, 4);

// Get similar services from Supabase
let allTrades = null;
if (supabase) {
  const result = await supabase
    .from('trades')
    .select('id, name, slug, category')
    .eq('category', trade.category)
    .neq('slug', trade.slug)
    .limit(4);
  allTrades = result.data;
}

const similarServices = (allTrades || []).map(t => ({
  name: t.name,
  slug: t.slug,
  categorySlug: categorie,
}));

// Pre-fetch all related service categories if we have Sanity content
let relatedServiceCategories: Record<string, string> = {};
if (sanityContent?.relatedServices && sanityContent.relatedServices.length > 0 && supabase) {
  const slugs = sanityContent.relatedServices.map((rs: any) => {
    let cleanSlug = rs.serviceSlug.replace(/^\/+|\/+$/g, '');
    if (cleanSlug.includes('/')) {
      const parts = cleanSlug.split('/');
      cleanSlug = parts[parts.length - 1];
    }
    return cleanSlug;
  });
  
  const { data: relatedTrades } = await supabase
    .from('trades')
    .select('slug, category')
    .in('slug', slugs);
  
  if (relatedTrades) {
    relatedTrades.forEach(t => {
      relatedServiceCategories[t.slug] = t.category;
    });
  }
}

// Generate comprehensive fallback content
const fallbackContent = generateFallbackContent({
  serviceName: service.name,
  cityName: city.name,
  categoryName: trade.category || 'Servicii',
  serviceSlug: serviciu,
  citySlug: oras,
  categorySlug: categorie,
  relatedServices: similarServices,
  relatedCities: nearbyCityLinks
});

// SEO Meta Data - use Sanity content if available, otherwise use fallback
const title = sanityContent?.title || sanityContent?.heroTitle || fallbackContent.metaTitle;
const description = sanityContent?.metaDescription || sanityContent?.heroDescription || fallbackContent.metaDescription;
const keywords = sanityContent?.seoKeywords?.join(', ') || `${service.name.toLowerCase()} ${city.name.toLowerCase()}, meseriasi ${service.name.toLowerCase()} ${city.name.toLowerCase()}, servicii ${service.name.toLowerCase()} ${city.name.toLowerCase()}, pret ${service.name.toLowerCase()} ${city.name.toLowerCase()}`;
const canonical = fallbackContent.canonical;

// Default content if no Sanity override - use SEO-optimized fallback
const defaultContent = fallbackContent.fallbackHtml;

// Helper to render portable text with support for links and marks
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  
  // Track marks that are links
  const markDefs = blocks.reduce((acc: any, block: any) => {
    if (block.markDefs) {
      block.markDefs.forEach((def: any) => {
        acc[def._key] = def;
      });
    }
    return acc;
  }, {});
  
  return blocks.map((block: any) => {
    if (block._type === 'block') {
      const children = block.children?.map((child: any) => {
        let text = child.text || '';
        
        // Process marks (bold, italic, links, etc.)
        if (child.marks && child.marks.length > 0) {
          child.marks.forEach((mark: string) => {
            // Check if it's a link mark
            if (markDefs[mark]) {
              const linkDef = markDefs[mark];
              if (linkDef._type === 'link') {
                const href = linkDef.href || '';
                const target = href.startsWith('http') ? ' target="_blank" rel="noopener noreferrer"' : '';
                text = `<a href="${href}"${target} class="text-blue-600 hover:text-blue-700 underline">${text}</a>`;
              }
            }
            // Standard marks
            else if (mark === 'strong') {
              text = `<strong>${text}</strong>`;
            } else if (mark === 'em') {
              text = `<em>${text}</em>`;
            } else if (mark === 'underline') {
              text = `<u>${text}</u>`;
            } else if (mark === 'code') {
              text = `<code class="bg-slate-100 px-1 py-0.5 rounded text-sm">${text}</code>`;
            }
          });
        }
        
        return text;
      }).join('') || '';
      
      // Handle different block styles
      if (block.style === 'h2') return `<h2 class="text-2xl font-bold text-slate-900 mt-8 mb-4">${children}</h2>`;
      if (block.style === 'h3') return `<h3 class="text-xl font-semibold text-slate-900 mt-6 mb-3">${children}</h3>`;
      if (block.style === 'h4') return `<h4 class="text-lg font-semibold text-slate-900 mt-4 mb-2">${children}</h4>`;
      if (block.listItem === 'bullet') return `<li class="ml-4 mb-2">${children}</li>`;
      if (block.listItem === 'number') return `<li class="ml-4 mb-2">${children}</li>`;
      if (block.style === 'blockquote') return `<blockquote class="border-l-4 border-blue-500 pl-4 italic text-slate-700 my-4">${children}</blockquote>`;
      
      return `<p class="text-slate-700 leading-relaxed mb-4">${children}</p>`;
    }
    return '';
  }).join('');
}

interface ServiceMetrics {
  workerCount: number;
  verifiedCount: number;
  avgRating: number | null;
  jobsLast30Days: number;
  avgBudget: number | null;
}

const METRICS_DEFAULT: ServiceMetrics = {
  workerCount: 0,
  verifiedCount: 0,
  avgRating: null,
  jobsLast30Days: 0,
  avgBudget: null
};

function chunkArray<T>(items: T[], size: number): T[][] {
  if (size <= 0) return [items];
  const chunks: T[][] = [];
  for (let i = 0; i < items.length; i += size) {
    chunks.push(items.slice(i, i + size));
  }
  return chunks;
}

async function fetchServiceMetrics(params: { tradeId: number; serviceName: string; cityName: string }): Promise<ServiceMetrics> {
  if (!supabase) return METRICS_DEFAULT;
  const metrics: ServiceMetrics = { ...METRICS_DEFAULT };
  const cityNeedle = params.cityName.toLowerCase();

  try {
    const { data: workerTradeRows, error: workerTradesError } = await supabase
      .from('worker_trades')
      .select('profile_id')
      .contains('trade_ids', [params.tradeId]);

    if (!workerTradesError && workerTradeRows && workerTradeRows.length > 0) {
      const workerIds = workerTradeRows.map(row => row.profile_id);
      const chunks = chunkArray(workerIds, 60);
      let matchedProfiles: Array<{ rating: number | null; is_verified: boolean | null; address: string | null }> = [];

      for (const chunk of chunks) {
        if (chunk.length === 0) continue;
        const { data: profileChunk, error: profileError } = await supabase
          .from('profiles')
          .select('id, rating, is_verified, address')
          .in('id', chunk)
          .eq('role', 'worker');

        if (profileError || !profileChunk) continue;

        matchedProfiles = matchedProfiles.concat(
          profileChunk.filter(profile => (profile.address || '').toLowerCase().includes(cityNeedle))
        );
      }

      metrics.workerCount = matchedProfiles.length;
      metrics.verifiedCount = matchedProfiles.filter(profile => profile.is_verified).length;
      const ratedProfiles = matchedProfiles.filter(profile => typeof profile.rating === 'number');
      if (ratedProfiles.length > 0) {
        const totalRating = ratedProfiles.reduce((sum, profile) => sum + (profile.rating || 0), 0);
        metrics.avgRating = totalRating / ratedProfiles.length;
      }
    }

    const createdAfter = new Date();
    createdAfter.setDate(createdAfter.getDate() - 30);

    const { data: jobRows, error: jobsError } = await supabase
      .from('jobs')
      .select('id, budget, address, tradeType, created_at')
      .gte('created_at', createdAfter.toISOString())
      .limit(500);

    if (!jobsError && jobRows) {
      const tradeNeedle = params.serviceName.toLowerCase();
      const filteredJobs = jobRows.filter(job => {
        const tradeMatch = job.tradeType ? job.tradeType.toLowerCase().includes(tradeNeedle) : false;
        const cityMatch = job.address ? job.address.toLowerCase().includes(cityNeedle) : false;
        return tradeMatch && cityMatch;
      });

      metrics.jobsLast30Days = filteredJobs.length;
      const budgets = filteredJobs
        .map(job => job.budget)
        .filter((value): value is number => typeof value === 'number' && value > 0);
      if (budgets.length > 0) {
        metrics.avgBudget = budgets.reduce((sum, value) => sum + value, 0) / budgets.length;
      }
    }
  } catch (error) {
    console.error('Failed to compute service metrics', error);
  }

  return metrics;
}

function createLocalBusinessSchema(params: { serviceName: string; cityName: string; canonical: string; metrics: ServiceMetrics }) {
  const schema: Record<string, any> = {
    '@context': 'https://schema.org',
    '@type': 'LocalBusiness',
    name: `${params.serviceName} ${params.cityName} | Meserias Local`,
    serviceType: params.serviceName,
    url: params.canonical,
    areaServed: {
      '@type': 'Place',
      name: params.cityName
    },
    address: {
      '@type': 'PostalAddress',
      addressLocality: params.cityName,
      addressCountry: 'RO'
    }
  };

  if (params.metrics.workerCount) {
    schema.numberOfEmployees = params.metrics.workerCount;
  }

  if (params.metrics.avgRating && params.metrics.workerCount >= 3) {
    schema.aggregateRating = {
      '@type': 'AggregateRating',
      ratingValue: params.metrics.avgRating.toFixed(1),
      reviewCount: Math.max(params.metrics.workerCount, params.metrics.verifiedCount || 1)
    };
  }

  if (params.metrics.avgBudget) {
    schema.offers = {
      '@type': 'Offer',
      priceCurrency: 'RON',
      price: Math.round(params.metrics.avgBudget),
      availability: 'https://schema.org/InStock'
    };
  }

  return schema;
}

function buildFaqSchema(faqItems?: Array<{ question: string; answer: string }>) {
  if (!faqItems || faqItems.length === 0) return null;
  return {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faqItems.map(item => ({
      '@type': 'Question',
      name: item.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: item.answer
      }
    }))
  };
}

function buildOfferCatalogSchema(priceRanges?: Array<{ service: string; minPrice: number; maxPrice: number }>, serviceName?: string, cityName?: string) {
  if (!priceRanges || priceRanges.length === 0 || !serviceName || !cityName) return null;
  return {
    '@context': 'https://schema.org',
    '@type': 'OfferCatalog',
    name: `${serviceName} ${cityName} - Tarife`,
    itemListElement: priceRanges.map(price => ({
      '@type': 'Offer',
      name: price.service,
      priceCurrency: 'RON',
      priceSpecification: {
        '@type': 'PriceSpecification',
        priceCurrency: 'RON',
        minPrice: price.minPrice,
        maxPrice: price.maxPrice
      },
      areaServed: cityName
    }))
  };
}

const content = sanityContent?.content ? renderPortableText(sanityContent.content) : defaultContent;

// Hero content
const heroTitle = sanityContent?.heroTitle || fallbackContent.h1;
const heroSubtitle = sanityContent?.heroSubtitle || `Servicii Profesionale Ã®n ${city.name}`;
const heroDescription = sanityContent?.heroDescription || `GÄƒseÈ™te meseriaÈ™i ${service.name.toLowerCase()} verificaÈ›i Ã®n ${city.name}. ComparÄƒ oferte gratuite, vezi recenzii È™i contacteazÄƒ direct. FÄƒrÄƒ comisioane, rÄƒspuns rapid!`;

const metrics = await fetchServiceMetrics({
  tradeId: trade.id,
  serviceName: service.name,
  cityName: city.name
});

const heroStats = [
  metrics.workerCount ? { label: 'MeseriaÈ™i verificaÈ›i', value: `${metrics.workerCount}+` } : null,
  metrics.avgRating ? { label: 'Rating mediu', value: `${metrics.avgRating.toFixed(1)}/5` } : null,
  metrics.jobsLast30Days ? { label: 'LucrÄƒri Ã®n ultimele 30 zile', value: `${metrics.jobsLast30Days}` } : null,
  metrics.avgBudget ? { label: 'Buget mediu acceptat', value: `${Math.round(metrics.avgBudget)} RON` } : null
].filter(Boolean) as Array<{ label: string; value: string }>;

const localBusinessSchema = sanityContent?.schema || createLocalBusinessSchema({
  serviceName: service.name,
  cityName: city.name,
  canonical,
  metrics
});

const faqSchema = buildFaqSchema(sanityContent?.faqSection);
const offerCatalogSchema = buildOfferCatalogSchema(sanityContent?.priceRanges, service.name, city.name);
const priceSummaryText = metrics.avgBudget
  ? `Bugetele acceptate Ã®n ultimele 30 de zile au avut o medie de ${Math.round(metrics.avgBudget)} RON.`
  : 'SolicitÄƒ o ofertÄƒ personalizatÄƒ pentru a primi preÈ›uri exacte.';
---

<Base title={title} description={description} canonical={canonical} disableDefaultBreadcrumb={true}>
  <!-- SEO Keywords -->
  <meta slot="head" name="keywords" content={keywords} />
  
  <!-- Structured Data - LocalBusiness Schema -->
  <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} />
  {faqSchema && (
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  )}
  {offerCatalogSchema && (
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(offerCatalogSchema)} />
  )}
  
  <!-- Structured Data - Breadcrumb Schema -->
  <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      {
        '@type': 'ListItem',
        position: 1,
        name: 'AcasÄƒ',
        item: 'https://www.meseriaslocal.ro'
      },
      {
        '@type': 'ListItem',
        position: 2,
        name: 'Servicii',
        item: 'https://www.meseriaslocal.ro/servicii'
      },
      {
        '@type': 'ListItem',
        position: 3,
        name: service.name,
        item: `https://www.meseriaslocal.ro/servicii/${categorie}/${serviciu}/`
      },
      {
        '@type': 'ListItem',
        position: 4,
        name: city.name
      }
    ]
  })} />

  <!-- Modern Hero Section - Same colors as homepage -->
  <section 
    class="relative overflow-hidden py-16 lg:py-20"
    style="background: linear-gradient(180deg, #1b1f1d 0%, #21251f 50%, #2a302b 100%)"
  >
    <!-- Grid pattern -->
    <div class="absolute inset-0 opacity-15">
      <div
        class="absolute inset-0"
        style="background-image: linear-gradient(rgba(45, 51, 45, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(45, 51, 45, 0.4) 1px, transparent 1px); background-size: 60px 60px"
      ></div>
    </div>

    <!-- Floating geometric shapes -->
    <div class="absolute inset-0 opacity-15">
      <div class="absolute top-24 left-40 w-14 h-14 border-2 border-blue-400/30 rounded-full animate-pulse" style="animation-delay: 0.5s"></div>
      <div class="absolute top-48 left-20 w-10 h-10 bg-emerald-400/15 rounded-full animate-bounce" style="animation-delay: 1s"></div>
      <div class="absolute top-20 right-28 w-16 h-16 border-2 border-purple-400/30 rounded-full animate-pulse" style="animation-delay: 1.5s"></div>
      <div class="absolute top-52 right-16 w-12 h-12 bg-blue-400/15 rounded-full animate-bounce" style="animation-delay: 2s"></div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto">
        <!-- Breadcrumbs - Subtle & Clean (like Remix) -->
        <nav class="flex justify-center mb-6">
          <div class="bg-slate-800/40 backdrop-blur-md rounded-full px-4 py-2 border border-slate-700/50">
            <ol class="flex items-center space-x-2 text-slate-300 text-xs font-medium">
              <li class="flex items-center">
                <a href="/" class="hover:text-white transition-colors">AcasÄƒ</a>
              </li>
              
              <!-- Hide middle items on mobile, show on sm+ -->
              <li class="hidden sm:flex items-center">
                <span class="mx-2 text-white/40">â€º</span>
                <a href="/servicii/" class="hover:text-white transition-colors">Servicii</a>
              </li>
              
              <li class="hidden md:flex items-center">
                <span class="mx-2 text-white/40">â€º</span>
                <a href={`/servicii/${categorie}/${serviciu}/`} class="hover:text-white transition-colors truncate max-w-[150px]">{service.name}</a>
              </li>
              
              <!-- Show ellipsis on mobile/tablet when items are hidden -->
              <li class="sm:hidden flex items-center">
                <span class="mx-2 text-white/40">â€º</span>
                <span class="text-slate-400">...</span>
              </li>
              
              <li class="flex items-center">
                <span class="mx-2 text-white/40">â€º</span>
                <span class="text-orange-400 font-semibold">{city.name}</span>
              </li>
            </ol>
          </div>
        </nav>

        <!-- Hero Content -->
        <div class="text-center lg:text-left">
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight">
            {heroTitle}
          </h1>
          
          <p class="text-xl text-slate-300 mb-4">
            {heroSubtitle}
          </p>
          
          <p class="text-lg text-slate-300 mb-8 leading-relaxed">
            {heroDescription}
          </p>

          <!-- CTA Buttons -->
          <div class="flex flex-wrap items-center justify-center lg:justify-start gap-4">
            <a
              href={`${APP_URL}/cere-oferta`}
              class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
            >
              Cere OfertÄƒ GratuitÄƒ
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </a>
            <div class="flex items-center gap-2 text-slate-400 text-sm">
              <div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-full bg-green-500/20 border border-green-400/30">
                <span class="text-green-300 text-xs font-medium">RÄƒspuns rapid</span>
              </div>
              <div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-full bg-blue-500/20 border border-blue-400/30">
                <span class="text-blue-300 text-xs font-medium">100% gratuit</span>
              </div>
            </div>
          </div>

          {heroStats.length > 0 && (
            <div class="mt-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              {heroStats.map((stat) => (
                <div class="bg-white/10 border border-white/20 rounded-2xl px-4 py-5 shadow-sm text-center">
                  <p class="text-2xl font-bold text-white">{stat.value}</p>
                  <p class="text-sm text-slate-200 mt-1">{stat.label}</p>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Secondary headline when fallback content is used -->
    {!sanityContent && (
      <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-8">{fallbackContent.h1}</h2>
    )}
    
    <div class="prose prose-lg max-w-none mb-12" set:html={content} />
    
    <!-- Price Ranges -->
    {sanityContent?.priceRanges && sanityContent.priceRanges.length > 0 ? (
      <section id="preturi" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">PreÈ›uri orientative Ã®n {city.name}</h2>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Serviciu</th>
                <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">PreÈ›</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {sanityContent.priceRanges.map((price: { service: string; minPrice: number; maxPrice: number }) => (
                <tr>
                  <td class="px-6 py-4 text-sm text-gray-700">{price.service}</td>
                  <td class="px-6 py-4 text-sm text-gray-900 font-semibold text-right">
                    {price.minPrice} - {price.maxPrice} RON
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <p class="text-sm text-gray-500 mt-4">
          * PreÈ›urile sunt orientative È™i pot varia Ã®n funcÈ›ie de complexitatea proiectului
        </p>
      </section>
    ) : (
      metrics.avgBudget && (
        <section id="preturi" class="mb-12">
          <h2 class="text-2xl font-bold mb-4">Tarif mediu estimat Ã®n {city.name}</h2>
          <p class="text-gray-700">{priceSummaryText}</p>
        </section>
      )
    )}
    
    <!-- Local Tips -->
    {sanityContent?.localTips && sanityContent.localTips.length > 0 && (
      <section id="sfaturi-locale" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Sfaturi locale pentru {city.name}</h2>
        <div class="space-y-4">
          {sanityContent.localTips.map((tip: { title: string; description: string }) => (
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">{tip.title}</h3>
              <p class="text-gray-700">{tip.description}</p>
            </div>
          ))}
        </div>
      </section>
    )}
    
    <!-- FAQ -->
    {sanityContent?.faqSection && sanityContent.faqSection.length > 0 && (
      <section id="intrebari-frecvente" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">ÃŽntrebÄƒri Frecvente</h2>
        <div class="space-y-4">
          {sanityContent.faqSection.map((item: { question: string; answer: string }) => (
            <details class="bg-gray-50 rounded-lg p-4">
              <summary class="font-semibold cursor-pointer">{item.question}</summary>
              <p class="mt-2 text-gray-700">{item.answer}</p>
            </details>
          ))}
        </div>
      </section>
    )}
    
    <!-- Nearby Cities -->
    {nearbyCityLinks.length > 0 && (
      <section id="orase-apropiate" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">OraÈ™e Apropiate</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {nearbyCityLinks.map(nearbyCity => (
            <a 
              href={`/servicii/${categorie}/${serviciu}/${nearbyCity.slug}/`}
              class="p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-500 hover:shadow-md transition"
            >
              <h3 class="font-semibold">{service.name} {nearbyCity.name}</h3>
            </a>
          ))}
        </div>
      </section>
    )}
    
    <!-- Related Services from Sanity (if available) or Similar Services -->
    {(sanityContent?.relatedServices && sanityContent.relatedServices.length > 0) ? (
      <section id="servicii-conexe" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Servicii Conexe Ã®n {city.name}</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {sanityContent.relatedServices.map((relatedService: { serviceName: string; serviceSlug: string }) => {
            // Clean the serviceSlug - extract just the slug part if it contains a full path
            let cleanSlug = relatedService.serviceSlug;
            
            // Remove leading/trailing slashes
            cleanSlug = cleanSlug.replace(/^\/+|\/+$/g, '');
            
            // If it contains 'servicii/', extract everything after the last slash
            if (cleanSlug.includes('/')) {
              const parts = cleanSlug.split('/');
              cleanSlug = parts[parts.length - 1];
            }
            
            // Get the category from pre-fetched data
            const category = relatedServiceCategories[cleanSlug];
            const relatedCategorySlug = category 
              ? category.toLowerCase()
                  .replace(/\s+&\s+/g, '-')  // Replace " & " with "-"
                  .replace(/&/g, '')  // Remove any remaining &
                  .replace(/\s+/g, '-')
                  .replace(/È™/g, 's')
                  .replace(/È›/g, 't')
                  .replace(/Äƒ/g, 'a')
                  .replace(/Ã¢/g, 'a')
                  .replace(/Ã®/g, 'i')
                  .replace(/[^a-z0-9-]/g, '')
                  .replace(/-+/g, '-')  // Replace multiple dashes with single dash
              : categorie;
            
            return (
              <a 
                href={`/servicii/${relatedCategorySlug}/${cleanSlug}/${oras}/`}
                class="p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-500 hover:shadow-md transition text-center"
              >
                <h3 class="font-semibold">{relatedService.serviceName}</h3>
              </a>
            );
          })}
        </div>
      </section>
    ) : (
      <section id="servicii-conexe" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Servicii Similare Ã®n {city.name}</h2>
        {similarServices.length > 0 ? (
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {similarServices.map(similarService => (
              <a 
                href={`/servicii/${categorie}/${similarService.slug}/${oras}/`}
                class="p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-500 hover:shadow-md transition text-center"
              >
                <h3 class="font-semibold">{similarService.name}</h3>
              </a>
            ))}
          </div>
        ) : (
          <div class="bg-white rounded-xl border border-slate-200 p-6 text-center">
            <p class="text-gray-700 mb-4">DescoperÄƒ alte servicii specializate verificate la nivel naÈ›ional.</p>
            <a
              href={`/servicii/${categorie}/`}
              class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition"
            >
              Vezi toate serviciile
            </a>
          </div>
        )}
      </section>
    )}
    
    <!-- Final CTA Section -->
    <section class="mt-16 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-8 text-center border border-blue-100">
      <h2 class="text-2xl font-bold text-slate-900 mb-4">Gata sÄƒ ÃŽncepi Proiectul TÄƒu?</h2>
      <p class="text-slate-700 mb-6 max-w-2xl mx-auto">
        PrimeÈ™te oferte gratuite de la meseriaÈ™i verificaÈ›i din {city.name}. RÄƒspuns rapid Ã®n 2â€“4 ore, fÄƒrÄƒ comisioane ascunse.
      </p>
      <a
        href={`https://app.meseriaslocal.ro/cere-oferta?oras=${oras}`}
        class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
      >
        Cere OfertÄƒ Acum
        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </a>
    </section>
  </article>
</Base>

<style>
  .prose {
    color: #374151;
  }
  
  .prose h2 {
    font-size: 1.875rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  .prose h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }
  
  .prose p {
    margin-bottom: 1rem;
  }
  
  .prose ul, .prose ol {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
  }
</style>
