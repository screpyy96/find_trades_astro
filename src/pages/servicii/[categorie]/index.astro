---
import Base from '../../../layouts/Base.astro';
import { supabase } from '../../../lib/supabase';
import { getPublicSupabaseConfig } from '../../../lib/publicEnv';
import { RecommendedTradesmen } from '../../../components/tradesman/RecommendedTradesmen';

// SSR with caching
export const prerender = false;

const { categorie } = Astro.params;

if (!supabase) {
  return Astro.redirect('/servicii', 500);
}

// Get all trades from this category
const { data: categoryTrades, error: tradesError } = await supabase
  .from('trades')
  .select('id, name, slug, category, description')
  .order('name');

if (tradesError || !categoryTrades || categoryTrades.length === 0) {
  return Astro.redirect('/servicii');
}

// Normalize category slug for comparison
const normalizeSlug = (str: string) => {
  return str
    .toLowerCase()
    .replace(/\s+&\s+/g, '-')
    .replace(/&/g, '')
    .replace(/\s+/g, '-')
    .replace(/ș/g, 's')
    .replace(/ț/g, 't')
    .replace(/ă/g, 'a')
    .replace(/â/g, 'a')
    .replace(/î/g, 'i')
    .replace(/[^a-z0-9-]/g, '')
    .replace(/-+/g, '-');
};

// Find trades matching this category
const trades = categoryTrades.filter(trade => 
  normalizeSlug(trade.category) === categorie
);

if (trades.length === 0) {
  // Redirect 301 to services page if category doesn't exist (better for SEO than 404)
  return Astro.redirect('/servicii/', 301);
}

// Get the category name from the first trade
const categoryName = trades[0].category;

// Get Supabase config for the component
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

// Helper function to capitalize
const capitalizeFirst = (str: string) => {
  return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
};

const title = `${capitalizeFirst(categoryName)} - Servicii și Meseriași Verificați`;
const description = `Descoperă ${trades.length} servicii de ${categoryName.toLowerCase()} cu meseriași verificați în toată România. Primește oferte gratuite în 24h, compară prețuri și recenzii.`;
const keywords = `${categoryName.toLowerCase()}, servicii ${categoryName.toLowerCase()}, meseriași ${categoryName.toLowerCase()}, ${categoryName.toLowerCase()} România`;

// Schema.org structured data
const categorySchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: categoryName,
  description: description,
  url: `https://www.meseriaslocal.ro/servicii/${categorie}/`,
  inLanguage: 'ro-RO',
  isPartOf: {
    '@type': 'WebSite',
    name: 'Meserias Local',
    url: 'https://www.meseriaslocal.ro'
  },
  provider: {
    '@type': 'Organization',
    name: 'Meserias Local',
    url: 'https://www.meseriaslocal.ro',
    logo: 'https://www.meseriaslocal.ro/icon-192.png'
  },
  mainEntity: {
    '@type': 'ItemList',
    name: `Servicii ${categoryName}`,
    numberOfItems: trades.length,
    itemListElement: trades.slice(0, 10).map((trade, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: trade.name,
      url: `https://www.meseriaslocal.ro/servicii/${categorie}/${trade.slug}/`
    }))
  }
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  name: `${categoryName} - Breadcrumb Navigation`,
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Acasă',
      item: 'https://www.meseriaslocal.ro'
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Servicii',
      item: 'https://www.meseriaslocal.ro/servicii'
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: categoryName,
      item: `https://www.meseriaslocal.ro/servicii/${categorie}/`
    }
  ]
};

// Service schema for rich results
const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: `Servicii ${categoryName}`,
  description: description,
  url: `https://www.meseriaslocal.ro/servicii/${categorie}/`,
  areaServed: {
    '@type': 'Country',
    name: 'România'
  },
  provider: {
    '@type': 'Organization',
    name: 'Meserias Local',
    url: 'https://www.meseriaslocal.ro',
    logo: 'https://www.meseriaslocal.ro/icon-192.png',
    address: {
      '@type': 'PostalAddress',
      addressCountry: 'RO'
    }
  },
  serviceType: categoryName,
  hasOfferCatalog: {
    '@type': 'OfferCatalog',
    name: `Servicii ${categoryName}`,
    itemListElement: trades.slice(0, 5).map(trade => ({
      '@type': 'Offer',
      itemOffered: {
        '@type': 'Service',
        name: trade.name,
        description: trade.description || `Servicii profesionale de ${trade.name.toLowerCase()}`
      }
    }))
  }
};
---

<Base title={title} description={description} disableDefaultBreadcrumb={true}>
  <meta slot="head" name="keywords" content={keywords} />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(categorySchema)} slot="head" />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} slot="head" />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(serviceSchema)} slot="head" />

  <!-- Hero Section -->
  <section 
    class="relative overflow-hidden py-16 lg:py-20"
    style="background: linear-gradient(180deg, #1b1f1d 0%, #21251f 50%, #2a302b 100%)"
  >
    <!-- Grid pattern -->
    <div class="absolute inset-0 opacity-15">
      <div
        class="absolute inset-0"
        style="background-image: linear-gradient(rgba(45, 51, 45, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(45, 51, 45, 0.4) 1px, transparent 1px); background-size: 60px 60px"
      ></div>
    </div>

    <!-- Floating geometric shapes (static) -->
    <div class="absolute inset-0 opacity-15">
      <div class="absolute top-24 left-40 w-14 h-14 border-2 border-blue-400/30 rounded-full"></div>
      <div class="absolute top-48 left-20 w-10 h-10 bg-emerald-400/15 rounded-full"></div>
      <div class="absolute top-20 right-28 w-16 h-16 border-2 border-purple-400/30 rounded-full"></div>
      <div class="absolute top-52 right-16 w-12 h-12 bg-blue-400/15 rounded-full"></div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <!-- Breadcrumb -->
        <nav class="flex justify-center mb-6">
          <div class="bg-slate-800/40 backdrop-blur-md rounded-full px-4 py-2 border border-slate-700/50">
            <ol class="flex items-center space-x-2 text-slate-300 text-xs font-medium">
              <li class="flex items-center">
                <a href="/" class="hover:text-white transition-colors">Acasă</a>
              </li>
              <li class="flex items-center">
                <span class="mx-2 text-white/40">›</span>
                <a href="/servicii/" class="hover:text-white transition-colors">Servicii</a>
              </li>
              <li class="flex items-center">
                <span class="mx-2 text-white/40">›</span>
                <span class="text-orange-400 font-semibold">{categoryName}</span>
              </li>
            </ol>
          </div>
        </nav>

        <!-- Main Heading -->
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight">
          {capitalizeFirst(categoryName)}
        </h1>

        <p class="text-xl text-slate-300 mb-4">
          {trades.length} servicii disponibile cu meseriași verificați
        </p>

        <p class="text-lg text-slate-300 mb-8 leading-relaxed max-w-3xl mx-auto">
          Găsește profesioniști de încredere pentru servicii de {categoryName.toLowerCase()}. 
          Primește oferte gratuite în 24 ore, compară prețuri și recenzii.
        </p>

        <!-- CTA Button -->
        <div class="flex flex-wrap items-center justify-center gap-4">
          <a
            href="https://app.meseriaslocal.ro/cere-oferta"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
          >
            Cere ofertă gratuită
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Services Grid -->
  <section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-10">
        <h2 class="text-3xl font-bold text-slate-900 mb-3">
          Toate serviciile din categoria {categoryName}
        </h2>
        <p class="text-slate-600 max-w-2xl mx-auto">
          Selectează serviciul de care ai nevoie pentru a vedea meseriași verificați și a primi oferte personalizate
        </p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {trades.map(trade => (
          <a
            href={`/servicii/${categorie}/${trade.slug}/`}
            class="group bg-white hover:bg-gradient-to-br hover:from-blue-50 hover:to-purple-50 border border-slate-200 hover:border-blue-300 rounded-xl p-6 transition-all duration-200 shadow-sm hover:shadow-lg"
          >
            <h3 class="text-lg font-semibold text-slate-900 group-hover:text-blue-700 mb-2">
              {trade.name}
            </h3>
            {trade.description && (
              <p class="text-sm text-slate-600 line-clamp-2">
                {trade.description}
              </p>
            )}
            <div class="mt-4 flex items-center text-blue-600 group-hover:text-blue-700 text-sm font-medium">
              Vezi detalii
              <svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Recommended Tradesmen -->
  <section class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-10">
        <h2 class="text-3xl font-bold text-slate-900 mb-3">
          Meseriași Premium din categoria {categoryName}
        </h2>
        <p class="text-slate-600 max-w-2xl mx-auto">
          Profesioniști verificați cu abonament PRO, gata să îți ofere servicii de calitate
        </p>
      </div>

      <RecommendedTradesmen
        cityName="România"
        categoryName={categoryName}
        supabaseUrl={supabaseUrl}
        supabaseAnonKey={supabaseAnonKey}
        maxResults={9}
        compact={true}
        client:load
      />
    </div>
  </section>

  <!-- How it Works -->
  <section class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold text-slate-900 mb-10 text-center">
          Cum funcționează?
        </h2>
        <div class="grid md:grid-cols-4 gap-8">
          <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">
              1
            </div>
            <h3 class="font-semibold text-slate-900 mb-2">Alege serviciul</h3>
            <p class="text-sm text-slate-600">
              Selectează serviciul de care ai nevoie din lista de mai sus
            </p>
          </div>
          <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">
              2
            </div>
            <h3 class="font-semibold text-slate-900 mb-2">Descrie proiectul</h3>
            <p class="text-sm text-slate-600">
              Completează un formular simplu cu detaliile lucrării
            </p>
          </div>
          <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">
              3
            </div>
            <h3 class="font-semibold text-slate-900 mb-2">Primești oferte</h3>
            <p class="text-sm text-slate-600">
              Meseriașii verificați îți trimit oferte în 24h
            </p>
          </div>
          <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-2xl mx-auto mb-4">
              4
            </div>
            <h3 class="font-semibold text-slate-900 mb-2">Alege și începe</h3>
            <p class="text-sm text-slate-600">
              Compară ofertele și alege meseriașul potrivit
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-8 border border-blue-100">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">
          Gata să începi proiectul tău?
        </h2>
        <p class="text-slate-700 mb-6 max-w-2xl mx-auto">
          Primește oferte gratuite de la meseriași verificați. Răspuns rapid în 2–4 ore, fără comisioane ascunse.
        </p>
        <a
          href="https://app.meseriaslocal.ro/cere-oferta"
          class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
        >
          Cere Ofertă Acum
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </div>
    </div>
  </section>
</Base>
