---
import Base from '../../layouts/Base.astro';
import { getBlogPostBySlug, getImageUrl } from '../../lib/sanity';
import { PortableText } from 'astro-portabletext';
import PortableTextCode from '../../components/PortableTextCode.astro';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/blog/', 301);
}

const post = await getBlogPostBySlug(slug);

if (!post) {
  // Redirect 301 to blog index if post doesn't exist (better for SEO than 404)
  return Astro.redirect('/blog/', 301);
}

const cleanPortableText = (value: any) => {
  if (!Array.isArray(value)) return value;

  return value
    .map((block: any) => {
      if (!block || typeof block !== 'object') return block;
      if (block._type !== 'block' || !Array.isArray(block.children)) return block;

      // Filter out children that are only ">" or whitespace with ">"
      const nextChildren = block.children.filter((child: any) => {
        if (!child || typeof child !== 'object') return true;
        const t = String(child.text || '').trim();
        // Remove children that are only ">" or multiple ">" with spaces
        if (t === '>' || t === '> >' || /^(>\s*)+$/.test(t)) return false;
        return true;
      }).map((child: any) => {
        // Also clean any leading/trailing ">" from text content
        if (child && typeof child === 'object' && child.text) {
          let cleanedText = String(child.text);
          // Remove standalone ">" at start or end
          cleanedText = cleanedText.replace(/^(>\s*)+/, '').replace(/(>\s*)+$/, '');
          return { ...child, text: cleanedText };
        }
        return child;
      });

      return {
        ...block,
        children: nextChildren,
      };
    })
    .filter((block: any) => {
      if (!block || typeof block !== 'object') return true;
      if (block._type !== 'block' || !Array.isArray(block.children)) return true;
      
      // Check if block has any meaningful content after cleaning
      const text = block.children
        .map((c: any) => (c && typeof c === 'object' ? String(c.text || '') : ''))
        .join('')
        .trim();
      
      // Filter out blocks with only > characters, empty blocks, or whitespace-only
      if (!text || /^(>\s*)+$/.test(text) || text === '>' || text === '> >') return false;
      return true;
    });
};

const content = cleanPortableText(post.content);

// Clean text fields that might contain stray ">" characters from Sanity
const cleanText = (text: string | undefined | null): string => {
  if (!text) return '';
  return text
    .replace(/^(>\s*)+/, '')  // Remove leading ">" 
    .replace(/(>\s*)+$/, '')  // Remove trailing ">"
    .replace(/\s*>\s*>\s*/g, ' ')  // Remove "> >" patterns
    .trim();
};

// Clean excerpt and other text fields
const cleanExcerpt = cleanText(post.excerpt);
const cleanTitle = cleanText(post.title);
const cleanMetaTitle = cleanText(post.metaTitle);
const cleanMetaDescription = cleanText(post.metaDescription);

const imageUrl = post.featuredImage ? getImageUrl(post.featuredImage) : null;
---

<Base 
  title={cleanMetaTitle || cleanTitle}
  description={cleanMetaDescription || cleanExcerpt}
  canonical={`https://www.meseriaslocal.ro/blog/${slug}/`}
  ogImage={imageUrl || undefined}
  disableDefaultBreadcrumb={true}
>
  <!-- Keywords Meta Tag -->
  {post.tags && post.tags.length > 0 && <meta name="keywords" content={post.tags.join(", ")} slot="head" />}
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article" slot="head" />
  <meta property="article:published_time" content={post.publishedAt} slot="head" />
  {post.updatedAt && <meta property="article:modified_time" content={post.updatedAt} slot="head" />}
  {post.author?.name && <meta property="article:author" content={post.author.name} slot="head" />}
  {post.category?.name && <meta property="article:section" content={post.category.name} slot="head" />}
  {post.tags?.map((tag) => <meta property="article:tag" content={tag} slot="head" />)}
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" slot="head" />
  <meta name="twitter:title" content={cleanMetaTitle || cleanTitle} slot="head" />
  <meta name="twitter:description" content={cleanMetaDescription || cleanExcerpt} slot="head" />
  {imageUrl && <meta name="twitter:image" content={imageUrl} slot="head" />}

  <!-- Article Schema.org -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": cleanTitle,
    "description": cleanExcerpt,
    "image": imageUrl ? [imageUrl] : [],
    "datePublished": post.publishedAt,
    "dateModified": post.updatedAt || post.publishedAt,
    "author": {
      "@type": "Person",
      "name": post.author?.name || "Meserias Local",
      "url": post.author?.socialLinks?.website || "https://www.meseriaslocal.ro"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Meserias Local",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.meseriaslocal.ro/logo.svg"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://www.meseriaslocal.ro/blog/${slug}/`
    },
    "articleSection": post.category?.name || "General",
    "keywords": post.tags?.join(", ") || "",
    "wordCount": content?.reduce((acc: number, block: any) => {
      if (block._type === 'block' && block.children) {
        return acc + block.children.reduce((sum: number, child: any) => sum + (child.text?.split(' ').length || 0), 0);
      }
      return acc;
    }, 0) || 0,
    "timeRequired": post.readingTime ? `PT${post.readingTime}M` : undefined
  })} />

  <!-- Breadcrumb Schema.org -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Acasă",
        "item": "https://www.meseriaslocal.ro"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Blog",
        "item": "https://www.meseriaslocal.ro/blog/"
      },
      post.category ? {
        "@type": "ListItem",
        "position": 3,
        "name": post.category.name,
        "item": `https://www.meseriaslocal.ro/blog/categorie/${post.category.slug.current}/`
      } : null,
      {
        "@type": "ListItem",
        "position": post.category ? 4 : 3,
        "name": post.title,
        "item": `https://www.meseriaslocal.ro/blog/${slug}/`
      }
    ].filter(Boolean)
  })} />

  <!-- FAQ Schema (if article has Q&A sections) -->
  {post.tags?.includes('intrebari') && (
    <script type="application/ld+json" slot="head" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": []
    })} />
  )}

  <!-- Hero Section - negative margin on mobile to compensate for Base layout padding -->
  <section class="bg-gradient-to-b from-slate-50 to-white pt-0 pb-12 lg:pb-16 border-b border-slate-200 -mt-16 lg:mt-0">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex justify-center lg:justify-start mb-6">
        <ol class="flex items-center space-x-2 text-slate-600 text-sm">
          <li class="flex items-center">
            <a href="/" class="hover:text-blue-600 transition-colors">Acasă</a>
          </li>
          <li class="flex items-center">
            <span class="mx-2 text-slate-400">›</span>
            <a href="/blog/" class="hover:text-blue-600 transition-colors">Blog</a>
          </li>
          {post.category && (
            <li class="flex items-center">
              <span class="mx-2 text-slate-400">›</span>
              <a href={`/blog/categorie/${post.category.slug.current}/`} class="hover:text-blue-600 transition-colors">
                {post.category.name}
              </a>
            </li>
          )}
        </ol>
      </nav>

      <!-- Category Badge -->
      {post.category && (
        <div class="text-center lg:text-left mb-4">
          <span class="inline-block px-4 py-1.5 bg-blue-100 text-blue-700 text-sm font-bold rounded-full">
            {post.category.name}
          </span>
        </div>
      )}

      <!-- Title -->
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-slate-900 mb-6 leading-tight text-center lg:text-left">
        {post.title}
      </h1>

      <!-- Meta Info -->
      <div class="flex flex-wrap items-center justify-center lg:justify-start gap-4 text-sm text-slate-600">
        {post.author && (
          <div class="flex items-center gap-2">
            {post.author.avatar && (
              <img
                src={getImageUrl(post.author.avatar) || ''}
                alt={post.author.name}
                class="w-10 h-10 rounded-full border-2 border-slate-200"
              />
            )}
            <span class="font-medium text-slate-900">{post.author.name}</span>
          </div>
        )}
        <span class="text-slate-400">•</span>
        <time datetime={post.publishedAt} class="flex items-center gap-1.5">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {new Date(post.publishedAt).toLocaleDateString('ro-RO', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          })}
        </time>
        {post.readingTime && (
          <>
            <span class="text-slate-400">•</span>
            <span class="flex items-center gap-1.5">
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {post.readingTime} min citire
            </span>
          </>
        )}
      </div>
    </div>
  </section>

  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="fixed top-0 left-0 h-1 bg-gradient-to-r from-blue-500 to-purple-500 z-50 transition-all duration-300" style="width: 0%"></div>

  <!-- Article Content -->
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Featured Image -->
    {imageUrl && (
      <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl">
        <img
          src={imageUrl}
          alt={post.featuredImage?.alt || post.title}
          class="w-full h-auto"
          loading="eager"
          fetchpriority="high"
        />
      </div>
    )}

    <!-- Social Share Buttons -->
    <div class="flex items-center justify-center gap-3 mb-8 pb-8 border-b border-slate-200">
      <span class="text-sm font-semibold text-slate-600">Distribuie:</span>
      <a
        href={`https://www.facebook.com/sharer/sharer.php?u=https://www.meseriaslocal.ro/blog/${slug}/`}
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
        aria-label="Distribuie pe Facebook"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
        Facebook
      </a>
      <a
        href={`https://twitter.com/intent/tweet?url=https://www.meseriaslocal.ro/blog/${slug}/&text=${encodeURIComponent(post.title)}`}
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors text-sm font-medium"
        aria-label="Distribuie pe Twitter"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
        Twitter
      </a>
      <a
        href={`https://www.linkedin.com/sharing/share-offsite/?url=https://www.meseriaslocal.ro/blog/${slug}/`}
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center gap-2 px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors text-sm font-medium"
        aria-label="Distribuie pe LinkedIn"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
        LinkedIn
      </a>
    </div>

    <!-- Excerpt -->
    {post.excerpt && (
      <div class="text-xl text-slate-700 leading-relaxed mb-8 font-medium border-l-4 border-blue-500 pl-6 py-2 bg-blue-50 rounded-r-lg">
        {post.excerpt}
      </div>
    )}

    <!-- Content -->
    <div class="prose prose-slate prose-lg max-w-none">
      <PortableText
        value={content}
        components={{
          type: {
            code: PortableTextCode,
          },
        }}
      />
    </div>

    <!-- Author Box (E-E-A-T) -->
    {post.author && (
      <div class="mt-12 p-6 bg-slate-50 rounded-2xl border border-slate-200">
        <div class="flex items-start gap-4">
          {post.author.avatar && (
            <img
              src={getImageUrl(post.author.avatar) || ''}
              alt={post.author.name}
              class="w-20 h-20 rounded-full border-4 border-white shadow-lg flex-shrink-0"
            />
          )}
          <div class="flex-1">
            <h3 class="text-lg font-bold text-slate-900 mb-1">Despre autor</h3>
            <p class="text-blue-600 font-semibold mb-2">{post.author.name}</p>
            {post.author.bio && (
              <p class="text-slate-600 text-sm leading-relaxed mb-3">{post.author.bio}</p>
            )}
            {post.author.socialLinks && (
              <div class="flex gap-3">
                {post.author.socialLinks.twitter && (
                  <a href={post.author.socialLinks.twitter} target="_blank" rel="noopener noreferrer" class="text-slate-600 hover:text-blue-600 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                  </a>
                )}
                {post.author.socialLinks.linkedin && (
                  <a href={post.author.socialLinks.linkedin} target="_blank" rel="noopener noreferrer" class="text-slate-600 hover:text-blue-600 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                  </a>
                )}
                {post.author.socialLinks.website && (
                  <a href={post.author.socialLinks.website} target="_blank" rel="noopener noreferrer" class="text-slate-600 hover:text-blue-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                  </a>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    )}

    <!-- Tags -->
    {post.tags && post.tags.length > 0 && (
      <div class="mt-8 pt-8 border-t border-slate-200">
        <h3 class="text-sm font-semibold text-slate-900 mb-3">Etichete:</h3>
        <div class="flex flex-wrap gap-2">
          {post.tags.map((tag) => (
            <span class="px-3 py-1 bg-slate-100 text-slate-700 text-sm rounded-full hover:bg-slate-200 transition-colors cursor-pointer">
              {tag}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Share & Back -->
    <div class="mt-12 pt-8 border-t border-slate-200 flex items-center justify-between">
      <a
        href="/blog/"
        class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Înapoi la Blog
      </a>
    </div>
  </article>

  <!-- Reading Progress & Analytics Script -->
  <script is:inline define:vars={{ articleTitle: post.title, articleCategory: post.category?.name, readingTime: post.readingTime }}>
    // Reading progress bar
    const progressBar = document.getElementById('reading-progress');
    let scrollDepthTracked = { 25: false, 50: false, 75: false, 100: false };
    
    if (progressBar) {
      window.addEventListener('scroll', () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrolled = window.scrollY;
        const progress = (scrolled / documentHeight) * 100;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
        
        // Track scroll depth milestones
        if (window.dataLayer) {
          if (progress >= 25 && !scrollDepthTracked[25]) {
            scrollDepthTracked[25] = true;
            window.dataLayer.push({ event: 'scroll_depth', scroll_depth: 25, article_title: articleTitle });
          }
          if (progress >= 50 && !scrollDepthTracked[50]) {
            scrollDepthTracked[50] = true;
            window.dataLayer.push({ event: 'scroll_depth', scroll_depth: 50, article_title: articleTitle });
          }
          if (progress >= 75 && !scrollDepthTracked[75]) {
            scrollDepthTracked[75] = true;
            window.dataLayer.push({ event: 'scroll_depth', scroll_depth: 75, article_title: articleTitle });
          }
          if (progress >= 90 && !scrollDepthTracked[100]) {
            scrollDepthTracked[100] = true;
            window.dataLayer.push({ 
              event: 'blog_read_complete', 
              category: 'content',
              article_title: articleTitle,
              article_category: articleCategory,
              reading_time: readingTime
            });
          }
        }
      });
    }

    // Track blog view
    if (window.dataLayer) {
      window.dataLayer.push({
        event: 'blog_view',
        category: 'content',
        article_title: articleTitle,
        article_category: articleCategory,
        reading_time: readingTime
      });
    }

    // Track social share clicks
    document.querySelectorAll('a[href*="facebook.com/sharer"], a[href*="twitter.com/intent"], a[href*="linkedin.com/sharing"]').forEach(link => {
      link.addEventListener('click', function() {
        const platform = this.href.includes('facebook') ? 'facebook' : 
                        this.href.includes('twitter') ? 'twitter' : 'linkedin';
        if (window.dataLayer) {
          window.dataLayer.push({
            event: 'social_share',
            category: 'engagement',
            platform: platform,
            article_title: articleTitle
          });
        }
      });
    });

    // Smooth scroll for internal links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const href = this.getAttribute('href');
        const target = href ? document.querySelector(href) : null;
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  </script>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-br from-blue-50 to-purple-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-2xl font-bold text-slate-900 mb-4">
        Ai nevoie de un meseriaș?
      </h2>
      <p class="text-slate-600 mb-8">
        Primește oferte gratuite de la meseriași verificați
      </p>
      <a
        href="https://app.meseriaslocal.ro/cere-oferta"
        class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
      >
        Cere ofertă gratuită
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </a>
    </div>
  </section>
</Base>
