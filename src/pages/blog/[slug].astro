---
import Base from '../../layouts/Base.astro';
import { getBlogPostBySlug, getImageUrl } from '../../lib/sanity';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/blog', 404);
}

const post = await getBlogPostBySlug(slug);

if (!post) {
  return Astro.redirect('/blog', 404);
}

const imageUrl = post.featuredImage ? getImageUrl(post.featuredImage) : null;

// Helper to render portable text with link support
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  
  // Track marks that are links
  const markDefs = blocks.reduce((acc: any, block: any) => {
    if (block.markDefs) {
      block.markDefs.forEach((def: any) => {
        acc[def._key] = def;
      });
    }
    return acc;
  }, {});
  
  return blocks.map((block: any) => {
    if (block._type === 'block') {
      const children = block.children?.map((child: any) => {
        let text = child.text || '';
        
        // Process marks (bold, italic, links, etc.)
        if (child.marks && child.marks.length > 0) {
          child.marks.forEach((mark: string) => {
            // Check if it's a link mark
            if (markDefs[mark]) {
              const linkDef = markDefs[mark];
              if (linkDef._type === 'link') {
                const href = linkDef.href || '';
                const target = href.startsWith('http') ? ' target="_blank" rel="noopener noreferrer"' : '';
                text = `<a href="${href}"${target} class="text-blue-600 hover:text-blue-700 underline font-medium">${text}</a>`;
              }
            }
            // Standard marks
            else if (mark === 'strong') {
              text = `<strong>${text}</strong>`;
            } else if (mark === 'em') {
              text = `<em>${text}</em>`;
            } else if (mark === 'code') {
              text = `<code class="bg-slate-100 px-1 py-0.5 rounded text-sm">${text}</code>`;
            }
          });
        }
        
        return text;
      }).join('') || '';
      
      if (block.style === 'h2') return `<h2 class="text-2xl font-bold text-slate-900 mt-8 mb-4">${children}</h2>`;
      if (block.style === 'h3') return `<h3 class="text-xl font-semibold text-slate-900 mt-6 mb-3">${children}</h3>`;
      if (block.style === 'h4') return `<h4 class="text-lg font-semibold text-slate-900 mt-4 mb-2">${children}</h4>`;
      if (block.listItem === 'bullet') return `<li class="ml-6 mb-2">${children}</li>`;
      if (block.listItem === 'number') return `<li class="ml-6 mb-2">${children}</li>`;
      if (block.style === 'blockquote') return `<blockquote class="border-l-4 border-blue-500 pl-4 italic my-4">${children}</blockquote>`;
      return `<p class="text-slate-700 leading-relaxed mb-4">${children}</p>`;
    }
    return '';
  }).join('');
}
---

<Base 
  title={post.metaTitle || post.title}
  description={post.metaDescription || post.excerpt}
>

  <!-- Hero Section -->
  <section class="bg-gradient-to-b from-slate-50 to-white py-12 lg:py-16 border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex justify-center lg:justify-start mb-6">
        <ol class="flex items-center space-x-2 text-slate-600 text-sm">
          <li class="flex items-center">
            <a href="/" class="hover:text-blue-600 transition-colors">Acasă</a>
          </li>
          <li class="flex items-center">
            <span class="mx-2 text-slate-400">›</span>
            <a href="/blog/" class="hover:text-blue-600 transition-colors">Blog</a>
          </li>
          {post.category && (
            <li class="flex items-center">
              <span class="mx-2 text-slate-400">›</span>
              <a href={`/blog/categorie/${post.category.slug.current}/`} class="hover:text-blue-600 transition-colors">
                {post.category.name}
              </a>
            </li>
          )}
        </ol>
      </nav>

      <!-- Category Badge -->
      {post.category && (
        <div class="text-center lg:text-left mb-4">
          <span class="inline-block px-4 py-1.5 bg-blue-100 text-blue-700 text-sm font-bold rounded-full">
            {post.category.name}
          </span>
        </div>
      )}

      <!-- Title -->
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-slate-900 mb-6 leading-tight text-center lg:text-left">
        {post.title}
      </h1>

      <!-- Meta Info -->
      <div class="flex flex-wrap items-center justify-center lg:justify-start gap-4 text-sm text-slate-600">
        {post.author && (
          <div class="flex items-center gap-2">
            {post.author.avatar && (
              <img
                src={getImageUrl(post.author.avatar) || ''}
                alt={post.author.name}
                class="w-10 h-10 rounded-full border-2 border-slate-200"
              />
            )}
            <span class="font-medium text-slate-900">{post.author.name}</span>
          </div>
        )}
        <span class="text-slate-400">•</span>
        <time datetime={post.publishedAt} class="flex items-center gap-1.5">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {new Date(post.publishedAt).toLocaleDateString('ro-RO', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          })}
        </time>
        {post.readingTime && (
          <>
            <span class="text-slate-400">•</span>
            <span class="flex items-center gap-1.5">
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {post.readingTime} min citire
            </span>
          </>
        )}
      </div>
    </div>
  </section>

  <!-- Article Content -->
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Featured Image -->
    {imageUrl && (
      <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl">
        <img
          src={imageUrl}
          alt={post.featuredImage?.alt || post.title}
          class="w-full h-auto"
        />
      </div>
    )}

    <!-- Excerpt -->
    {post.excerpt && (
      <div class="text-xl text-slate-700 leading-relaxed mb-8 font-medium">
        {post.excerpt}
      </div>
    )}

    <!-- Content -->
    <div class="prose prose-slate prose-lg max-w-none" set:html={renderPortableText(post.content)} />

    <!-- Tags -->
    {post.tags && post.tags.length > 0 && (
      <div class="mt-12 pt-8 border-t border-slate-200">
        <h3 class="text-sm font-semibold text-slate-900 mb-3">Etichete:</h3>
        <div class="flex flex-wrap gap-2">
          {post.tags.map((tag) => (
            <span class="px-3 py-1 bg-slate-100 text-slate-700 text-sm rounded-full">
              {tag}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Share & Back -->
    <div class="mt-12 pt-8 border-t border-slate-200 flex items-center justify-between">
      <a
        href="/blog/"
        class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Înapoi la Blog
      </a>
    </div>
  </article>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-br from-blue-50 to-purple-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-2xl font-bold text-slate-900 mb-4">
        Ai nevoie de un meseriaș?
      </h2>
      <p class="text-slate-600 mb-8">
        Primește oferte gratuite de la meseriași verificați
      </p>
      <a
        href="https://app.meseriaslocal.ro/cere-oferta"
        class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
      >
        Cere ofertă gratuită
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </a>
    </div>
  </section>
</Base>
