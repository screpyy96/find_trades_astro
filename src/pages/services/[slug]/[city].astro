---
import Base from '../../../layouts/Base.astro';
import { trades, type Trade } from '../../../data/trades';
import { cities } from '../../../data/cities';
import { getTradeCityContent } from '../../../data/trade-content';
import { generateServiceCitySchema } from '../../../lib/schema';
import { validateEnvironment } from '../../../lib/env-validation';
import type { GetStaticPaths } from 'astro';

const envConfig = validateEnvironment();
const APP_URL = envConfig.config.app.url;

export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () => {
  const paths: any[] = [];
  const topCities = cities.slice(0, 10);

  for (const trade of trades) {
    for (const city of topCities) {
      paths.push({
        params: { slug: trade.slug, city: city.slug },
        props: { trade, city },
      });
    }
  }

  return paths;
};

interface Props {
  trade: Trade;
  city: typeof cities[0];
}

const { trade, city } = Astro.props;

// Check for custom content
const custom = getTradeCityContent(trade.slug, city.slug);

// Stats — custom or generic fallback
const stats = custom?.stats ?? {
  totalWorkers: 120,
  avgRating: 4.7,
  recentProjects: 350,
};

// SEO metadata — custom or generic fallback
const title = custom?.metaTitle
  ?? `${trade.name} in ${city.name} | Find Verified ${trade.name}s | FindTrades`;
const description = custom?.metaDescription
  ?? `Find verified ${trade.name.toLowerCase()}s in ${city.name}. ${stats.totalWorkers}+ local professionals available. Get free quotes today.`;
const canonical = `https://www.findtrades.app/services/${trade.slug}/${city.slug}/`;

// H1 and hero text
const h1 = custom?.h1 ?? `${trade.name} Services in ${city.name}`;
const heroText = custom?.heroText
  ?? `Connect with ${stats.totalWorkers}+ verified ${trade.name.toLowerCase()} professionals in ${city.name}. Local experts ready to help with your project.`;

// FAQs — custom or generic
const faqs = custom?.faqs ?? [
  {
    question: `How much does a ${trade.name.toLowerCase()} cost in ${city.name}?`,
    answer: `${trade.name} costs in ${city.name} vary by job type and complexity. Local ${trade.name.toLowerCase()}s typically charge between £30–£60 per hour. Post your project on FindTrades to get free, no-obligation quotes from verified ${city.name} professionals.`,
  },
  {
    question: `How do I find a trusted ${trade.name.toLowerCase()} in ${city.name}?`,
    answer: `FindTrades makes it easy to find verified ${trade.name.toLowerCase()}s in ${city.name}. All professionals are vetted, insured, and reviewed by local customers. Post your job and compare quotes from up to 5 ${city.name}-based tradesmen.`,
  },
  {
    question: `Are ${trade.name.toLowerCase()}s in ${city.name} available for emergency work?`,
    answer: `Yes, many ${trade.name.toLowerCase()} professionals in ${city.name} offer emergency and same-day services. Mark your job as urgent to get faster responses from available local tradesmen.`,
  },
  {
    question: `What areas near ${city.name} do your ${trade.name.toLowerCase()}s cover?`,
    answer: `Our ${trade.name.toLowerCase()} professionals cover ${city.name} and surrounding areas within ${city.county}. Many tradesmen are willing to travel to nearby towns for larger projects.`,
  },
];

// Schema
const categorySlug = trade.category ? trade.category.toLowerCase().replace(/\s+/g, '-') : 'other';
const schemaData = generateServiceCitySchema({
  serviceName: trade.name,
  serviceSlug: trade.slug,
  categorySlug,
  cityName: city.name,
  citySlug: city.slug,
  description,
});

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: faqs.map(faq => ({
    "@type": "Question",
    name: faq.question,
    acceptedAnswer: { "@type": "Answer", text: faq.answer },
  })),
};

// Related services
const relatedServices = trades.filter(t => t.slug !== trade.slug).slice(0, 8);
---

<Base title={title} description={description} canonical={canonical}>
  <script is:inline type="application/ld+json" set:html={JSON.stringify(schemaData)} slot="head" />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(faqSchema)} slot="head" />

  <!-- Hero -->
  <section class="w-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white" data-navbar-transparent="true">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 lg:py-24">
      <div class="text-center max-w-4xl mx-auto">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight mb-6">
          {h1.includes(city.name) ? (
            <Fragment>
              {h1.split(city.name)[0]}
              <span class="text-amber-400">{city.name}</span>
              {h1.split(city.name).slice(1).join(city.name)}
            </Fragment>
          ) : (
            <Fragment>
              {h1}
              <span class="block text-amber-400">{city.name}</span>
            </Fragment>
          )}
        </h1>
        <p class="text-xl sm:text-2xl text-slate-300 mb-8 leading-relaxed">{heroText}</p>

        <!-- Stats -->
        <div class={`grid ${custom?.stats?.avgResponseTime ? 'grid-cols-4' : 'grid-cols-3'} gap-6 mb-12 max-w-3xl mx-auto`}>
          <div class="text-center">
            <div class="text-3xl font-bold text-amber-400">{stats.totalWorkers}+</div>
            <div class="text-slate-400 text-sm">Local Pros</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-amber-400">{stats.avgRating.toFixed(1)}</div>
            <div class="text-slate-400 text-sm">Avg Rating</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-amber-400">{stats.recentProjects}+</div>
            <div class="text-slate-400 text-sm">Recent Jobs</div>
          </div>
          {custom?.stats?.avgResponseTime && (
            <div class="text-center">
              <div class="text-3xl font-bold text-amber-400">{custom.stats.avgResponseTime}</div>
              <div class="text-slate-400 text-sm">Avg Response</div>
            </div>
          )}
        </div>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href={`${APP_URL}/request-quote?trade=${trade.slug}&city=${city.slug}`}
            class="inline-flex items-center gap-3 px-8 py-4 rounded-full bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold text-lg transition-all duration-300 hover:from-amber-600 hover:to-amber-700 hover:shadow-lg hover:shadow-amber-500/25 transform hover:scale-105"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
            Get Free Quotes in {city.name}
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="w-full bg-white py-16 lg:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2 space-y-10">

          <!-- Intro -->
          <div>
            <h2 class="text-3xl font-bold text-slate-900 mb-4">
              {custom ? `About ${trade.name} Services in ${city.name}` : `Professional ${trade.name} Services in ${city.name}`}
            </h2>
            <p class="text-lg text-slate-600 leading-relaxed">
              {custom?.sections.intro ?? `Finding a reliable ${trade.name.toLowerCase()} in ${city.name} is easy with FindTrades. We connect you with verified local professionals who have the skills and experience to handle your project efficiently and to the highest standards.`}
            </p>
          </div>

          {/* Custom: Popular Services with prices */}
          {custom?.sections.popularServices && (
            <div>
              <h3 class="text-2xl font-bold text-slate-900 mb-6">Popular {trade.name} Services in {city.name}</h3>
              <div class="space-y-4">
                {custom.sections.popularServices.map((svc) => (
                  <div class="border border-slate-200 rounded-xl p-5 hover:border-amber-300 transition-colors">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <h4 class="text-lg font-semibold text-slate-900 mb-1">{svc.name}</h4>
                        <p class="text-slate-600 text-sm">{svc.description}</p>
                      </div>
                      <span class="text-amber-600 font-bold text-sm whitespace-nowrap bg-amber-50 px-3 py-1 rounded-full">{svc.priceRange}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Custom: Price Guide Table */}
          {custom?.priceGuide && (
            <div>
              <h3 class="text-2xl font-bold text-slate-900 mb-6">{trade.name} Price Guide — {city.name} 2026</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead>
                    <tr class="border-b-2 border-slate-200">
                      <th class="py-3 pr-4 text-sm font-semibold text-slate-900">Service</th>
                      <th class="py-3 pr-4 text-sm font-semibold text-slate-900">Typical Price</th>
                      <th class="py-3 text-sm font-semibold text-slate-900">Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {custom.priceGuide.map((row) => (
                      <tr class="border-b border-slate-100">
                        <td class="py-3 pr-4 text-sm text-slate-700">{row.service}</td>
                        <td class="py-3 pr-4 text-sm font-semibold text-amber-600">{row.price}</td>
                        <td class="py-3 text-sm text-slate-500">{row.note ?? ''}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Custom: Local Insight */}
          {custom?.sections.localInsight && (
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Local Insight
              </h3>
              <p class="text-slate-700 leading-relaxed">{custom.sections.localInsight}</p>
            </div>
          )}

          {/* Generic: Why Choose Us (only when no custom content) */}
          {!custom && (
            <div>
              <h3 class="text-xl font-semibold text-slate-900 mb-4">Why Choose Our {trade.name}s in {city.name}?</h3>
              <ul class="space-y-3 text-slate-600">
                {["Verified professionals with proven track records", "Fast response times for emergency situations", "Competitive pricing with no hidden fees", "Fully insured and qualified tradesmen"].map((item) => (
                  <li class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>

        <!-- Sidebar -->
        <div class="space-y-8">
          <!-- Quick Quote -->
          <div class="bg-slate-50 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">Request a Quote</h3>
            <p class="text-sm text-slate-600 mb-4">
              Get quotes from verified {trade.name.toLowerCase()}s in {city.name}
            </p>
            <a
              href={`${APP_URL}/request-quote?trade=${trade.slug}&city=${city.slug}`}
              class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-full bg-gradient-to-r from-amber-500 to-amber-600 text-white font-semibold transition-all duration-300 hover:from-amber-600 hover:to-amber-700"
            >
              Get Free Quotes
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </a>
          </div>

          {/* Custom: Areas Covered */}
          {custom?.sections.areas ? (
            <div class="bg-slate-50 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">Areas We Cover</h3>
              <ul class="space-y-2">
                {custom.sections.areas.map((area) => (
                  <li class="flex items-start gap-2 text-sm text-slate-600">
                    <svg class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>{area}</span>
                  </li>
                ))}
              </ul>
            </div>
          ) : (
            <div class="bg-slate-50 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">Nearby Areas</h3>
              <p class="text-sm text-slate-600 mb-4">We also cover these areas near {city.name}</p>
              <div class="space-y-2">
                {cities.slice(0, 5).filter(c => c.slug !== city.slug).map((nearbyCity) => (
                  <a
                    href={`/services/${trade.slug}/${nearbyCity.slug}/`}
                    class="block text-sm text-amber-600 hover:text-amber-700 transition-colors"
                  >
                    {trade.name} in {nearbyCity.name}
                  </a>
                ))}
              </div>
            </div>
          )}

          {/* Nearby cities links (always show for internal linking) */}
          {custom && (
            <div class="bg-slate-50 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">Also Available In</h3>
              <div class="space-y-2">
                {cities.slice(0, 6).filter(c => c.slug !== city.slug).map((nearbyCity) => (
                  <a
                    href={`/services/${trade.slug}/${nearbyCity.slug}/`}
                    class="block text-sm text-amber-600 hover:text-amber-700 transition-colors"
                  >
                    {trade.name} in {nearbyCity.name}
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Related Services -->
  <section class="w-full bg-slate-50 py-16 lg:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4">
          Other Services in {city.name}
        </h2>
        <p class="text-xl text-slate-600 max-w-3xl mx-auto">
          Explore other professional services available in {city.name}
        </p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {relatedServices.map((service) => (
          <a
            href={`/services/${service.slug}/${city.slug}/`}
            class="group block p-6 rounded-xl border border-slate-200 hover:border-amber-300 hover:shadow-lg transition-all duration-300 bg-white"
          >
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-amber-500 to-amber-600 text-white flex items-center justify-center text-xl font-bold flex-shrink-0">
                {service.name.charAt(0).toUpperCase()}
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="text-lg font-semibold text-slate-900 group-hover:text-amber-600 transition-colors mb-2">
                  {service.name}
                </h4>
                <p class="text-sm text-slate-600">Available in {city.name}</p>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="w-full bg-white py-16 lg:py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4">
          {trade.name} in {city.name} — FAQs
        </h2>
      </div>
      <div class="space-y-4">
        {faqs.map((faq, index) => (
          <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden" open={index === 0}>
            <summary class="flex items-center justify-between cursor-pointer p-6 text-left font-semibold text-slate-900 hover:bg-slate-100 transition-colors">
              <span class="pr-4">{faq.question}</span>
              <svg class="w-5 h-5 text-slate-500 flex-shrink-0 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-6 pb-6 text-slate-600 leading-relaxed">{faq.answer}</div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-white py-16 lg:py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold mb-6">
        Need a {trade.name} in {city.name}?
      </h2>
      <p class="text-xl mb-8 text-amber-100">
        Connect with verified local professionals and get free quotes for your project.
      </p>
      <a
        href={`${APP_URL}/request-quote?trade=${trade.slug}&city=${city.slug}`}
        class="inline-flex items-center gap-3 px-8 py-4 rounded-full bg-white text-amber-600 font-bold text-lg transition-all duration-300 hover:bg-slate-100 hover:shadow-lg transform hover:scale-105"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
        Get Free Quotes Now
      </a>
    </div>
  </section>
</Base>
