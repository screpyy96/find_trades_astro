---
export const prerender = false;

import Base from '../../layouts/Base.astro';
import { supabase } from '../../lib/supabase';
import { getWorkerProfileUrl } from '../../utils/seo-urls';
import { CompanyProfile } from '../../components/company/CompanyProfile';
import { getPublicSupabaseConfig } from '../../lib/publicEnv';

const { slug } = Astro.params;
const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();

if (!slug) {
  return Astro.redirect('/companii', 404);
}

if (!supabase) {
  return Astro.redirect('/companii', 500);
}

// Check if it's a full UUID and redirect to SEO-friendly URL
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(slug);

if (isUuid) {
  // Fetch company data for redirect
  const { data: company, error: companyError } = await supabase
    .from('profiles')
    .select('id, name, address')
    .eq('id', slug)
    .eq('role', 'worker')
    .single();

  if (companyError || !company) {
    return Astro.redirect('/companii', 404);
  }

  // Verify it's an enterprise company (using ilike to handle whitespace issues)
  const { data: subscription } = await supabase
    .from('user_subscriptions')
    .select('plan_id')
    .eq('user_id', company.id)
    .eq('status', 'active')
    .ilike('plan_id', 'enterprise%')
    .single();

  if (!subscription) {
    return Astro.redirect('/companii', 404);
  }

  // Fetch trades for SEO URL
  const { data: companyTrades } = await supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', company.id)
    .single();

  const tradeIds = companyTrades?.trade_ids || [];
  let trades: any[] = [];
  
  if (tradeIds.length > 0) {
    const { data: tradeData } = await supabase
      .from('trades')
      .select('id, name, slug')
      .in('id', tradeIds);
    trades = tradeData || [];
  }

  const seoUrl = `/companii/${getWorkerProfileUrl(company, trades).replace('/meseriasi/', '')}`;
  return Astro.redirect(seoUrl, 301);
}

// Extract short ID from slug (last 8 characters after last hyphen)
const slugParts = slug.split('-');
const shortId = slugParts[slugParts.length - 1];

// Validate short ID (should be 8 hex characters)
const shortIdRegex = /^[0-9a-f]{8}$/i;
if (!shortIdRegex.test(shortId)) {
  return Astro.redirect('/companii', 404);
}

// Find company by matching last 8 characters of UUID
const { data: companies, error: searchError } = await supabase
  .rpc('find_worker_by_short_id', { short_id: shortId });

let companyId: string | null = null;

if (searchError || !companies || companies.length === 0) {
  // Fallback: fetch all workers and filter client-side
  const { data: allWorkers } = await supabase
    .from('profiles')
    .select('id')
    .eq('role', 'worker');
  
  if (allWorkers) {
    const matchingWorker = allWorkers.find((w: any) => w.id.endsWith(shortId));
    if (matchingWorker) {
      companyId = matchingWorker.id;
    }
  }
  
  if (!companyId) {
    return Astro.redirect('/companii', 404);
  }
} else {
  companyId = companies[0].id;
}

// Verify this is an enterprise company (using ilike to handle whitespace issues)
const { data: subscription } = await supabase
  .from('user_subscriptions')
  .select('plan_id, status')
  .eq('user_id', companyId)
  .eq('status', 'active')
  .ilike('plan_id', 'enterprise%')
  .single();

if (!subscription) {
  // Not an enterprise company, redirect to meseriasi if they have a profile
  return Astro.redirect(`/meseriasi/${slug}`, 301);
}

// Fetch all data in parallel
const [
  companyResult,
  companyTradesResult,
  portfolioResult,
  reviewsResult,
  certificationsResult
] = await Promise.all([
  supabase
    .from('profiles')
    .select('*')
    .eq('role', 'worker')
    .eq('id', companyId)
    .single(),
  
  supabase
    .from('worker_trades')
    .select('trade_ids')
    .eq('profile_id', companyId)
    .single(),
  
  supabase
    .from('portfolio_items')
    .select('*')
    .eq('profile_id', companyId)
    .order('created_at', { ascending: false }),
  
  supabase
    .from('reviews')
    .select(`
      *,
      profiles!reviews_client_id_fkey(
        id,
        name,
        avatar_url
      )
    `)
    .eq('worker_id', companyId)
    .order('created_at', { ascending: false }),
  
  supabase
    .from('certifications')
    .select('*')
    .eq('profile_id', companyId)
    .order('issue_date', { ascending: false })
]);

const { data: company, error } = companyResult;
if (error || !company) {
  return Astro.redirect('/companii', 404);
}

// Get trades data and extract unique categories
const tradeIds = companyTradesResult.data?.trade_ids || [];
let trades: any[] = [];
let categories: any[] = [];

if (tradeIds.length > 0) {
  // Convert string IDs to numbers if needed
  const numericTradeIds = tradeIds.map((id: any) => typeof id === 'string' ? parseInt(id, 10) : id).filter((id: number) => !isNaN(id));
  
  const { data: tradeData } = await supabase
    .from('trades')
    .select('*')
    .in('id', numericTradeIds);
  trades = tradeData || [];
  
  // Extract unique categories from trades
  const uniqueCategories = [...new Set(trades.map((t: any) => t.category).filter(Boolean))];
  categories = uniqueCategories.map((cat: string) => ({ id: cat, name: cat }));
}

const portfolioItems = portfolioResult.data;
const reviews = reviewsResult.data || [];
const certifications = certificationsResult.data;

// Generate SEO data - use categories for companies
const categoryNames = categories.map((cat: any) =>
  cat.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')
).join(', ');

const primaryCategory = categories[0]?.name ?
  categories[0].name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Servicii Profesionale';

const location = company.address ?
  ` din ${company.address.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ')}` : '';

const companyName = company.name ?
  company.name.split(' ').map((word: string) =>
    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
  ).join(' ') : 'Companie';

const title = `${companyName} - ${primaryCategory}${location} | Companie Verificată | Meserias Local`;
const rating = company.rating || 0;
const description = `${companyName}${location}: ${categoryNames}. ` +
  `${rating > 0 ? `★${rating.toFixed(1)} ` : ''}` +
  `Companie verificată cu echipă profesionistă. ${reviews.length} recenzii. Contactați pentru ofertă!`;

const ogImage = company.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`;
const canonicalUrl = `https://www.meseriaslocal.ro/companii/${slug}`;
const cityFromAddress = company.address ? company.address.split(',').pop()?.trim() || company.address : 'România';

// Keywords for SEO
const keywords = `${primaryCategory.toLowerCase()} ${cityFromAddress.toLowerCase()}, companie ${categoryNames.toLowerCase()}, firma ${cityFromAddress.toLowerCase()}, ${primaryCategory.toLowerCase()} preț, constructii renovari`;

// LocalBusiness schema
const localBusinessSchema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "@id": `${canonicalUrl}#business`,
  "name": companyName,
  "description": company.bio || `Companie profesionistă de ${categoryNames.toLowerCase()} în ${cityFromAddress}`,
  "url": canonicalUrl,
  "telephone": company.phone,
  "image": company.avatar_url || `https://www.meseriaslocal.ro/icon-192.png`,
  "address": {
    "@type": "PostalAddress",
    "addressLocality": cityFromAddress,
    "addressCountry": "RO"
  },
  "aggregateRating": (rating > 0 && reviews.length > 0) ? {
    "@type": "AggregateRating",
    "ratingValue": rating.toFixed(1),
    "reviewCount": reviews.length,
    "bestRating": "5",
    "worstRating": "1"
  } : undefined,
  "priceRange": "$$",
  "openingHoursSpecification": {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
    "opens": "08:00",
    "closes": "18:00"
  },
  "areaServed": {
    "@type": "City",
    "name": cityFromAddress
  },
  "serviceType": categoryNames
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Acasă",
      "item": "https://www.meseriaslocal.ro"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Companii",
      "item": "https://www.meseriaslocal.ro/companii"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": companyName,
      "item": canonicalUrl
    }
  ]
};

// Allow indexing for enterprise companies
Astro.response.headers.set('X-Robots-Tag', 'index, follow, max-image-preview:large');
---

<Base title={title} description={description} canonical={canonicalUrl} ogImage={ogImage}>
  <meta slot="head" name="keywords" content={keywords} />
  <meta slot="head" property="og:type" content="business.business" />
  
  <!-- Breadcrumb Schema -->
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  
  <!-- LocalBusiness Schema -->
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} />
  
  <CompanyProfile 
    client:idle 
    company={{
      ...company,
      trades: categories,
      portfolio_items: portfolioItems,
      reviews,
      certifications,
      subscription_plan: 'enterprise'
    }}
    supabaseUrl={supabaseUrl}
    supabaseAnonKey={supabaseAnonKey}
  />
</Base>
