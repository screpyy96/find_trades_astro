---
import Base from '../../layouts/Base.astro';
import { getPublicSupabaseConfig } from '../../lib/publicEnv';

// This page requires authentication and admin role
// Authentication is handled client-side
export const prerender = false;

const { url: supabaseUrl, anonKey: supabaseAnonKey } = getPublicSupabaseConfig();
---

<Base 
  title="Moderare Job-uri | Admin | Meserias Local"
  description="Panou de administrare pentru moderarea job-urilor"
>
  <div class="min-h-screen bg-slate-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900">Moderare Job-uri</h1>
        <p class="text-slate-600 mt-2">AprobÄƒ sau respinge job-urile postate de utilizatori</p>
      </div>

      <!-- Stats Cards -->
      <div id="stats-container" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
        <!-- Stats will be loaded here -->
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-wrap gap-4">
          <button 
            data-filter="pending" 
            class="filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-amber-100 text-amber-700"
          >
            Pending
          </button>
          <button 
            data-filter="reported" 
            class="filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-slate-100 text-slate-700 hover:bg-slate-200"
          >
            Raportate
          </button>
          <button 
            data-filter="all" 
            class="filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-slate-100 text-slate-700 hover:bg-slate-200"
          >
            Toate
          </button>
        </div>
      </div>

      <!-- Jobs List -->
      <div id="jobs-container" class="space-y-4">
        <!-- Loading state -->
        <div class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="text-slate-600 mt-4">Se Ã®ncarcÄƒ job-urile...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Rejection Modal -->
  <div id="rejection-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">Respinge Job</h3>
      <textarea
        id="rejection-reason"
        rows="4"
        class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:border-transparent"
        placeholder="Motivul respingerii (obligatoriu)..."
      ></textarea>
      <div class="flex gap-3 mt-4">
        <button
          id="confirm-reject"
          class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors"
        >
          Respinge
        </button>
        <button
          id="cancel-reject"
          class="flex-1 bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-300 transition-colors"
        >
          AnuleazÄƒ
        </button>
      </div>
    </div>
  </div>

  <script define:vars={{ supabaseUrl, supabaseAnonKey }}>
    let supabase;
    let currentFilter = 'pending';
    let pendingJobId = null;

    // Initialize Supabase
    async function initSupabase() {
      const { createClient } = await import('@supabase/supabase-js');
      supabase = createClient(supabaseUrl, supabaseAnonKey);
      
      // Check if user is admin
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = '/login?redirect=/admin/jobs';
        return;
      }
      
      // Check admin role
      const isAdmin = user.user_metadata?.role === 'admin';
      if (!isAdmin) {
        alert('Nu ai permisiuni de admin!');
        window.location.href = '/';
        return;
      }
      
      loadStats();
      loadJobs();
    }

    // Load stats
    async function loadStats() {
      try {
        const { data, error } = await supabase.rpc('get_moderation_stats');
        
        if (error) throw error;
        
        const statsContainer = document.getElementById('stats-container');
        statsContainer.innerHTML = `
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="text-sm text-slate-600">Pending</div>
            <div class="text-2xl font-bold text-amber-600">${data.pending || 0}</div>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="text-sm text-slate-600">Aprobate</div>
            <div class="text-2xl font-bold text-green-600">${data.approved || 0}</div>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="text-sm text-slate-600">Respinse</div>
            <div class="text-2xl font-bold text-red-600">${data.rejected || 0}</div>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="text-sm text-slate-600">Raportate</div>
            <div class="text-2xl font-bold text-orange-600">${data.reported || 0}</div>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="text-sm text-slate-600">Total</div>
            <div class="text-2xl font-bold text-slate-900">${data.total || 0}</div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load jobs
    async function loadJobs() {
      try {
        const { data, error } = await supabase.rpc('get_pending_jobs');
        
        if (error) throw error;
        
        let filteredJobs = data || [];
        
        // Apply filter
        if (currentFilter === 'pending') {
          filteredJobs = filteredJobs.filter(j => j.moderation_status === 'pending');
        } else if (currentFilter === 'reported') {
          filteredJobs = filteredJobs.filter(j => j.report_count > 0);
        }
        
        const container = document.getElementById('jobs-container');
        
        if (filteredJobs.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12 bg-white rounded-lg shadow-sm">
              <svg class="w-16 h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <p class="text-slate-600">Nu existÄƒ job-uri de moderat</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = filteredJobs.map(job => `
          <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 ${job.report_count > 0 ? 'border-orange-500' : 'border-amber-500'}">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-slate-900">${escapeHtml(job.title)}</h3>
                <p class="text-sm text-slate-600 mt-1">
                  Client: ${escapeHtml(job.client_email || 'N/A')}
                  ${job.report_count > 0 ? `<span class="ml-2 px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">ğŸš© ${job.report_count} raportÄƒri</span>` : ''}
                </p>
                <p class="text-sm text-slate-500 mt-1">
                  Postat: ${new Date(job.created_at).toLocaleDateString('ro-RO')}
                </p>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-medium ${
                job.moderation_status === 'pending' ? 'bg-amber-100 text-amber-700' :
                job.moderation_status === 'approved' ? 'bg-green-100 text-green-700' :
                'bg-red-100 text-red-700'
              }">
                ${job.moderation_status}
              </span>
            </div>
            
            <div class="mb-4">
              <p class="text-slate-700 whitespace-pre-wrap">${escapeHtml(job.description || 'FÄƒrÄƒ descriere')}</p>
            </div>
            
            <div class="flex gap-2 text-sm text-slate-600 mb-4">
              ${job.address ? `<span>ğŸ“ ${escapeHtml(job.address)}</span>` : ''}
              ${job.budget ? `<span class="ml-4">ğŸ’° ${escapeHtml(job.budget)}</span>` : ''}
            </div>
            
            <div class="flex gap-3">
              <button
                onclick="approveJob('${job.id}')"
                class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors"
              >
                âœ“ AprobÄƒ
              </button>
              <button
                onclick="openRejectModal('${job.id}')"
                class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors"
              >
                âœ— Respinge
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading jobs:', error);
        const container = document.getElementById('jobs-container');
        container.innerHTML = `
          <div class="text-center py-12 bg-white rounded-lg shadow-sm">
            <p class="text-red-600">Eroare la Ã®ncÄƒrcarea job-urilor: ${error.message}</p>
          </div>
        `;
      }
    }

    // Approve job
    window.approveJob = async function(jobId) {
      if (!confirm('Sigur vrei sÄƒ aprobi acest job?')) return;
      
      try {
        const { data, error } = await supabase.rpc('approve_job', { job_id: jobId });
        
        if (error) throw error;
        if (!data.success) throw new Error(data.error);
        
        alert('Job aprobat cu succes!');
        loadStats();
        loadJobs();
      } catch (error) {
        alert('Eroare: ' + error.message);
      }
    };

    // Open reject modal
    window.openRejectModal = function(jobId) {
      pendingJobId = jobId;
      document.getElementById('rejection-modal').classList.remove('hidden');
      document.getElementById('rejection-reason').value = '';
      document.getElementById('rejection-reason').focus();
    };

    // Reject job
    document.getElementById('confirm-reject')?.addEventListener('click', async () => {
      const reason = document.getElementById('rejection-reason').value.trim();
      
      if (!reason) {
        alert('Te rog sÄƒ introduci un motiv pentru respingere');
        return;
      }
      
      try {
        const { data, error } = await supabase.rpc('reject_job', { 
          job_id: pendingJobId,
          reason: reason
        });
        
        if (error) throw error;
        if (!data.success) throw new Error(data.error);
        
        alert('Job respins cu succes!');
        document.getElementById('rejection-modal').classList.add('hidden');
        pendingJobId = null;
        loadStats();
        loadJobs();
      } catch (error) {
        alert('Eroare: ' + error.message);
      }
    });

    // Cancel reject
    document.getElementById('cancel-reject')?.addEventListener('click', () => {
      document.getElementById('rejection-modal').classList.add('hidden');
      pendingJobId = null;
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        // Update active state
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.remove('bg-amber-100', 'text-amber-700');
          b.classList.add('bg-slate-100', 'text-slate-700', 'hover:bg-slate-200');
        });
        e.target.classList.remove('bg-slate-100', 'text-slate-700', 'hover:bg-slate-200');
        e.target.classList.add('bg-amber-100', 'text-amber-700');
        
        // Update filter and reload
        currentFilter = e.target.dataset.filter;
        loadJobs();
      });
    });

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on load
    initSupabase();
  </script>
</Base>
