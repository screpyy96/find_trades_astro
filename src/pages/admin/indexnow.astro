---
// Admin page for IndexNow submission
// Access: https://www.meseriaslocal.ro/admin/indexnow?key=YOUR_SECRET
export const prerender = false;

const BASE_URL = 'https://www.meseriaslocal.ro';

// Simple secret key protection - set this in your .env file
const ADMIN_SECRET = import.meta.env.ADMIN_SECRET_KEY || 'meseriaslocal2026';

// Check for secret key in URL
const url = new URL(Astro.request.url);
const providedKey = url.searchParams.get('key');

if (providedKey !== ADMIN_SECRET) {
  return new Response('Unauthorized', { status: 401 });
}
---

<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>IndexNow Admin - Meserias Local</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-8">
      <h1 class="text-3xl font-bold text-slate-900 mb-2">üöÄ IndexNow Submission</h1>
      <p class="text-slate-600 mb-8">Trimite URL-uri cƒÉtre Bing, Yandex »ôi alte motoare de cƒÉutare pentru indexare rapidƒÉ.</p>

      <!-- Quick Actions -->
      <div class="grid md:grid-cols-2 gap-4 mb-8">
        <button 
          id="submitSitemap" 
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          Trimite TOT Sitemap-ul
        </button>
        
        <button 
          id="submitServices" 
          class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
          Doar Paginile de Servicii
        </button>
      </div>

      <!-- Manual URL Input -->
      <div class="mb-8">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Sau introdu URL-uri manual (unul pe linie):
        </label>
        <textarea 
          id="manualUrls" 
          rows="5" 
          class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="/servicii/instalatii-utilitati/instalatii-sanitare/bucuresti/
/servicii/amenajari-interioare/zugraveli-vopsitorii/
/blog/ghid-renovare-apartament/"
        ></textarea>
        <button 
          id="submitManual" 
          class="mt-3 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
        >
          Trimite URL-urile Manual
        </button>
      </div>

      <!-- Status Log -->
      <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
        <h3 class="font-semibold text-slate-900 mb-3">üìã Status Log</h3>
        <div id="statusLog" class="font-mono text-sm text-slate-600 space-y-1 max-h-64 overflow-y-auto">
          <p class="text-slate-400">A»ôteaptƒÉ ac»õiune...</p>
        </div>
      </div>

      <!-- Info -->
      <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <h4 class="font-semibold text-blue-900 mb-2">‚ÑπÔ∏è Informa»õii</h4>
        <ul class="text-sm text-blue-800 space-y-1">
          <li>‚Ä¢ IndexNow notificƒÉ: <strong>Bing, Yandex, Seznam, Naver</strong></li>
          <li>‚Ä¢ Indexarea dureazƒÉ de obicei <strong>24-48 ore</strong></li>
          <li>‚Ä¢ Pentru <strong>Google</strong>, folose»ôte Search Console separat</li>
          <li>‚Ä¢ Po»õi trimite maxim <strong>10.000 URL-uri</strong> per request</li>
        </ul>
      </div>
    </div>
  </div>

  <script define:vars={{ BASE_URL }}>
    const statusLog = document.getElementById('statusLog');
    
    function log(message, type = 'info') {
      const colors = {
        info: 'text-slate-600',
        success: 'text-green-600',
        error: 'text-red-600',
        warning: 'text-amber-600'
      };
      const time = new Date().toLocaleTimeString('ro-RO');
      const p = document.createElement('p');
      p.className = colors[type] || colors.info;
      p.textContent = `[${time}] ${message}`;
      statusLog.appendChild(p);
      statusLog.scrollTop = statusLog.scrollHeight;
    }

    function clearLog() {
      statusLog.innerHTML = '';
    }

    async function fetchSitemapUrls() {
      log('üì• Se descarcƒÉ sitemap-ul...');
      const response = await fetch('/sitemap.xml');
      const xml = await response.text();
      const matches = xml.match(/<loc>(.*?)<\/loc>/g) || [];
      const urls = matches.map(m => m.replace('<loc>', '').replace('</loc>', ''));
      log(`‚úÖ GƒÉsite ${urls.length} URL-uri √Æn sitemap`, 'success');
      return urls;
    }

    async function submitUrls(urls) {
      if (urls.length === 0) {
        log('‚ö†Ô∏è Nu sunt URL-uri de trimis', 'warning');
        return;
      }

      log(`üì§ Se trimit ${urls.length} URL-uri cƒÉtre IndexNow...`);
      
      try {
        const response = await fetch('/api/indexnow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });
        
        const result = await response.json();
        
        if (result.success) {
          log(`üéâ ${urls.length} URL-uri trimise cu succes!`, 'success');
          log('üì¨ Indexarea va fi procesatƒÉ √Æn 24-48 ore', 'info');
        } else {
          log(`‚ùå Eroare: ${result.message || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Eroare de re»õea: ${error.message}`, 'error');
      }
    }

    // Submit entire sitemap
    document.getElementById('submitSitemap').addEventListener('click', async () => {
      clearLog();
      try {
        const urls = await fetchSitemapUrls();
        await submitUrls(urls);
      } catch (error) {
        log(`‚ùå Eroare: ${error.message}`, 'error');
      }
    });

    // Submit only service pages
    document.getElementById('submitServices').addEventListener('click', async () => {
      clearLog();
      try {
        const allUrls = await fetchSitemapUrls();
        const serviceUrls = allUrls.filter(url => url.includes('/servicii/'));
        log(`üîç Filtrate ${serviceUrls.length} pagini de servicii`, 'info');
        await submitUrls(serviceUrls);
      } catch (error) {
        log(`‚ùå Eroare: ${error.message}`, 'error');
      }
    });

    // Submit manual URLs
    document.getElementById('submitManual').addEventListener('click', async () => {
      clearLog();
      const textarea = document.getElementById('manualUrls');
      const lines = textarea.value.split('\n').map(l => l.trim()).filter(l => l);
      
      if (lines.length === 0) {
        log('‚ö†Ô∏è Introdu cel pu»õin un URL', 'warning');
        return;
      }

      // Convert relative URLs to absolute
      const urls = lines.map(url => {
        if (url.startsWith('http')) return url;
        return BASE_URL + (url.startsWith('/') ? url : '/' + url);
      });

      await submitUrls(urls);
    });
  </script>
</body>
</html>
